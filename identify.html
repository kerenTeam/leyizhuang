<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
	</head>
	
	<body>
		<style type="text/css">
			
			#identy{
				margin-top:55%;
			}
				
			.oauth-area {
			 
				text-align: center;
				width: 100%;
				padding: 0px;
				margin: 0px;
			}
			
			.oauth-area .oauth-btn {
				display: inline-block;
				width: 60px;
				height: 60px;
				background-size: 30px 30px;
				background-position: center center;
				background-repeat: no-repeat;
				vertical-align:middle;
				border: solid 1px #aaa;
				border-radius:50%;
			}
			
			.oauth-area .oauth-btn:active {
				border: solid 1px #aaa;
			}
			
			.oauth-area .oauth-btn.disabled {
				background-color: #ddd;
			}
			.mui-btn{
				width:90%;
				margin:20px auto;
				padding:10px; 
			}
			.custom{
				text-align:center;
				padding:20px;
				font-size:12px;
			}
		</style>
		<div id="identy">
			<button type="button" class="mui-btn mui-btn-block employee">员工登录</button>
			<div class="mui-content-padded oauth-area"></div>
			<div class="custom">顾客微信快速登录</div>
		</div>
		<script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/app.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/base64.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init();
			$('.employee').click(function(){ 
				openview({
					view:'login.html',
					id:'login'
				})
				
			})
			
			mui.plusReady(function(){
				
				
//				//判断是否登陆
//				plus.storage.removeItem('oldToken');
//				Sign();
//				var timeSign = null;
//				var loadNum = 0;
//				var loadNum2 = 0;
//				clearInterval(timeSign);
//				timeSign = setInterval(Sign,5000000);//两小时自动更新一次token
//				var timeSign2  =  setInterval(function(){
//					loadNum2++;
//					if(plus.storage.getItem('oldToken') || loadNum2==10){
//						clearInterval(timeSign2);
//					}else{
//						Sign();
//					}
//				},1000)
//				function Sign(){//登录方法 
//					if(plus.storage.getItem('oldToken')){
//						var Acc_pass = JSON.parse(plus.storage.getItem("Acc_pass"));//员工登陆
//						var openid = plus.storage.getItem("openId");//顾客登录
//						//根据缓存密码自动登录, 重新获取Token
//						if(Acc_pass){
//							mui.ajax('http://119.23.149.7:9999/app/employee/login',{
//								data:{"name":Acc_pass[0],"password":Acc_pass[1]},
//								dataType:'json',
//								type:'post',
//								timeout:10000,
//								success:function(data,type,xhr){ 
//									console.log('登录返回',data);
//									if(data.code == -1){
//									 
//									}else{  
//										plus.nativeUI.closeWaiting();
//										console.log('默认账号登录返回'+JSON.stringify(data)); 
//										plus.storage.setItem("oldToken",xhr.getResponseHeader('token'));
//										//alert(plus.storage.getItem("oldToken"))
//										openview({
//											view:'index.html',
//											id:'index'
//										})
//									}
//								},
//								error:function(xhr,type,errorThrown){
//									plus.nativeUI.closeWaiting();
//									console.log('登录响应失败');
//									loadNum ++;
//									if(loadNum<3){
//										mui.toast('当前网络不好,再次连接');
//									}
//									console.log('获取默认token响应失败');
//								}
//							}); 
//						}
//						if(openid){
//							mui.ajax('http://119.23.149.7:9999/app/customer/login',{
//								data:{"openId":openID},
//								dataType:'json',
//								type:'post',
//								timeout:10000,
//								success:function(data,type,xhr){ 
//									console.log('登录返回',data);
//									if(data.code == 0 && data.content.isExist){
//										plus.nativeUI.closeWaiting();
//										plus.storage.setItem('$userId',JSON.stringify(data.content.userId))
//										plus.storage.setItem("oldToken",xhr.getResponseHeader('token'));
//										plus.storage.setItem("openId",openID);
//		 								plus.storage.removeItem('Acc_pass');
//										
//										openview({
//											view:'index.html',
//											id:'index'
//										})
//									}else if(data.code == -1){ 
//										plus.nativeUI.closeWaiting();
//										mui.toast(data.message);
//										openview({
//											view:'reg.html',
//											id:'reg',
//											extrasobj:{openid:openID},
//										})  
//									}
//									
//								},
//								error:function(xhr,type,errorThrown){
//									plus.nativeUI.closeWaiting();
//									console.log('登录响应失败');
//								}
//								
//							});
//						} 
//					}	
//				 
//				}//登录方法结束
				
				
				
				//第三方登录
				var authBtns = ['weixin']; //配置业务支持的第三方登录
				var auths = {};
				var oauthArea = document.querySelector('.oauth-area');
				plus.oauth.getServices(function(services) {
					for (var i in services) {
						var service = services[i];
						auths[service.id] = service;
						if (~authBtns.indexOf(service.id)) {
							var isInstalled = app.isInstalled(service.id);
							var btn = document.createElement('div');
							//如果微信未安装，则为不启用状态
							btn.setAttribute('class', 'oauth-btn' + (!isInstalled && service.id === 'weixin' ? (' disabled') : ''));
							btn.authId = service.id;
							btn.style.backgroundImage = 'url("images/' + service.id + '.png")'
							oauthArea.appendChild(btn);
						}
					}
					mui(oauthArea).on('tap', '.oauth-btn', function() {
						if (this.classList.contains('disabled')) {
							plus.nativeUI.toast('您尚未安装微信客户端');
							return;
						}
						var auth = auths[this.authId];
						var waiting = plus.nativeUI.showWaiting();
						auth.login(function() {
							waiting.close();
							plus.nativeUI.toast("登录认证成功");
						 
							auth.getUserInfo(function() { 
								plus.nativeUI.toast("获取用户信息成功");
								var name = auth.userInfo.nickname || auth.userInfo.name;
								var openID = auth.userInfo.openid;
								var picUrl = auth.userInfo.headimgurl,
								nickName = auth.userInfo.nickname,
								sex = auth.userInfo.sex,
								phone,
								cityId = 1;
								console.log(openID);
								mui.ajax('http://119.23.149.7:9999/app/customer/login',{
									data:{"openId":openID},
									dataType:'json',
									type:'post',
									timeout:10000,
									success:function(data,type,xhr){ 
										console.log('登录返回',data);
										if(data.code == 0 && data.content.isExist){
											plus.nativeUI.closeWaiting();
//											plus.storage.setItem('$userId',JSON.stringify(data.content.userId))
											plus.storage.setItem('$userId','49');
//											plus.storage.setItem("$identityType",JSON.stringify({'identityType':data.content.type}));
											plus.storage.setItem("$identityType",JSON.stringify({'identityType':'6'}));
											plus.storage.setItem("oldToken",xhr.getResponseHeader('token'));
											plus.storage.setItem("openId",openID);
			 								plus.storage.removeItem('Acc_pass');
											mui.fire(plus.webview.getWebviewById('goodList'),'refresh');
											
											if(plus.webview.getWebviewById('reg')){
												plus.webview.getWebviewById('reg').close();
											}
											var time2 = setTimeout(function(){ 
												var index = plus.webview.getLaunchWebview();
												mui.fire(index,'refresh');
												plus.webview.currentWebview().close();
												plus.nativeUI.closeWaiting();
												mui.toast('登录成功');
											},500)
											
										}else if(data.code == -1){ 
											plus.nativeUI.closeWaiting();
											mui.toast(data.message) ;
											//去注册
											openview({
												view:'reg.html',
												id:'reg',
												extrasobj:{openid:openID},
											})  
//											 
										}
										
									},
									error:function(xhr,type,errorThrown){
										plus.nativeUI.closeWaiting();
										console.log('登录响应失败');
									}
									
								});
								 
							}, function(e) {
								plus.nativeUI.toast("获取用户信息失败：" + e.message);
							});
						}, function(e) {
							waiting.close();
							plus.nativeUI.toast("登录认证失败：" + e.message);
						});
					});
				}, function(e) {
					oauthArea.style.display = 'none';
					plus.nativeUI.toast("获取登录认证失败：" + e.message);
				});
			})
		</script>
	</body>

</html>