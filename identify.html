<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>登录第一页</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
	</head>

	<body>
		<style type="text/css">
			body{background-color: #fff;}
			#identy {
				margin-top: 55%;
			}
			.oauth-area {
				text-align: center;
				width: 100%;
				padding: 0px;
				margin: 0px;
				min-height: 60px;
			}
			.oauth-area .oauth-btn {
				display: inline-block;
				width: 60px;
				height: 60px;
				background-size: 60px 60px;
				background-position: center center;
				background-repeat: no-repeat;
				vertical-align: middle;
				border-radius: 50%;
			}
			.oauth-area .oauth-btn:active {
				border: solid 1px #aaa;
			}
			.oauth-area .oauth-btn.disabled {
				background-color: #ddd;
			}
			.mui-btn {
				width: 90%;
				margin: 20px auto;
				padding: 10px;
			}
			.custom {
				text-align: center;
			    padding: 15px;
			    font-size: 14px;
			    color: #666;
			}
		</style>
		<div id="identy">
			<button type="button" class="mui-btn mui-btn-block employee">员工登录</button>
			<div class="mui-content-padded oauth-area"></div>
			<div class="custom">顾客微信快速登录</div>
		</div>
		<script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/app.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/base64.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/default.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init();
			$('.employee').click(function() {
				openview({
					view: 'login.html',
					id: 'login'
				})

			})

			mui.plusReady(function() {
				if(plus.webview.getWebviewById('shezhi')) {
					plus.webview.getWebviewById('shezhi').close();
				}
				if(/android/i.test(navigator.userAgent)){
			 	 	var systemType = 'ANDROID'
				}else{
			 	 	var systemType = 'IOS'
				}
				var clientId = plus.push.getClientInfo().clientid;
				var deviceId = plus.device.uuid;
				//第三方登录
				var authBtns = ['weixin']; //配置业务支持的第三方登录
				var auths = {};
				var oauthArea = document.querySelector('.oauth-area');
				plus.oauth.getServices(function(services) {
					for(var i in services) {
						console.log(services);
						var service = services[i];
						auths[service.id] = service;
						if(~authBtns.indexOf(service.id)) {
							var isInstalled = app.isInstalled(service.id);
							var btn = document.createElement('div');
							//如果微信未安装，则为不启用状态
							btn.setAttribute('class', 'oauth-btn' + (!isInstalled && service.id === 'weixin' ? (' disabled') : ''));
							btn.authId = service.id;
							btn.style.backgroundImage = 'url("images/' + service.id + '.svg")'
							oauthArea.appendChild(btn);
						}
					}
					mui(oauthArea).on('tap', '.oauth-btn', function() {
						if(this.classList.contains('disabled')) {
							plus.nativeUI.toast('您尚未安装微信客户端');
							return;
						}
						var auth = auths[this.authId];
						var waiting = plus.nativeUI.showWaiting();
						auth.login(function() {
							waiting.close();
							auth.getUserInfo(function() {
								var name = auth.userInfo.nickname || auth.userInfo.name;
								var openID = auth.userInfo.openid;
								var picUrl = auth.userInfo.headimgurl,
									nickName = auth.userInfo.nickname,
									sex = auth.userInfo.sex;
								console.log(openID);
								mui.ajax(serverUrl + '/app/customer/login', {
									data: {
										"openId": openID,
										"deviceId":deviceId,
										"clientId":clientId,
										"systemType":systemType
									},
									dataType: 'json',
									type: 'post',
									timeout: 10000,
									success: function(data, type, xhr) {
										console.log('登录返回', data);
										if(data.code == 0 && data.content.isExist) {
											plus.nativeUI.closeWaiting();
											plus.storage.setItem('$userId',JSON.stringify(data.content.userId))
											plus.storage.setItem("$identityType", JSON.stringify({
												'identityType': '6'
											}));
											plus.storage.setItem("oldToken", xhr.getResponseHeader('token'));
											plus.storage.setItem("openId", openID);
											plus.storage.removeItem('Acc_pass');
											mui.fire(plus.webview.getWebviewById('page/goodList.html'), 'refresh');
											mui.fire(plus.webview.getWebviewById('center.html'), 'refresh');
											mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');

											var index = plus.webview.getLaunchWebview();
											mui.fire(index, 'refreshid');
											if(plus.webview.getWebviewById('reg')) {
												plus.webview.getWebviewById('reg').close();
											}
											if(plus.webview.getWebviewById('login')) {
												plus.webview.getWebviewById('reg').close();
											}
											if(plus.webview.getWebviewById('dispatching')) {
												plus.webview.getWebviewById('dispatching').close();
											}

											var time2 = setTimeout(function() {
												plus.nativeUI.closeWaiting();
												mui.toast('登录成功');
												plus.webview.currentWebview().close();
											}, 100)

										} else if(data.code == -1) {
											plus.nativeUI.closeWaiting();
											mui.toast(data.message);
											//去注册
											openview({
												view: 'reg.html',
												id: 'reg',
												extrasobj: {
													openid: openID,
													picurl: picUrl,
													sex: sex,
													nick: name
												},
											})
										}

									},
									error: function(xhr, type, errorThrown) {
										plus.nativeUI.closeWaiting();
										console.log('登录响应失败');
									}

								});

							}, function(e) {
								plus.nativeUI.toast("获取用户信息失败：" + e.message);
							});
						}, function(e) {
							waiting.close();
							plus.nativeUI.toast("登录认证失败：" + e.message);
						});
					});
				}, function(e) {
					oauthArea.style.display = 'none';
					plus.nativeUI.toast("获取登录认证失败：" + e.message);
				});
			})

			var backButtonPress = 0;
			mui.back = function(event) {
				backButtonPress++;
				if(backButtonPress > 1) {
					plus.runtime.quit();
				} else {
					plus.nativeUI.toast('再按一次退出应用');
				}
				setTimeout(function() {
					backButtonPress = 0;
				}, 1000);
				return false;
			};
		</script>
	</body>

</html>