<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>登录第一页</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
	</head>

	<body>
		<style type="text/css">
			body{position: absolute;width: 100%;height: 100%;background: url(img/regBackpng-min.png) 0 0 no-repeat;background-size: 100%;background-color: #e7e7e7;}
			/*#identy {
				margin-top: 55%;
			}*/
			.oauth-area {
				text-align: center;
				width: 100%;
				padding: 0px;
				margin: 0px;
				/*min-height: 60px;*/
				background: url(img/Spinner.svg) 20px center no-repeat;
				background-size: 50px;
			}
			.oauth-area .oauth-btn {
			    display: inline-block;
			    width: 30px;
			    height: 30px;
			    background-size: 30px 30px;
			    background-position: 30px center;
			    background-repeat: no-repeat;
			    vertical-align: middle;
			    /* border-radius: 50%; */
			    position: absolute;
			    width: 100%;
			    height: 100%;
			    left: 0;
			    top: 0;
			}
			.oauth-area .oauth-btn:active {
				border: solid 1px #aaa;
			}
			.oauth-area .oauth-btn.disabled {
				background-color: #ddd;
			}
			.mui-btn {
				width: 90%;
				margin: 20px auto;
				padding: 10px;
			}
			.custom {
				text-align: center;
			    padding: 15px;
			    font-size: 14px;
			    color: #666;
			}
			/*.employee{
				width: auto;
				padding: 6px 23px;
				font-size: 16px;
				border-radius: 25px;
				background-color: #f7f7f7;
				border-color: #e8e8e8;
				color: #777;
			}*/

			.tableDiv{display: table;width: 100%;height: 100%;}
			.tableCell{display: table-cell;vertical-align:middle;padding: 0px 10%;}
			.gukeLogin{padding: 15% 0 26%;text-align: center;background-color: rgba(255, 255, 255, 0.37);border-radius: 5px;}
			.gukeLogin p{color: #fff;font-size: 14px;margin-bottom: 10%;}
			.btnone{
		        font-size: 17px;
			    color: #fff;
			    width: 69%;
			    padding: 9px;
			    margin: 0 auto;
			    /*background-color: #a72f2e !important;*/
			    background-color: rgba(76, 175, 80, 0.72) !important;
			    border-radius: 5px;
			    position: relative;
			    padding-left: 30px;
			}
			.btnone img{
			    width: 14%;
			    vertical-align: middle;
			    margin-right: 6%;
			}
			.yuangongLogin{text-align: center;color: #fff;}
			.yuangongLogin p{color: #fff;font-size: 14px;position: relative;display: -webkit-flex;margin: 12% 0;}
			.yuangongLogin p span{display: inline-block;
			    height: 1px;
			    background-color: #fff;
			    -webkit-flex:1;
			    position: relative;
			    top: 10px;
			}
			.yuangongLogin p b{position: relative;width: 80px;font-weight: initial;}
			.btnone2{background-color: rgba(255, 255, 255, 0.37) !important;color: #fff;padding-left: 9px;}
			.btnone:active{background-color: rgba(167, 47, 46, 0.7) !important;transition: all .3s;}
			.logo11{width: 24%;margin-bottom: 10%;}

			.login2Btns{position: absolute;width: 100%;left: 0;bottom: 17%;text-align: center;}
			.login2Btns button{display: inline-block;width: 44%;margin: 3%;padding: 2.8% 0 2.5%;font-size: 16px;border: none;color: #fff;}
			.btn21{background-color: #b9afad;box-shadow: 0 0 2px rgba(175, 166, 166, 0.85);}
			.btn22{background-color: #c91018;box-shadow: 0 0 2px rgba(175, 166, 166, 0.85);}
			@media screen and (min-width:700px) and (max-width:2000px){
				body{background: url(img/regBackpng-min.png) 0 8% no-repeat;background-size: 100%;}
				.login2Btns{bottom: 12%;}
			}

		</style>

		<!--第一版-->
		<!--<div id="identy" >
			<div class="mui-content-padded oauth-area"></div>
			<div class="custom">顾客微信快速登录</div>
		</div>
		<button type="button" class="mui-btn mui-btn-block employee">员工登录</button>-->

		<!--第二版-->
		<!--<div class="tableDiv">
			<div class="tableCell">
				<div class="gukeLogin">
					<img class="logo11" src="img/logo11.png"/>
					<p>顾客微信快速登录</p>
					<div class="btnone mui-content-padded oauth-area">
						顾客登录
					</div>
				</div>
				<div class="yuangongLogin">
					<p>
						<span></span>
						<b>员工登录</b>
						<span></span>
					</p>
					<div class="btnone btnone2 employee">
						员工登录
					</div>
				</div>
			</div>
		</div>-->
		<style type="text/css">
			.backBtn001{margin: 45px 20px;width: 50px;height: 50px;background-color: #ccc;line-height: 48px;border-radius: 50%;text-align: center;font-size: 30px;color: #c91018;}

		</style>
		<div class="backBtn001" style="display: none;">
			X
		</div>
		<div class="login2Btns">
			<button class="btn21 employee"  style="margin-right: 1%;">员工登录</button>
			<button class="btn22" id="weixinLogin" style="margin-left: 1%;">微信快速登录</button>
		</div>

		<script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/app.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/base64.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/default.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/youxd.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init({
			    swipeBack:false //右滑关闭功能
			});
			$('.employee').click(function() {
				openview({
					view: 'login.html',
					id: 'login'
				})

			})

			mui.plusReady(function() {
				if(plus.storage.getItem('yaoqiudl') != 'yaoqiudl'){
					var wv=plus.webview.currentWebview();
					wv.setStyle({'popGesture':'none'});
				}else{
					mui('.backBtn001')[0].style.display = 'block';
					mui('.backBtn001')[0].onclick = function(){
						plus.webview.currentWebview().close();
					}
					$('#weixinLogin') && $('#weixinLogin').hide();
				}
				if(plus.webview.getWebviewById('shezhi')) {
					plus.webview.getWebviewById('shezhi').close();
				}
				if(/android/i.test(navigator.userAgent)){
			 	 	var systemType = 'ANDROID';
				}else{
			 	 	var systemType = 'IOS';
			 	 	//是否打开微信登录,并自动登录
		 	 		if(plus.storage.getItem('yaoqiudl') != 'yaoqiudl'){
						var time1122 = setInterval(function(){
				 	 		if(plus.storage.getItem('version')){
				 	 			clearInterval(time1122);
				 	 			hideIos(function(){
									//自动登录
									var b = new Base64();
									var str = b.encode('123456');
									plus.storage.setItem("Acc_pass",JSON.stringify(['YK001',str]));
									plus.storage.setItem("oldToken",'have');
									var index = plus.webview.getLaunchWebview();
									index.reload();
									mui.fire(index,'refreshpage');
									setTimeout(function(){plus.webview.currentWebview().close();},1000)
								},plus.storage.getItem('version'));
								plus.storage.removeItem('version');
				 	 		}
				 	 	},10)
		 	 		}
				}
				var clientId = plus.push.getClientInfo().clientid;
				clearInterval(getClientid)
				console.log('clientId '+clientId)
				if(!clientId){
					var getClientid = setInterval(function(){
						if(!clientId){
							clientId = plus.push.getClientInfo().clientid;
							console.log('clientId '+clientId)

						}else{
							clearInterval(getClientid)
						}
					},1000)
				}
				clientId = clientId || '2a6949289914e07285a00b75f0753f59';
				console.log('clientId22 '+clientId)
				plus.storage.setItem('clientId',clientId)
				var deviceId = plus.device.uuid;
				//第三方登录
				var authBtns = ['weixin']; //配置业务支持的第三方登录
				var auths = {};
				plus.oauth.getServices(function(services) {
					for(var i in services) {
						var service = services[i];
						auths[service.id] = service;
						if(~authBtns.indexOf(service.id)) {
							var isInstalled = app.isInstalled(service.id);
							var btn = document.getElementById('weixinLogin');
							btn.setAttribute('class', 'btn22' + (!isInstalled && service.id === ' weixin' ? (' disabled') : ''));
							btn.authId = service.id;
						}
					}
					mui('#weixinLogin')[0].onclick = function() {
						plus.nativeUI.showWaiting();
						if(this.classList.contains('disabled')) {
							plus.nativeUI.toast('您尚未安装微信客户端');
							return;
						}else if(!this.authId){
							mui.toast('请稍后，正在检测是否安装微信！');
						}else{
							var auth = auths[this.authId];
							var waiting = plus.nativeUI.showWaiting();
							auth.login(function() {
								waiting.close();
								auth.getUserInfo(function() {
									var name = auth.userInfo.nickname || auth.userInfo.name;
									var openID = auth.userInfo.openid;
									var picUrl = auth.userInfo.headimgurl,
										nickName = auth.userInfo.nickname,
										sex = auth.userInfo.sex;
									console.log(openID);
									mui.ajax(serverUrl + '/app/customer/login', {
										data: {
											"openId": openID,
											"deviceId":deviceId,
											"clientId":clientId,
											"systemType":systemType
										},
										dataType: 'json',
										type: 'post',
										timeout: 10000,
										success: function(data, type, xhr) {
											console.log('登录返回', data);
											if(data.code == 0 && data.content.isExist) {
												plus.nativeUI.closeWaiting();
												plus.storage.setItem('$userId',JSON.stringify(data.content.userId))
												plus.storage.setItem("$identityType", JSON.stringify({
													'identityType': '6'
												}));
												plus.storage.setItem("oldToken", xhr.getResponseHeader('token'));
												plus.storage.setItem("rankCode", data.content.rankCode);
												plus.storage.setItem("openId", openID);
												plus.storage.setItem('iosCheat','true');
												plus.storage.setItem('userCity',data.content.cityId.toString())
												plus.storage.removeItem('Acc_pass');

												mui.fire(plus.webview.getWebviewById('page/goodList.html'), 'refresh');
												mui.fire(plus.webview.getWebviewById('center.html'), 'refresh');
												plus.webview.getWebviewById('center.html').reload()
												mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
												plus.webview.getWebviewById('cart.html').reload()
												var index = plus.webview.getLaunchWebview();
												index.reload()
												mui.fire(index, 'refreshpage');
												if(plus.webview.getWebviewById('reg')) {
													plus.webview.getWebviewById('reg').close();
												}
												if(plus.webview.getWebviewById('login')) {
													plus.webview.getWebviewById('login').close();
												}
												if(plus.webview.getWebviewById('dispatching')) {
													plus.webview.getWebviewById('dispatching').close();
												}

												var time2 = setTimeout(function() {
													plus.nativeUI.closeWaiting();
													mui.toast('登录成功');
													plus.webview.currentWebview().close();
												}, 100)

											} else if(data.code == -1) {
												plus.nativeUI.closeWaiting();
												mui.toast(data.message);
												//去注册
												openview({
													view: 'reg.html',
													id: 'reg',
													extrasobj: {
														openid: openID,
														picurl: picUrl,
														sex: sex,
														nick: name
													},
												})
											}

										},
										error: function(xhr, type, errorThrown) {
											plus.nativeUI.closeWaiting();
											console.log('登录响应失败');
										}

									});

								}, function(e) {
									plus.nativeUI.toast("获取用户信息失败：" + e.message);
								});
							}, function(e) {
								waiting.close();
								plus.nativeUI.toast("登录认证失败：" + e.message);
							});
							waiting.close();
						}
					};
				}, function(e) {
					waiting.close();
					plus.nativeUI.toast("获取登录认证失败：" + e.message);
				});
			})

			var backButtonPress = 0;
			mui.back = function(event) {
				backButtonPress++;
				if(backButtonPress > 1) {
					plus.runtime.quit();
				} else {
					plus.nativeUI.toast('再按一次退出应用');
				}
				setTimeout(function() {
					backButtonPress = 0;
				}, 1000);
				return false;
			};
		</script>
	</body>

</html>