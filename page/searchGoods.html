<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>搜索</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<script type="text/javascript" src="../js/jquery.min.js"></script>
		<script src="../js/mui.min.js"></script>
		<link rel="stylesheet" href="../css/style.css" />
		<!--引入模板引擎-->
		<script src="../js/artTemplate-native.js"></script>
	</head>
	<style type="text/css">
		header {
			height: 50px!important;
		}
		
		.searchFind {
			position: relative;
		}
		
		.sint {
			right: 0;
			top: 5px;
			left: 0;
			position: absolute;
			display: flex;
			align-items: center;
		}
		
		.sint .back {
			font-size: 14px;
			color: #F53C42;
			flex-basis: 40px;
			margin-left: 10px;
			text-align: center;
		}
		
		.fsearch {
			border-radius: 20px!important;
			background-color: #f9f9f9!important;
			border: 1px solid #dfdfdf!important;
			font-size: 12px!important;
			padding-left: 30px!important;
		}
		
		.fsearch::-webkit-input-placeholder {
			color: gray!important;
			text-align: left;
			font-size: 12px;
		}
		
		.mui-icon-search {
			position: absolute;
			left: 5px;
			top: 3px;
			color: gray;
		}
		
		form {
			width: 100%;
		}
		
		#tab {
			display: none;
		}
		
		.history {
			position: relative;
			top: 50px;
			padding: 15px;
			background-color: white;
		}
		
		.history span {
			font-size: 12px;
			vertical-align: middle;
		}
		
		.history img {
			float: right;
			width: 20px;
		}
		
		.hisList {
			margin-top: 15px;
		}
		
		.hisList span {
			display: inline-block;
			padding: 5px 10px;
			background: rgba(0, 0, 0, .1);
			margin: 5px;
			border-radius: 3px;
			color: gray;
		}
	</style>

	<body>
		<header class="mui-bar mui-bar-nav" style="background-color: white;">
			<div class="searchFind">
				<span class="mui-icon mui-icon-search" onclick="submitTest();"></span>
				<div class="sint">
					<form onsubmit="submitTest();return false;" id="searchf">
						<!--onsubmit="submitTest();return false;" -->
						<input type="search" class="fsearch" placeholder="输入关键字">
					</form>
					<span class="mui-action-back back">取消</span>
				</div>

			</div>
		</header>
		<script src="../js/statusBar.js" type="text/javascript" charset="utf-8"></script>
		<div id="record">暂无搜索记录</div>
		<script id="recordTpt" type="text/html">
			<%if(data.length==0){%>
			<div class="searchRecord">
				&nbsp;&nbsp;搜索记录:无
			</div>
			<%}else{%>
			<div class="history latest">
				<span>最近搜索</span> <img src="../images/delet.svg" class="clearStr" alt="" />
				<div class="clear"></div>
				<div class="hisList">
					<%for(var i=data.length-1;i>=0;i--){%>
					<span><%=data[i]%></span>
					<%}%>
				</div>
			</div>

			<%}%>
		</script>

		<!--tab-->
		<div id="tab">
			<div class="goodsList" id="searchOut" style="margin-top: 50px;"></div>

			<script type="text/html" id="searchOutTpl">
				<ul class="mui-table-view">
					<%for(var i = 0 ;i<list.length;i++){%>
					<li class="mui-table-view-cell mui-media" id="<%=list[i].id%>" onclick="goodsInfo(<%=list[i].id%>)">
						<a href="javascript:;">
							<img class="mui-media-object mui-pull-left" src="<%=list[i].coverImageUri%>">
							<div class="mui-media-body">
								<%=list[i].goodsName%>
								<p class='mui-ellipsis'>规格:
									<%=list[i].goodsSpecification%> &nbsp;单位:
									<%=list[i].goodsUnit%>
								</p>
								<span>￥<%=list[i].retailPrice%></span>
								<img style="display:inline-block;float:right;margin-left:5px;vertical-align:middle" data-id="<%=list[i].id%>" class="toCart" src="../images/addcart.svg" />
								<div style="display:none;float:right;" class="mui-numbox" data-numbox-step='1' data-numbox-min='0'>
									<button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
									<input class="mui-numbox-input" data-id="<%=list[i].id%>" value="1" type="number" />
									<button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
								</div>
							</div>
						</a>
					</li>
					<%}%>

				</ul>
			</script>
		</div>

	</body>
	<script src="../js/default.js" type="text/javascript" charset="utf-8"></script>
	<script type="text/javascript">
		function goodsInfo(id){
			openview({
				view:'goodsInfo.html',
				id: 'goodsInfo', 
				extrasobj:{goodId:id}
			}) 
			
		}
		mui.plusReady(function() {
			//缓存记录
			var searchCircleStorage = JSON.parse(plus.storage.getItem("$searchCircleStorage") || '[]');
			//缓存记录 渲染
			var recordObj = {};
			recordObj.data = searchCircleStorage;
			if(searchCircleStorage.length) {
				var htmlrecord = template('recordTpt', recordObj);
				document.getElementById('record').innerHTML = htmlrecord;
			}

			//清除记录
			$('.clearStr').click(function() {
				plus.storage.removeItem("$searchCircleStorage");
				$('.latest').css("display", "none");
				document.getElementById('record').innerHTML = "暂无搜索记录";
			})
			//搜索某一条 缓存 
			$('.hisList span').click(function(e) {
				e.preventDefault();
				$("#container").css("display", "none");
				$(".searchOut").css("display", "block");
				$("input").val($(this).text());
				doSearch($.trim($(this).text()))
			})

			//搜索方法
			$("input").focus(function() {
				$(".latest").css("display", "block");
				$("#tab").css("display", "none");
			})
			window.submitTest = function() {
				var searchCircleStorage = JSON.parse(plus.storage.getItem("$searchCircleStorage") || '[]');
				if($("input").val() != '') {
					var words = $("input").val();
					if(searchCircleStorage.length != 0) {
						var flag = false;
						for(var i = 0; i < searchCircleStorage.length; i++) {
							if(searchCircleStorage[i] == words) {
								searchCircleStorage[i] = words;
								flag = false;
								break;
							} else {
								flag = true;
							}
						}
						if(flag) {
							searchCircleStorage.push(words);
						}
					} else {
						searchCircleStorage.push(words);
					}
					plus.storage.setItem('$searchCircleStorage', JSON.stringify(searchCircleStorage));
					$(".latest").css("display", "none");
					$("#tab").css("display", "block");
					//执行搜索
					doSearch(words);
				} else {
					mui.toast("请输入搜索内容！");
					$(".latest").css("display", "block");
					$("#tab").css("display", "none");
				}
			}
			var userId = plus.storage.getItem('$userId');
			var oldToken = plus.storage.getItem("oldToken");
			var identityT = JSON.parse(plus.storage.getItem("$identityType")).identityType;

			function doSearch(words) {
				$(".history").css("display", "none");
				$("#tab").css("display", "block");
				$("input").blur();
				plus.nativeUI.showWaiting();
				//商品列表
				mui.ajax(serverUrl + '/app/goods/search', {
					data: {
						identityType: identityT,
						keywords: words,
						userId: userId
					},
					dataType: 'json',
					headers: {
						"Authorization": oldToken
					},
					type: 'post',
					timeout: 10000,
					success: function(data, type, xhr) {
						console.log('搜索商品列表' + JSON.stringify(data));
						if(data.code == 0) {
							plus.nativeUI.closeWaiting();
							if(data.content) {
								if(data.content.length) {
									$('#searchOut').html(template('searchOutTpl', {
										list: data.content
									}));
									mui('.mui-numbox').numbox()
									$('.toCart,.mui-numbox button,.mui-numbox input').click(function() {
										event.stopPropagation()
									})
									
									//加入购物车
									$('.toCart').click(function(){
										var goodid = $(this).attr('data-id');
										var cur = $(this);
										plus.nativeUI.showWaiting();
										addCart(goodid,1,cur);
									})
									
									//数量选择 -> 加入购物车
									$('.mui-numbox input').on('change', function() {
										plus.nativeUI.showWaiting();
										var cur = $(this);
										var number = $(this).val(); //当前数量
										var goodsid = $(this).attr("data-id"); //当前商品id
										if(number>0){
											var goodsList = [{'id':goodsid,'qty':number}];
											mui.ajax(serverUrl + '/app/materialList/edit/batch', {
												data: {
													userId: userId,
													identityType: identityT,
													goodsList: JSON.stringify(goodsList),
												},
												dataType: 'json',
												headers: {
													"Authorization": oldToken
												},
												type: 'post',
												timeout: 10000,
												success: function(data, type, xhr) {
													plus.nativeUI.closeWaiting();
													console.log('加入购物车', data);
													if(data.code == 0) {
														plus.nativeUI.toast('加入成功')			
														mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
													} else {
														mui.toast(data.message)
													}
			
												},
												error: function(xhr, type, errorThrown) {
													plus.nativeUI.closeWaiting();
													console.log('登录响应失败');
												}
											});
										}else{
											mui.confirm('狠心不要了咩？', '提示', ['取消', '确定'], function(e) {
												if(e.index == 1) {
													mui.ajax(serverUrl + '/app/materialList/goods/delete', {
														data: {
															userId: userId,
															identityType: identityT,
															goodsIdArray: goodsid,
														},
														dataType: 'json',
														headers: {
															"Authorization": oldToken
														},
														type: 'post',
														timeout: 10000,
														success: function(data, type, xhr) {
															plus.nativeUI.closeWaiting();
															console.log('删除', data);
															if(data.code == 0) {
																mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
															} else {
																mui.toast(data.message)
															}
			
														},
														error: function(xhr, type, errorThrown) {
															plus.nativeUI.closeWaiting();
														}
													});
												}else{
													plus.nativeUI.closeWaiting();
													cur.val(1);	
													cur.siblings().removeAttr('disabled'); 
												}
			
											})
										}
										
									})
									
									function addCart(goodid,num,cur){
										mui.ajax(serverUrl+'/app/materialList/add',{
											data:{
												userId:userId,
												identityType:identityT,
												params:goodid+'-'+num
											},
											dataType:'json',
											headers: {"Authorization": oldToken},
											type:'post',
											timeout:10000,
											success:function(data,type,xhr){ 
												plus.nativeUI.closeWaiting();
												console.log('加入购物车',data);
												if(data.code == 0 ){
													plus.nativeUI.toast('加入成功')							
													mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
													hadCart(goodid,cur);
												}else{
													mui.toast(data.message)
												}
												 
											},
											error:function(xhr,type,errorThrown){
												plus.nativeUI.closeWaiting();
												console.log('登录响应失败');
											}
										});
									}
									
									function hadCart(goodid,cur){
										//获取已有购物车数量
										mui.ajax(serverUrl + '/app/materialList/goods/qty', {
											data: {
												userId: userId,
												identityType: identityT,
												goodsId: goodid,
											},
											dataType: 'json',
											headers: {
												"Authorization": oldToken
											},
											type: 'post',
											timeout: 10000,
											success: function(data, type, xhr) {
												plus.nativeUI.closeWaiting();
												console.log('已有购物车数量', data);
												if(data.code == 0) {
													cur.next().show();
													cur.hide();
													if(data.content && data.content.qty){
														cur.next().find('input').val(data.content.qty)
													}
												} else {
													mui.toast(data.message)
												}
		
											},
											error: function(xhr, type, errorThrown) {
												plus.nativeUI.closeWaiting();
												console.log('登录响应失败');
											}
										});
									}
								} else {
									$('#searchOut').html('<div style="text-align:center;padding:15px;font-size: 12px;">暂无商品</div>')
								}
							} else {
								$('#searchOut').html('<div style="text-align:center;padding:15px;font-size: 12px;">暂无商品</div>')
							}

						} else {
							mui.toast(data.message)
						}

					},
					error: function(xhr, type, errorThrown) {
						plus.nativeUI.closeWaiting();
						mui.toast(type)
						console.log('登录响应失败');
					}
				});

			}

		})
	</script>

</html>