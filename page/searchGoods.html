<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>搜索</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../css/mui.min.css" />
		<script type="text/javascript" src="../js/jquery.min.js"></script>  
		<script src="../js/mui.min.js"></script> 
		<!--引入模板引擎-->
		<script src="../js/artTemplate-native.js"></script>
	</head>
	<style type="text/css">
		header{
			 height: 50px!important;
		} 
		.searchFind{
			position: relative;
		}
		.sint{
			right: 0;
			top: 5px;
			left: 0;
			position: absolute;
			display: flex;
			align-items: center;
		}
		.sint .back{
			font-size: 14px;
			color: #F53C42;
			flex-basis: 40px;
			margin-left: 10px; 
			text-align: center;
		}
		.fsearch{
			border-radius: 20px!important;
		    background-color: #f9f9f9!important;
		    border: 1px solid #dfdfdf!important;
			font-size: 12px!important;
			padding-left: 30px!important;
		}
		.fsearch::-webkit-input-placeholder{
			color: gray!important;
			text-align: left;
			font-size: 12px;
		}
		.mui-icon-search{
			position: absolute;
			left: 5px;
			top: 3px;
			color: gray;
		}
		form{
			width: 100%;
		}
		.tabPs{
			border-bottom: 1px solid #EEEEEE;
			position: fixed;
			top: 50px;
			left: 0;
			right: 0;
			height: -webkit-calc(31px + 13px);
			height: -moz-calc(31px + 13px);
			height: calc(31px + 13px);
			z-index: 99;
		}
		.tab{
			/*padding: 0 15px;*/
			background: white;
			font-size: 0px;
			/*display: flex;
			justify-content: space-around;*/
		}
	  
		.tab div { 
			padding: 15px 0; 
			font-size: 13px;
			display: inline-block;
			width: 50%;
			text-align: center; 
		} 
		.tabActive {  
			color: #F53C42;
			/*border-bottom: 2px solid #F53C42;*/
		}
		.border{
			position: absolute;
			z-index: 99;
			bottom: 0;
			left: 0;
			height: 2px;
			background-color: #F53C42;
			-webkit-transition: all 0.5s ease;
		}
		.tabcontent {
			position: relative;
			top: 0;
			display: none;
		}
		.taactive{
			display: block;
		}
		.cAvator{
			width: 0.4rem;  
				height: 0.4rem;   
				margin-right: 10px;
		}
		   .userAvator{  
				width: 0.4rem;  
				height: 0.4rem;  
				border-radius: 50%;
				margin-right: 10px;
			}
			  .follow{
			 	top: 50px;
				position: relative;
				background-color: white; 
				padding:15px 15px; 
				line-height: 1.5;
			} 
			 .follow:after{
			 	position: absolute;
			 	content: '';
			 	height: 1px;
			 	left: 10px;
			 	right: 10px;
				-webkit-transform: scaleY(.05);
				/*-webkit-transform-origin: 0 bottom;
				transform-origin: 0 bottom;*/
				background: #000;
				bottom: 0;
			 }
			 
			.fchidl span{ 
				overflow: hidden;
				text-overflow: ellipsis;
			}
			.fchidl>div{
				color: darkgray;
			}
			
			#tab{
				display: none;
			}
			.history{
				position: relative;
				top: 50px; 
				padding: 15px;
				background-color: white;
			} 
			.history span{
				font-size: 12px;
				vertical-align: middle;
			}
			.history img{
				float: right;
				width: 20px;
			}
			.hisList{
				margin-top: 15px;
			}
			.hisList span{
				display: inline-block;
				padding: 5px 10px;
				background: rgba(0, 0, 0, .1);
				margin: 5px;
				border-radius: 3px;
				color: gray;
			}
	</style>
	<body>
		<header class="mui-bar mui-bar-nav" style="background-color: white;">
			<div class="searchFind">
				<span class="mui-icon mui-icon-search" onclick="submitTest();"></span>
				<div class="sint">
					<form onsubmit="submitTest();return false;" id="searchf"><!--onsubmit="submitTest();return false;" -->
						<input type="search" class="fsearch" placeholder="输入关键字">
					</form>
					<span class="mui-action-back back">取消</span>
				</div>
				
			</div>  
		</header>
		
		<div id="record">暂无搜索记录</div>
		<script id="recordTpt" type="text/html">
			<%if(data.length==0){%>
				<div class="searchRecord">
					&nbsp;&nbsp;搜索记录:无
				</div> 
			<%}else{%>
				<div class="history latest">
					  <span>最近搜索</span> <img src="../images/delet.svg" class="clearStr"  alt="" />
					  <div class="clear"></div>
					  <div class="hisList">
					  	<%for(var i=data.length-1;i>=0;i--){%>
						  	<span><%=data[i]%></span>
						 <%}%>
					  </div>
				</div>
				 
				<%}%> 
		</script> 
	
		<!--tab-->
		<div id="tab">
			 
			
			<div id="searchOut" style="margin-top: 50px;"></div>
			
			<script type="text/html" id="searchOutTpl">
				<div class="tabcontent tc1 taactive"> 
					<%for(var i = 0 ;i<list.length;i++){%>
			    		<li class="mui-table-view-cell mui-media" id="<%=list[i].id%>">
					        <a href="javascript:;">
					            <img class="mui-media-object mui-pull-left" src="<%=list[i].coverImageUri%>">
					            <div class="mui-media-body">
					                <%=list[i].goodsName%>
					                <p class='mui-ellipsis'>规格:<%=list[i].goodsSpecification%> &nbsp;单位:<%=list[i].goodsUnit%></p>
						            <span>￥<%=list[i].memberPrice%></span>
									<img style="display:inline-block;float:right;margin-left:5px;vertical-align:middle" src="../images/addcart.svg"/>
						            <div style="display:inline-block;float:right;" class="mui-numbox" data-numbox-step='1' data-numbox-min='0' data-numbox-max='100'>
									  <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
									  <input class="mui-numbox-input" type="number" />
									  <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
									</div>
					            </div>
					        </a>
					    </li>
		    		<%}%> 
		    		
				</div> 
			</script>
			</div>
		
	</body>
	<script type="text/javascript">
		mui.plusReady(function(){
			//自动弹出输入法
		  	var nativeWebview, imm, InputMethodManager;
			var initNativeObjects = function() {
			    if (mui.os.android) {
			        var main = plus.android.runtimeMainActivity();
			        var Context = plus.android.importClass("android.content.Context");
			        InputMethodManager = plus.android.importClass("android.view.inputmethod.InputMethodManager");
			        imm = main.getSystemService(Context.INPUT_METHOD_SERVICE);
			    } else {
			        nativeWebview = plus.webview.currentWebview().nativeInstanceObject();
			    }
			};
			var showSoftInput = function() {
			    if (mui.os.android) {
			        imm.toggleSoftInput(0, InputMethodManager.SHOW_FORCED);
			    } else {
			        nativeWebview.plusCallMethod({
			            "setKeyboardDisplayRequiresUserAction": false
			        });
			    }
		        //此处可写具体逻辑设置获取焦点的input
		        setTimeout(function() {
			       var inputElem = document.getElementsByClassName('fsearch')[0];
	               inputElem.focus(); 
	            }, 0); 
			};
	    	initNativeObjects();
	    	showSoftInput();
	    	
	    	//缓存记录
			var searchCircleStorage =JSON.parse(plus.storage.getItem("$searchCircleStorage") || '[]');
			var myuserid = plus.storage.getItem('userid');
			//缓存记录 渲染
			var recordObj = {};
			recordObj.data= searchCircleStorage;
			if(searchCircleStorage.length){
				var htmlrecord = template('recordTpt', recordObj); 
				document.getElementById('record').innerHTML = htmlrecord;
			} 
		   
		    //清除记录
		    $('.clearStr').click(function(){
			 	plus.storage.removeItem("$searchCircleStorage");
			 	$('.latest').css("display","none"); 
			 	 document.getElementById('record').innerHTML = "暂无搜索记录";
			})
			//搜索某一条 缓存 
			$('.hisList span').click(function(e){
			    e.preventDefault(); 
			    $("#container").css("display","none");
				$(".searchOut").css("display","block"); 
			   $("input").val($(this).text());
			    doSearch($.trim($(this).text()))
			})
			 
			
	    	//搜索方法
	    	$("input").focus(function(){
	    		$(".latest").css("display","block");
				$("#tab").css("display","none");
	    	})
			window.submitTest = function(){
				var searchCircleStorage =JSON.parse(plus.storage.getItem("$searchCircleStorage") || '[]');
				if($("input").val()!=''){ 
					var words=$("input").val();
					if(searchCircleStorage.length != 0) {
						var flag = false;
						for(var i = 0; i < searchCircleStorage.length; i++) {
							if(searchCircleStorage[i] == words) {
								searchCircleStorage[i] = words;
								flag = false;
								break;
							} else {
								flag = true;
							}
						}
						if(flag) {
							searchCircleStorage.push(words);
						}
					}else{ 
						searchCircleStorage.push(words);
						
					} 
					plus.storage.setItem('$searchCircleStorage', JSON.stringify(searchCircleStorage)); 
					$(".latest").css("display","none");
					$("#tab").css("display","block"); 
					//执行搜索
					doSearch(words);
				}else{
					mui.toast("请输入搜索问题！");
					$(".latest").css("display","block");
					$("#tab").css("display","none");
				} 
			}
//			var userId = plus.storage.getItem('$userId'); 
			var userId = 49; 
			function doSearch(words){
				$(".history").css("display","none");
				$("#tab").css("display","block"); 
				$("input").blur(); 
					plus.nativeUI.showWaiting();
				 	//商品列表
					mui.ajax('http://119.23.149.7:9999/app/goods/search',{
						data:{
//							categoryCode:categoryCode,
							keywords:words,
     						userId:userId
						},
						dataType:'json',
						headers: {"Authorization": plus.storage.getItem("oldToken")},
						type:'post',
						timeout:10000,
						success:function(data,type,xhr){ 
							console.log('搜索商品列表'+JSON.stringify(data));
							if(data.code == 0 ){
								plus.nativeUI.closeWaiting();
								if(data.content){
									if(data.content.length){
										$('#searchOut').html(template('searchOutTpl',{list:data.content}));
									 
									}else{
										$('#searchOut').html('<div style="text-align:center;padding:15px;font-size: 12px;">暂无商品</div>') 
									}
								}else{
									$('#searchOut').html('<div style="text-align:center;padding:15px;font-size: 12px;">暂无商品</div>') 
								}
								
							}else{
								mui.toast(data.message)
							}
							 
						},
						error:function(xhr,type,errorThrown){
							plus.nativeUI.closeWaiting();
							mui.toast(type)
							console.log('登录响应失败');
						}
					}); 
					
			}
 
			  
})
	</script>
</html>
