<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../../css/commonY.css" />
		<link rel="stylesheet" type="text/css" href="../../css/configW.css" />
	</head>
	<style type="text/css">
		.categray div {
			width: 80%;
			vertical-align: top;
		}
		
		.mui-numbox {
			background: none!important;
		}
		/*搜索*/
		
		.searchFind {
			position: relative;
		}
		
		.sint {
			right: 0;
			top: 2px;
			left: 0;
			position: absolute;
			display: flex;
			display: -webkit-flex;
			align-items: center;
		}
		
		.sint .back {
			font-size: 15px;
			color: #c7161e;
			flex-basis: 40px;
			margin-left: 0px;
			text-align: center;
			margin-right: 12px;
		}
		
		.fsearch {
			border-radius: 20px!important;
			background-color: #f9f9f9!important;
			border: 1px solid #dfdfdf!important;
			font-size: 15px!important;
			padding-left: 30px!important;
		}
		
		.fsearch::-webkit-input-placeholder {
			color: gray!important;
			text-align: left;
			font-size: 12px;
		}
		
		.mui-icon-search {
			position: absolute;
			top: 3px;
			color: gray;
			z-index: 200;
		}
		
		form {
			width: 100%;
			padding: 0 8px 0 27px;
		}
		
		.mui-icon-search2 {
			top: -2px;
			left: -13px;
			font-size: 24px!important;
		}
		
		input.fsearch::-webkit-input-placeholder {
			color: #999;
			opacity: 1;
			font-size: 15px;
		}
		
		#tabLink2 {
			height: 50px;
			position: relative;
			top: 3px;
		}
		
		#valInt::-webkit-input-placeholder {
			font-size: 12px;
		}
		/*分类*/
		
		.categray div {
			width: calc(100vw - 85px);
			width: -webkit-calc(100vw - 85px);
			width: -moz-calc(100vw - 85px);
			vertical-align: top;
		}
		
		.sedc span {
			margin-bottom: 10px;
			font-size: 16px;
			padding: 0 4px;
			border-radius: 3px;
		}
		
		.flexw div {
			position: relative;
			align-items: center;
			padding: 15px 0 10px;
		}
		
		.flexw div:not(:last-child):after {
			position: absolute;
			content: '';
			position: absolute;
			width: 1px;
			height: 30px;
			background: #DDD8CD;
			-webkit-transform: scaleX(.3);
			right: 0px;
			top: 12px;
			z-index: 999;
		}
		
		.afterBorder:after {
			bottom: -1px;
		}
		
		.mui-badge-danger {
			padding: 5px 10px;
			font-size: 14px;
			border-radius: 3px;
			background-color: #DDDDDD;
			color: gray;
		}
		
		.actBadge {
			background-color: #B42E28;
			color: white;
		}
		
		.filter>div {
			margin: 10px 0;
		}
		
		.actspan {
			color: #B42E28;
		}
	</style>

	<body style="padding-bottom: 0px;">
		<header class="mui-bar mui-bar-nav" style="padding-right: 15px;">
			<a id="leftbtn" class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<!--<h1 class="mui-title"></h1>-->
			<div class="tab-hd tab-hdtwo" id="tabLink2">
				<div class="searchFind">
					<span class="mui-icon mui-icon-search mui-icon-search2" id="clickSearch"></span>
					<div class="sint">
						<form id="searchf">
							<input type="search" id="valInt" class="fsearch" placeholder="请输入商品关键字">
						</form>
						<span class="back" id="cancelSearch">确认</span>
					</div>
				</div>
			</div>
		</header>
		<script src="../../js/statusBar.js" type="text/javascript" charset="utf-8"></script>
		<!--<div class="gocarticon" id="div2">
			<img src="../../images/whitecart.svg" alt="" />
			<span class="mui-badge mui-badge-white">0</span>
		</div>-->
		<div class="mui-content" style="margin-top: 7px;">
			<!--一级分类-->
			<div class="mui-content flexw afterBorder" style="position: fixed;top: 75px;z-index: 99;left: 0;right: 0;height: 51px;">
				<div class="water curActive" data-id="water">水</div>
				<div class="electric" data-id="electric">电</div>
				<div class="wood" data-id="wood">木</div>
				<div class="tile" data-id="tile">瓦</div>
				<div class="oil" data-id="oil">油</div>
			</div>
			<!--小分类-->
			<div class="filter" style="background-color:white;padding:6px;font-size:14px;margin-top: 52px;">
				<div class="categray categray2">
					<span class="mui-badge mui-badge-danger ftb actBadge" data-id='' data-name='brand'>品牌</span>
					<div class="sedc categrayb"></div>
				</div>
			</div>

			<div class="gocarticon" id="div2" style="display: none;">
				<img src="../images/whitecart.svg" alt="" />
				<span class="mui-badge mui-badge-white">0</span>
			</div>
			<!--商品列表-->
			<div class="goodsList" id="goodsList"></div>

			<script type="text/html" id="goodsTpl">
				<ul class="mui-table-view">
					<%for(var i = 0 ;i<list.length;i++){%>
					<li class="mui-table-view-cell mui-media" id="<%=list[i].id%>" onclick="goodsInfo(<%=list[i].id%>)">
						<a href="javascript:;">
							<img class="mui-media-object mui-pull-left" src="<%=list[i].coverImageUri || '../../img/editset.png'%>">
							<div class="mui-media-body ft16">
								<div style="word-break: break-all;white-space: normal;">
									<%=list[i].goodsName%>
								</div>
								<p class='mui-ellipsis ft16'>规格:
									<%=list[i].goodsSpecification%> &nbsp;单位:
									<%=list[i].goodsUnit%>
								</p>
								<p class='titcl ft14' style="word-break: break-all;white-space: normal;">
									<%if(list[i].workArea){%> 施工面积
									<%=list[i].workArea%>/平米 &nbsp;<br />
									<%}%>
									<%if(list[i].workCost){%> 施工成本
									<%=list[i].workCost%>元/平米
									<%}%>

								</p>
								<span class="activecl2 ft18">¥<%=list[i].retailPrice%></span>

							</div>
						</a>
					</li>
					<%}%>
				</ul>
			</script>
		</div>

		<div class="upload text-center text-xs gray" id="upload"></div>
		<script src="../../js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/default.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init();

			mui.plusReady(function() {

				var categoryCode = '',
					keywords = '';
				var brandId = ''
				if(!categoryCode) {
					categoryCode = 'water';
				}
				if(categoryCode) {
					$('.flexw div').siblings().removeClass('curActive');
					$('.' + categoryCode).addClass('curActive');
				}
				document.addEventListener('refresh', function() {
					$('.flexw div').removeClass('curActive')
					$('.flexw div').eq(0).addClass('curActive');
					kindType('water', keywords);
				})
				var rankCode = plus.webview.currentWebview().rankCode;
				var identityT = JSON.parse(plus.storage.getItem("$identityType")).identityType;
				var userId = plus.storage.getItem('$userId');
				var oldToken = plus.storage.getItem('oldToken');
				window.goodsInfo = function(id) {
					openview({
						view: 'goodsInfo2.html',
						id: 'goodsInfo2',
						extrasobj: {
							goodId: id,
							rankCode: rankCode
						}
					})

				}
				//				mui('.mui-title')[0].innerHTML = plus.webview.currentWebview().rankName

				plus.nativeUI.showWaiting();
				document.addEventListener('refresh', function() {
					kindType(categoryCode, keywords);
				})

				function kindTyperf() {
					$('.categray span').removeClass('actBadge')
					$('.categray>span:first-child').addClass('actBadge');
					kindType($('.curActive').attr('data-id'), keywords);
				}
				kindType(categoryCode, keywords);

				function kindType(categoryCode, keywords) {

					//一级分类切换
					$('.flexw div').unbind('click').click(function() {
						keywords = ''
						brandId = ''
						$('#valInt').val('')
						$(this).siblings().removeClass('curActive')
						$(this).addClass('curActive');
						$('.categray>span').addClass('mui-badge mui-badge-danger actBadge')
						categoryCode = $(this).attr('data-id')
						kindType($(this).attr('data-id'), keywords);
					})
					document.getElementById('upload').innerHTML = '';
					$(window).unbind('scroll');
					document.body.scrollTop = document.documentElement.scrollTop = 0;
					//品牌
					getGoodsBrand()

					function getGoodsBrand() {
						mui.ajax(serverUrl + '/app/goods/rank/brand/list', {
							data: {
								categoryCode: categoryCode,
								userId: userId,
								identityType: identityT,
								rankCode: rankCode
							},
							dataType: 'json',
							headers: {
								"Authorization": oldToken
							},
							type: 'post',
							timeout: 10000,
							success: function(data, type, xhr) {
								console.log('品牌列表', data);
								if(data.code == 0) {
									plus.nativeUI.closeWaiting();
									if(data.content && data.content.length) {
										var html = '';
										for(var i = 0; i < data.content.length; i++) {
											if(data.content[i] && data.content[i].brandId) {
												//												if(goodsBrand == data.content[i].brandName){
												//													html += '<span class="actBadge" data-name = "brand" data-id="'+data.content[i].brandId+'">'+data.content[i].brandName+'</span>';
												//												}else{
												html += '<span data-name = "brand" data-id="' + data.content[i].brandId + '">' + data.content[i].brandId + '</span>';
												//												}
											}
										}
										$('.categrayb').html(html)
										//商品 筛选
										$('.categray2 span').unbind('click').click(function() {
											$(window).unbind('scroll');

											Spagenum = 2; //实到页数
											Ypagenum = 1; //应到页数
											document.body.scrollTop = document.documentElement.scrollTop = 0;
											$(this).parentsUntil('.filter').find('span').removeClass('actBadge actspan');
											$(this).addClass('actBadge');
											var categorySecond, goodsBrand, goodType, specification;
											goodsBrand = $('.categray2 .actBadge').text() == '品牌' ? '' : $('.categray2 .actBadge').text();
											brandId = $(this).attr('data-id')
											goodsList(categoryCode, '', brandId);
										})
									} else {
										$('.categrayb').html('无')
									}
								}
								if(data.code == 1000) {
									mui.toast(data.message)
								} else if(data.code == -1) {
									mui.toast(data.message)
								}

							},
							error: function(xhr, type, errorThrown) {
								plus.nativeUI.closeWaiting();
								console.log('登录响应失败');
							}
						});
					}

					var Spagenum = 2; //实到页数
					var Ypagenum = 1; //应到页数
					var oneSize = 10;
					goodsList(categoryCode, keywords, brandId)

					function goodsList(categoryCode, keywords, brandId) {
						plus.nativeUI.showWaiting()
						//商品列表
						mui.ajax(serverUrl + '/app/goods/seller/rank/list', {
							data: {
								keywords: keywords,
								userId: userId,
								identityType: identityT,
								rankCode: rankCode,
								page: 1,
								size: oneSize,
								firstCategoryCode: categoryCode,
								brandId: brandId
							},
							dataType: 'json',
							headers: {
								"Authorization": oldToken
							},
							type: 'post',
							timeout: 10000,
							success: function(data, type, xhr) {
								plus.nativeUI.closeWaiting()
								console.log('商品列表', data);
								if(data.code == 0) {
									plus.nativeUI.closeWaiting();
									if(data.content) {
										if(data.content.list && data.content.list.length) {
											$('#goodsList').html(template('goodsTpl', {
												list: data.content.list
											}));
											$('.toCart,.mui-numbox button').click(function() {
												event.stopPropagation()
											})
											var platform = plus.storage.getItem('platform')
											$('.mui-numbox input').click(function() {
												if(platform == 'ANDROID') {
													$(this).select();
												} else {
													$(this).focus();
													$(this).get(0).selectionStart = 0;
													$(this).get(0).selectionEnd = $(this).get(0).value.length;
												}
												event.stopPropagation()
											})
											mui('.mui-numbox').numbox();
											//加入购物车
											$('.toCart').unbind('click').click(function() {
												event.stopPropagation()
												var goodid = $(this).attr('data-id');
												var cur = $(this);
												plus.nativeUI.showWaiting();
												addCart(goodid, 1, cur);
											})
											//数量选择 -> 加入购物车
											$('.mui-numbox input').on('change', function() {
												plus.nativeUI.showWaiting();
												var cur = $(this);
												var number = $(this).val(); //当前数量
												var goodsid = $(this).attr("data-id"); //当前商品id
												if(number > 0) {
													var goodsList = [{
														'id': goodsid,
														'qty': number
													}];
													mui.ajax(serverUrl + '/app/materialList/edit/batch', {
														data: {
															userId: userId,
															identityType: identityT,
															goodsList: JSON.stringify(goodsList),
														},
														dataType: 'json',
														headers: {
															"Authorization": oldToken
														},
														type: 'post',
														timeout: 10000,
														success: function(data, type, xhr) {
															plus.nativeUI.closeWaiting();
															console.log('加入购物车', data);
															if(data.code == 0) {
																mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
															} else {
																mui.toast(data.message)
															}

														},
														error: function(xhr, type, errorThrown) {
															plus.nativeUI.closeWaiting();
															console.log('登录响应失败');
														}
													});
												} else {
													mui.confirm('狠心不要了咩？', '提示', ['取消', '确定'], function(e) {
														if(e.index == 1) {
															mui.ajax(serverUrl + '/app/materialList/goods/delete', {
																data: {
																	userId: userId,
																	identityType: identityT,
																	goodsIdArray: goodsid,
																},
																dataType: 'json',
																headers: {
																	"Authorization": oldToken
																},
																type: 'post',
																timeout: 10000,
																success: function(data, type, xhr) {
																	plus.nativeUI.closeWaiting();
																	console.log('删除', data);
																	if(data.code == 0) {
																		cur.parent().prev().show();
																		cur.parent().hide();
																		mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
																	} else {
																		mui.toast(data.message)
																	}

																},
																error: function(xhr, type, errorThrown) {
																	plus.nativeUI.closeWaiting();
																}
															});
														} else {
															plus.nativeUI.closeWaiting();
															cur.val(1);
															cur.siblings().removeAttr('disabled');
														}

													})
												}

											})

											function addCart(goodid, num, cur) {
												mui.ajax(serverUrl + '/app/materialList/add', {
													data: {
														userId: userId,
														identityType: identityT,
														params: goodid + '-' + num
													},
													dataType: 'json',
													headers: {
														"Authorization": oldToken
													},
													type: 'post',
													timeout: 10000,
													success: function(data, type, xhr) {
														plus.nativeUI.closeWaiting();
														console.log('加入购物车', data);
														if(data.code == 0) {
															mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
															cur.next().show();
															cur.next().find('input').val(1);
															cur.next().find('input').siblings().removeAttr('disabled');
															cur.hide();
														} else {
															mui.toast(data.message)
														}

													},
													error: function(xhr, type, errorThrown) {
														plus.nativeUI.closeWaiting();
														console.log('登录响应失败');
													}
												});
											}

											$(window).scroll(function() {
												var scrollTop = $(this).scrollTop();
												var scrollHeight = $(document).height();
												var windowHeight = $(this).height();
												if(scrollTop + windowHeight == scrollHeight) {
													if(Spagenum <= data.content.pages && Spagenum == Ypagenum + 1) { //当前页小于等于总页数时请求下一页
														mui("#upload")[0].innerHTML = "<img src='../../img/Rolling.svg' />";
														Ypagenum++; //满足加载情况,应到页数+1
														console.log('发起请求,实到' + Spagenum + '页');
														console.log('发起请求,应到' + Ypagenum + '页');
														mui.ajax(serverUrl + '/app/goods/seller/rank/list', {
															data: {
																keywords: keywords,
																userId: userId,
																identityType: identityT,
																rankCode: rankCode,
																page: Ypagenum,
																size: oneSize,
																firstCategoryCode: categoryCode,
																brandId: brandId
															},
															dataType: 'json',
															headers: {
																"Authorization": oldToken
															},
															type: 'post',
															timeout: 10000,
															success: function(data, type, xhr) {
																console.log('商品列表', data);
																if(data.code == 0) {
																	plus.nativeUI.closeWaiting();
																	if(data.content) {
																		if(data.content.list && data.content.list.length) {
																			$('#goodsList').append(template('goodsTpl', {
																				list: data.content.list
																			}));
																			$('.toCart,.mui-numbox button').click(function() {
																				event.stopPropagation()
																			})
																			var platform = plus.storage.getItem('platform')
																			$('.mui-numbox input').click(function() {
																				if(platform == 'ANDROID') {
																					$(this).select();
																				} else {
																					$(this).focus();
																					$(this).get(0).selectionStart = 0;
																					$(this).get(0).selectionEnd = $(this).get(0).value.length;
																				}
																				event.stopPropagation()
																			})
																			mui("#upload")[0].innerHTML = " ";
																			Spagenum++; //加载成功,当前页+1
																			console.log('成功+1,实到' + Spagenum);
																			console.log('成功+1,应到' + Spagenum);
																			mui('.mui-numbox').numbox();
																			//加入购物车
																			$('.toCart').unbind('click').click(function() {
																				event.stopPropagation();
																				var goodid = $(this).attr('data-id');
																				var cur = $(this);
																				plus.nativeUI.showWaiting();
																				addCart2(goodid, 1, cur);
																			})
																			//数量选择 -> 加入购物车
																			$('.mui-numbox input').on('change', function() {
																				plus.nativeUI.showWaiting();
																				var cur = $(this);
																				var number = $(this).val(); //当前数量
																				var goodsid = $(this).attr("data-id"); //当前商品id
																				if(number > 0) {
																					var goodsList = [{
																						'id': goodsid,
																						'qty': number
																					}];
																					mui.ajax(serverUrl + '/app/materialList/edit/batch', {
																						data: {
																							userId: userId,
																							identityType: identityT,
																							goodsList: JSON.stringify(goodsList),
																						},
																						dataType: 'json',
																						headers: {
																							"Authorization": oldToken
																						},
																						type: 'post',
																						timeout: 10000,
																						success: function(data, type, xhr) {
																							plus.nativeUI.closeWaiting();
																							console.log('加入购物车', data);
																							if(data.code == 0) {
																								mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
																							} else {
																								mui.toast(data.message)
																							}

																						},
																						error: function(xhr, type, errorThrown) {
																							plus.nativeUI.closeWaiting();
																							console.log('登录响应失败');
																						}
																					});
																				} else {
																					mui.confirm('狠心不要了咩？', '提示', ['取消', '确定'], function(e) {
																						if(e.index == 1) {
																							mui.ajax(serverUrl + '/app/materialList/goods/delete', {
																								data: {
																									userId: userId,
																									identityType: identityT,
																									goodsIdArray: goodsid,
																								},
																								dataType: 'json',
																								headers: {
																									"Authorization": oldToken
																								},
																								type: 'post',
																								timeout: 10000,
																								success: function(data, type, xhr) {
																									plus.nativeUI.closeWaiting();
																									console.log('删除', data);
																									if(data.code == 0) {
																										cur.parent().prev().show();
																										cur.parent().hide();
																										mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
																									} else {
																										mui.toast(data.message)
																									}

																								},
																								error: function(xhr, type, errorThrown) {
																									plus.nativeUI.closeWaiting();
																								}
																							});
																						} else {
																							plus.nativeUI.closeWaiting();
																							cur.val(1);
																							cur.siblings().removeAttr('disabled');
																						}

																					})
																				}

																			})

																			function addCart2(goodid, num, cur) {
																				mui.ajax(serverUrl + '/app/materialList/add', {
																					data: {
																						userId: userId,
																						identityType: identityT,
																						params: goodid + '-' + num
																					},
																					dataType: 'json',
																					headers: {
																						"Authorization": oldToken
																					},
																					type: 'post',
																					timeout: 10000,
																					success: function(data, type, xhr) {
																						plus.nativeUI.closeWaiting();
																						console.log('加入购物车', data);
																						if(data.code == 0) {
																							mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
																							cur.next().show();
																							cur.next().find('input').val(1);
																							cur.next().find('input').siblings().removeAttr('disabled');
																							cur.hide();
																						} else {
																							mui.toast(data.message)
																						}

																					},
																					error: function(xhr, type, errorThrown) {
																						plus.nativeUI.closeWaiting();
																						console.log('登录响应失败');
																					}
																				});
																			}

																		}
																	}
																} else {
																	plus.nativeUI.closeWaiting();
																	mui.toast(data.message)
																}

															},
															error: function(xhr, type, errorThrown) {
																plus.nativeUI.closeWaiting();
																Ypagenum--; //失败是应到-1
																mui.toast("当前网络不好请重试");
																mui("#upload")[0].innerHTML = "";
																console.log('响应失败');
															}
														});

													} else if(Spagenum == data.content.pages + 1) { //当前页不小于等于总页数时请求下一页
														mui("#upload")[0].innerHTML = "到底了";
													}
												}
											});

										} else {
											$('#goodsList').html('<div style="text-align:center;padding:15px">暂无商品</div>')
										}
									} else {
										$('#goodsList').html('<div style="text-align:center;padding:15px">暂无商品</div>')
									}
								} else {
									mui.toast(data.message)
								}

							},
							error: function(xhr, type, errorThrown) {
								plus.nativeUI.closeWaiting();
								mui.toast(type)
								console.log('登录响应失败');
							}
						});

					}

					//搜索
					$('#searchf').submit(function() {
						var valInt = $('#valInt').val();
						goodsList(categoryCode, valInt, brandId)
						return false;
					})
					$('#clickSearch, #cancelSearch').click(function() {
						var valInt = $('#valInt').val();
						goodsList(categoryCode, valInt, brandId)
					})

				}

			})
		</script>

	</body>

</html>