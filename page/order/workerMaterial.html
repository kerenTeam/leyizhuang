<!doctype html>

<html>

	<head>
		<meta charset="UTF-8">
		<title>确认订单</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css" />
		<link rel="stylesheet" href="../../css/resetY.css">
		<link rel="stylesheet" type="text/css" href="../../css/commonY.css" />
		<link rel="stylesheet" type="text/css" href="../../css/cart.css" />
		<link rel="stylesheet" type="text/css" href="../../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../../css/configW.css" />
		<link href="../../css/mui.picker.minY.css" rel="stylesheet" />
		<link href="../../css/mui.poppicker.css" rel="stylesheet" />
	</head>

	<body>

		<header class="mui-bar mui-bar-nav">
			<a class="headbar mui-action-back mui-icon mui-icon-left-nav mui-pull-left normalSize"></a>
			<h1 class="mui-title">确认订单</h1>
		</header>
		<script src="js/statusBar.js"></script>
		<!--状态栏-->
		<div style="height:50px;"></div>
		<div class="flexwc">
			<div class="cartOne">
				<img src="../../img/check1.png" /> 下料清单
			</div>
			<div class="cartSecond">
				<img src="../../img/check1.png" /> 选赠品
			</div>
			<div class="cartOne">
				<img src="../../img/check2.png" /> 结算
			</div>
		</div>
		
		<div id="cartData" data-id=""></div>
		<script type="text/html" id="cartTpl">
		 
			<dl class="cart">
				<%for(var i=0;i<list.length;i++){%>
					<dd>
						<a class="goodsPic" style="margin-left: auto;"><img src="<%=list[i].coverImageUri%>" onerror="javascript:this.src='../../images/img.svg';" /></a>
						<div class="goodsInfor" style="margin-left: 0.9rem!important;">
							<h2>  
						    		<a><%=list[i].skuName%></a>
						    		<%if(list[i].isGift){%>
						    			<em class="mui-badge mui-badge-danger mui-pull-right" style="color: white;">赠品</em>
						    		<%}%>
						   	</h2>
							<div class="priceArea">
								<div class="extraBrief">
									单位：<%=list[i].goodsUnit%>；规格：<%=list[i].goodsSpecification%>
								</div>
								<strong>¥<span class="price"><%=list[i].retailPrice%></span></strong>
								<div class="numberWidget">
									<span class="num">x<%=list[i].qty%></span>
								</div>
							</div>
		
						</div>
					</dd>
				<%}%>
				
	
				<div class="pad10 ft15">
					共10件商品 订单总金额：<span id="totalPrice"></span> <span class="mui-pull-right activecl" onclick="materialList()">查看全部</span>
				</div>
				<div style="clear: both;"></div>
			</dl>
		</script>
		<div style="background: white;">
			<div class="pad10 ft15 afterBorder">
				<em>配送方式 </em>
				<div class="mui-input-row mui-radio mui-left mui-pull-right" style="margin-top: -8px;">
					<label>送货上门</label>
				</div>
			</div>
			<div style="clear: both;"></div>
			<div style="background-color: white;margin: 5px 0;">
			<div id="add_info"></div>
			<script type="text/html" id="addrTpl">
				<%if(obj.length==0){%>
				<div class="qtop flexr pad10" onclick="address()">
					<div style="flex: 1;margin-left: 10px;">
						<div class="maincl ft16">
							<span class="disablecl"></span>
							<span class="disablecl"></span>
						</div>
						<div class="ft16">
							<span class="disablecl">请选择收获地址</span>
						</div>
					</div>
					<div class="">
						<img src="../../images/center/right.svg" alt="" />
					</div>
				</div>
				<%}else{%>
					<div class="qtop flexr pad10" onclick="address()" id="addid" data-id="<%=obj[0].id%>" data-receiver="<%=obj[0].person%>" data-receiverPhone="<%=obj[0].phone%>" data-deliveryCity="<%=obj[0].city%>" data-deliveryCounty="<%=obj[0].country%>" data-deliveryStreet="<%=obj[0].street%>" data-residenceName="<%=obj[0].villageName%>" data-detailedAddress="<%=obj[0].address%>">
						<div style="flex: 1;margin-left: 10px;">
							<div class="maincl ft16">
								<span class="disablecl"><%=obj[0].person%></span>
								<span class="disablecl"><%=obj[0].phone%></span>
							</div>
							<div class="ft16">
								<span class="disablecl"><%=obj[0].province%><%=obj[0].city%><%=obj[0].country%><%=obj[0].street%><%=obj[0].villageName%><%=obj[0].address%></span>
							</div>
						</div>
						<div class="">
							<img src="../../images/center/right.svg" alt="" />
						</div>
					</div>
				
				<%}%>
			</script>
			
			</div>
			<div id='cityResult' data-id = '0' class="ui-alert pad10 afterBorder">配送时间 <span class="mui-pull-right">选择</span></div>
			<div class="mui-input-row mui-checkbox mui-left afterBorder">
				<label>是否业主收货</label>
				<input name="checkbox1" id="isOwner" value="1" type="checkbox" checked>
			</div>
			<div class="pad10 activecl ft13 afterBorder">
				温馨提示：若收货人为主家，系统将在出货打印单中自动隐藏折扣信息
			</div>
			<div>
				备注：<textarea name="" id="other" maxlength="100" cols="30" rows="4"></textarea>
			</div>
		</div>
		
		<!--bottom nav-->
		<div style="height:1rem;"></div>
		<aside class="btmNav" id="dibu">
			<a class="goOrder dp" style="background:#f53c42;color:white;text-shadow:none;">提交审核</a>
		</aside>
		<!--<button class="mui-btn-danger">提交审核</button>-->
		<!--<%}%>-->
		<!--</script>-->

		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/mui.picker.min.js"></script>
		<script src="../../js/mui.poppicker.js"></script>
		<script src="../../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/default.js" type="text/javascript" charset="utf-8"></script>
	</body>

	<script>
		function materialList() {
			openview({
				view: 'materialList.html',
				id: 'materialList'
			})
		}

		function address() {
			openview({
				view: '../personal/address.html',
				id: 'address',
				extrasobj: {
					page: 'order',
					goType:'order'
				}
			})
		}
		
		mui.plusReady(function() {
			var userId = plus.storage.getItem('$userId');
			var oldToken = plus.storage.getItem("oldToken");
			var identityT = JSON.parse(plus.storage.getItem("$identityType")).identityType;
			
			//显示商品
			var goods = JSON.parse(plus.storage.getItem('cartObj')) ||'[]' ;
			document.getElementById('cartData').innerHTML = template('cartTpl',{list:goods});
			//刷新地址
			window.addEventListener('readdstorage', function(event) {
				alert(1 )
				orderAdd()
			});
			
			orderAdd();
			//显示地址
			function orderAdd(){
				//默认地址
				mui.ajax(serverUrl+'/app/user/deliveryAddress/default',{
					data:{
						userId:userId,
						identityType:identityT
					},
					dataType:'json',
					type:'post',
					timeout:1000,
					headers:{"Authorization":oldToken},
					success:function(data,type,xhr){
						console.log('默认地址',data);
						var addrObj = {};
						if(data.code == 0){
							if(plus.storage.getItem("$addressStorage") != null) {
								addrObj.obj = JSON.parse(plus.storage.getItem("$addressStorage"));
							}else{
								var defultAddress ={};
									defultAddress.id = data.content.id;
									defultAddress.person = data.content.deliveryName;
									defultAddress.phone = data.content.deliveryPhone;
									defultAddress.province = data.content.deliveryProvince;
									defultAddress.city = data.content.deliveryCity;
									defultAddress.country = data.content.deliveryCounty;
									defultAddress.street = data.content.deliveryStreet;
									defultAddress.villageName = data.content.villageName;
									defultAddress.address = data.content.detailedAddress;
									addrObj.obj = [defultAddress];
							}
							document.getElementById("add_info").innerHTML = template("addrTpl", addrObj);
							plus.storage.removeItem("$addressStorage")
							
						}else{
							mui.toast(data.message);
						}
					},
					error:function(xhr,type,errorThrown){
						console.log('响应失败  !');
					}
				});
				
//				plus.storage.removeItem("$addressStorage")
			}
			//获取金额
			
			
			//级联示例
			var cityData = [{
				value: '110000',
				text: '9月1号(周五)',
				children: [{
					value: "1",
					text: "7:00-8:00"
				}, {
					value: "2",
					text: "8:00-9:00"
				}, {
					value: "3",
					text: "9:00-10:00"
				}]
			}, {
				value: '110000',
				text: '9月2号(周六)',
				children: [{
					value: "1",
					text: "7:00-8:00"
				}, {
					value: "2",
					text: "10:00-11:00"
				}, {
					value: "3",
					text: "13:00-20:00"
				}]
			}]
			var cityPicker = new mui.PopPicker({
				layer: 2
			});
			cityPicker.setData(cityData);
			var cityResult = document.getElementById('cityResult');
			cityResult.addEventListener('tap', function(event) {
				cityPicker.show(function(items) {
					$('#cityResult').attr('data-id','1')
					$('#cityResult span').html(items[0].text + " " + items[1].text)
					//返回 false 可以阻止选择框的关闭
					//return false;
				});
			}, false);
			//-----------------------------------------
			//工人提交物料审核单
			$('#dibu').click(function(){
				var receiver = $('#addid').attr('data-receiver')
				var receiverPhone = $('#addid').attr('data-receiverPhone')
				var deliveryCity = $('#addid').attr('data-deliveryCity')
				var deliveryCounty = $('#addid').attr('data-deliveryCounty')
				var residenceName = $('#addid').attr('data-residenceName')
				var deliveryStreet = $('#addid').attr('data-deliveryStreet')
				var detad = $('#addid').attr('data-detailedAddress')
				var receiver = $('#addid').attr('data-receiver')
				var pstime = $('#cityResult span').html();//配送时间
				var isOwnerReceive = $('#isOwner').attr('checked');
				var idobj = plus.storage.getItem('materialList');
				alert(idobj)
				if($('#cityResult').attr('data-id') == 0){
					mui.toast('请选择配送时间')
				}else{
					mui.ajax(serverUrl+'/app/material/audit/save',{
						data:{
							userID:userId,
							identityType:identityT,
							ids:idobj,
//							receiver:receiver,
//							receiverPhone:receiverPhone,
//							deliveryCity:deliveryCity,
//							deliveryCounty:deliveryCounty,
//							deliveryStreet:deliveryStreet, 
//							residenceName:residenceName,
//							detailedAddress:detad,
//							reservationDeliveryTime:pstime,
//							isOwnerReceiving:isOwnerReceive,
							remark:$('#other').val(),
						},
						dataType:'json',
						type:'post',
						timeout:10000,
						headers:{"Authorization":oldToken},
						success:function(data,type,xhr){
							console.log('提交审核',data);
							var addrObj = {};
							if(data.code == 0){
								
							}else{
								mui.toast(data.message);
							}
						},
						error:function(xhr,type,errorThrown){
							console.log('响应失败  !');
						}
					});
				}
				
			})
			

		})
	</script>

</html>