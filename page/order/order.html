<!doctype html>

<html>

	<head>
		<meta charset="UTF-8">
		<title>确认订单</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css" />
		<link rel="stylesheet" href="../../css/resetY.css">
		<link rel="stylesheet" type="text/css" href="../../css/commonY.css" />
		<link rel="stylesheet" type="text/css" href="../../css/cart.css" />
		<link rel="stylesheet" type="text/css" href="../../css/style.css" />
		<link rel="stylesheet" type="text/css" href="../../css/configW.css" />
		<link href="../../css/mui.picker.minY.css" rel="stylesheet" />
		<link href="../../css/mui.poppicker.css" rel="stylesheet" />
	</head>
	<style type="text/css">
		#coupon .mui-checkbox,
		.checkQuan .mui-checkbox,
		.waypay .mui-checkbox {
			position: absolute;
			top: 50%;
			margin-top: -18px;
			right: 0;
		}

		.mui-checkbox input[type=checkbox]:checked:before,
		.mui-radio input[type=radio]:checked:before {
			color: #B62D29;
		}

		.mui-card {
			border: 0;
			margin: 0!important;
		}

		.checkQuan {
			padding: 2px 15px;
			border: 1px solid #f53c42;
			border-radius: 5px;
			line-height: 18px;
			margin: 5px 0;
			position: relative;
		}

		.checkQuan .mui-col-sm-3 {
			width: 28%;
			padding: 12px 5px;
		}

		.checkQuan .mui-col-sm-9 {
			width: 72%;
			padding: 12px 15px;
			border-left: 1px dotted #f53c42;
		}

		.cred {
			color: #f53c42;
		}

		.dateLimit {
			font-size: 12px;
		}

		.mui-radio input[type=radio]:before {
			font-size: 20px;
		}

		.mui-radio input[type=radio] {
			top: 8px;
		}

		.quanc {
			display: none;
			width: 0.3rem;
			margin-right: 0.1rem;
			display: none;
		}

		.preDeposit {
			width: 35%!important;
			margin-top: -4px;
			height: 30px!important;
			text-align: right;
			padding: none!important;
			border: none!important;
			border-left:1px solid #BCBCBC!important;
			border-radius: 0!important;
			outline: none;
		}
		.cart dd {
			border-bottom: none;
		}

		.mui-radio.mui-left label {
			padding-left: 47px;
		}

		.psw {
			margin-top: -8px;
			margin-right: -10px;
		}

		.mui-table-view-cell.mui-active {
			background-color: none!important;
			border-radius: 0!important;
		}

		.mui-table-view-cell.mui-collapse .mui-collapse-content {
			margin: 11px -15px -15px;
		}
		input[type="tel"],input[type="number"]{
			padding: 0;
   			text-align: center;
		}
		.allaccountinfo{border-left:3px solid #B62D29 ;padding: 0 5px;}
	</style>

	<body>

		<header class="mui-bar mui-bar-nav">
			<a class="headbar mui-action-back mui-icon mui-icon-left-nav mui-pull-left normalSize"></a>
			<h1 class="mui-title">确认订单</h1>
		</header>
		<!--状态栏-->
		<script src="../../js/statusBar.js" type="text/javascript" charset="utf-8"></script>
		<div class="mui-content" style="margin-top: 7px;">
			<div class="flexwc">
				<div class="cartOne cartAct">
					<img src="../../images/order/c1.svg" /> 下料清单
				</div>
				<div class="cartSecond cartAct">
					<img src="../../images/order/c2.svg" /> 挑选赠品
				</div>
				<div class="cartThird cartAct">
					<img src="../../images/order/c3.svg" /> 订单结算
				</div>
			</div>
			<div id="cartData" data-id=""></div>
			<script type="text/html" id="cartTpl">

				<dl class="cart mb10">
					<div style="max-height: 300px;overflow-y: scroll;">
						<%for(var i=0;i<list.length;i++){%>
						<dd class="afterBorder goodsbgc">
							<a class="goodsPic" style="margin-left: auto;"><img src="<%=list[i].coverImageUri%>" onerror="javascript:this.src='../../img/editset.png';" /></a>
							<div class="goodsInfor" style="margin-left: 0.9rem!important;">
								<span class="ft15 goodname"><%=list[i].goodsName%></span>
								<%if(list[i].goodsLineType == 'PRESENT'){%>
								<em class="mui-badge mui-badge-danger mui-pull-right" style="color: white;">赠品</em>
								<%}else if(list[i].goodsLineType == 'PRODUCT_COUPON'){%>
								<em class="mui-badge mui-badge-warning mui-pull-right" style="color: white;">产品券</em>
								<%}%>
								<div class="priceArea">
									<div class="maincl ft14">
										单位：
										<%=list[i].goodsUnit%>；规格：
										<%=list[i].goodsSpecification%>
									</div>
									<span class="ft18 activecl2">¥<span class="price"><%=list[i].retailPrice%></span></span>
									<div class="mui-pull-right">
										<span class="num">x<%=list[i].goodsQty%></span>
									</div>
								</div>

							</div>
						</dd>
						<%}%>
					</div>
					<div class="pad10 ft16">
						共<span id='totalGoods' class="activecl"><%=totalQty%></span>件商品 <span class="mui-pull-right">商品总金额：<span class="activecl" id="totalPrice">¥<%=totalPrice%></span><span class="mui-icon mui-icon-arrowright maincl ft18" onclick="materialList()"></span></span>
					</div>
					<div style="clear: both;"></div>
				</dl>
			</script>
			<div class="bgcwt">
				<div class="pad10 ft15 afterBorder">
					<em>配送方式 </em>
					<div class="mui-input-row mui-radio mui-left mui-pull-right psw selfTake">
						<label>自提</label>
						<input name="peis" type="radio" value="1">
					</div>
					<div class="mui-input-row mui-radio mui-left mui-pull-right psw sssm">
						<label>送货上门</label>
						<input name="peis" type="radio" value="2" checked="">
					</div>
				</div>
				<div style="clear: both;"></div>
				<div class="pad10 ft15 afterBorder flexr" id="chooseStore" style="display: none;">
					<em>选择门店 </em>
					<div style="display: flex;align-items: center;">
						<select style="padding: 0;direction: rtl!important;">
							<option value="">选择</option>
						</select>
						<span class="mui-icon mui-icon-arrowdown mui-pull-right ft16"></span>
					</div>
				</div>
				<div class="pad10 ft15 flexr afterBorder" id="storeAddress" style="display:none;">
					<em>门店地址 </em>
					<div class="storeAddress">
					</div>
				</div>
				<div id="add_info" class="afterBorder"></div>
				<script type="text/html" id="addrTpl">
					<%if(obj.length==0){%>
					<div class="qtop flexr pad10" onclick="address()">
						<img src="../../images/order/map.svg" style="margin-right: 10px;"/>
						<div style="flex: 1;">
							<div class="maincl ft15">
								<span class="maincl"></span>
								<span class="maincl"></span>
							</div>
							<div class="ft15">
								<span class="maincl">请选择收获地址</span>
							</div>
						</div>
						<span class="mui-icon mui-icon-arrowright maincl ft20"></span>
					</div>
					<%}else{%>
					<div class="qtop flexr pad10" onclick="address()" id="addid" data-receiver="<%=obj[0].person%>" data-receiverPhone="<%=obj[0].phone%>" data-deliveryCity="<%=obj[0].city%>" data-deliveryCounty="<%=obj[0].country%>" data-deliveryStreet="<%=obj[0].street%>" data-residenceName="<%=obj[0].villageName%>" data-detailedAddress="<%=obj[0].address%>">
						<img src="../../images/order/map.svg" style="margin-right: 10px;"/>
						<div style="flex: 1;">
							<div class="ft15">
								<span class="titcl"><%=obj[0].person%></span>
								<span class="titcl"><%=obj[0].phone%></span>
							</div>
							<div class="ft15">
								<span class="titcl"><%=obj[0].province%><%=obj[0].city%><%=obj[0].country%><%=obj[0].street%><%=obj[0].villageName%><%=obj[0].address%></span>
							</div>
						</div>
						<span class="mui-icon mui-icon-arrowright maincl ft20"></span>
					</div>

					<%}%>
				</script>
				<div id='cityResult' class="ui-alert pad10 afterBorder ft15">配送时间<span class="mui-icon mui-icon-arrowdown maincl mui-pull-right ft16"></span><span class="mui-pull-right pstime">选择</span></div>
				<div class="mui-input-row mui-checkbox ft15 isowndis">
					<label style="padding: 18px 10px;">是否主家收货</label>
					<input name="checkbox1" style="top: 12px;right: 12px;" class="mui-pull-right isOwnerReceiving" value="Item 1" type="checkbox" checked>
				</div>
				<div class="pad10 ft13 isowndis bgcee maincl" style="overflow: hidden;">
					<div class="mui-pull-left">温馨提示：</div>
					<div class="mui-pull-left" style="width: 80%;word-break:break-all;">若收货人为主家，系统将在出货打印单中自动隐藏折扣信息</div>
				</div>
			</div>
			<div class="bgcwt mb10">
				<div class="pad10 ft16 afterBorder "><span class="allaccountinfo">账单明细</span><span class="mui-icon mui-icon-arrowdown maincl mui-pull-right"></span> </div>
				<div class="pad_5 ft15 maincl">商品金额<span class='mui-pull-right pad_r10' id="totalPriceb">¥--</span> </div>
				<div class="pad_5 ft15 maincl">会员折扣<span class='mui-pull-right pad_r10' id="memberDiscount">¥--</span></div>
				<div class="pad_5 ft15 maincl">订单折扣<span class='mui-pull-right pad_r10' id="orderDiscount">¥--</span></div>
				<div class="pad_5 ft15 maincl">运费<span class='mui-pull-right pad_r10' id="freight">¥--</span></div>
				<div class="pad_5 ft15 maincl">上楼费<span class='mui-pull-right pad_r10' id="upstar">依现实情况收取</span></div>

			</div>
			<div id="elseDiscount"></div>
			<script type="text/html" id="elseDiscountTpl">
				<dl class="list" style="border: none;">
					<div id="quanData">
						<div class="mui-card afterBorder" style="border: none!important;box-shadow: none;">
							<ul class="mui-table-view">
								<%if(cashCouponList && cashCouponList.length){%>
								<li class="mui-table-view-cell mui-collapse pad10">
									<a class="mui-navigate-right" style="padding: 10px 15px;" href="#">优惠券<span class="fr" style="margin-right: 15px;">选择</span></a>
									<div class="mui-collapse-content">
										<%for(var j = 0; j<cashCouponList.length;j++){%>
										<div class="checkQuan mui-row" data-id="<%=cashCouponList[j].id%>">
											<div class="mui-col-sm-3">
												<div>￥<big><b><%=cashCouponList[j].denomination%></b></big></div>
												<div><small><%=cashCouponList[j].description%></small></div>
											</div>
											<div class="mui-col-sm-9">
												<div class="cred"><big><%=cashCouponList[j].title%></big>
												</div>
												<div class="dateLimit">
													<%=cashCouponList[j].effectiveStartTime%> ~
													<%=cashCouponList[j].effectiveEndTime%>内有效
												</div>
											</div>
											<div class="mui-checkbox"><img src="../../images/xuanze.png" class="quanc" data-id="<%=cashCouponList[j].id%>" alt="" /></div>
										</div>
										<%}%>

									</div>
								</li>
								<%}else{%>
								<div class="pad10 ft14 afterBorder">优惠券<span class='mui-pull-right pad_r10'>无</span></div>
								<%}%>

							</ul>
						</div>
					</div>
					<%if(lebi && lebi.quantity && lebi.rebate){%>
					<div id="coupon" class="afterBorder">
						<dd class="pad10 kv-line-r">
							<div class="titcl">共<span id="totalJfen" class="activecl"><%=lebi.quantity%></span>乐币,抵用<span id="itMinus" class="activecl"><span>¥<%=lebi.rebate%></span></span>
							</div>
							<div id="changeJf" class="mui-checkbox"><input name="checkbox" class="groupCheck" type="checkbox"></div>
						</dd>
					</div>
					<%}else{%>
					<div id="coupon" class="afterBorder">
						<dd class="pad10 kv-line-r">
							<h6>无乐币</h6>
							<div class="mui-checkbox"><input name="checkbox" style="right: 10px;" class="groupCheck" type="checkbox" disabled=""></div>
						</dd>
					</div>
					<%}%>
					<div class="pad10 ft16" style="text-align: right;">订单金额小计：<span class="activecl" id="totalOrderAmount">¥--</span></div>
					<div style="height: 10px;background: #EEEEEE;"></div>
					<%if(platform == 'ANDROID'){%>
						<div class="pad10 ft14 afterBorder"><%if(guide ==1){%>门店<%}%>预存款&nbsp;&nbsp;<span class='activecl' id="preDepositb">¥--</span><input type="tel" onchange="maxC(this)" onkeyup="onlyNum(this)" onafterpaste="pastNum(this)" placeholder="请输入使用金额" name="preDepositb" class='mui-pull-right preDeposit' oninput="inputbd()"/></div>
						<!--only manager-->
						<div class="pad10 ft14 afterBorder manager" style="display: none;">信用金&nbsp;&nbsp;<span class='activecl' id="credit">¥--</span><input type="tel" placeholder="请输入使用金额" name="credit" onchange="maxC(this)" onkeyup="onlyNum(this)" onafterpaste="pastNum(this)" class='mui-pull-right preDeposit' oninput="inputbd()"/></div>
						<div class="pad10 ft14 afterBorder manager" style="display: none;">现金返利&nbsp;&nbsp;<span class='activecl' id="cash">¥--</span><input type="tel" placeholder="请输入使用金额" name="cash" onchange="maxC(this)" onkeyup="onlyNum(this)" onafterpaste="pastNum(this)" class='mui-pull-right preDeposit' oninput="inputbd()"/></div>
						<!--only guide-->
						<div class="pad10 ft14 afterBorder guide" style="display: none;">信用额度&nbsp;&nbsp;<span class='activecl' id="creditVal">¥--</span><input type="tel" placeholder="请输入使用金额" name="creditVal" onchange="maxC(this)" onkeyup="onlyNum(this)" onafterpaste="pastNum(this)" class='mui-pull-right preDeposit' oninput="inputbd()"/></div>
						<div class="pad10 ft14 afterBorder guide dsje" style="display: none;">代收金额&nbsp;&nbsp;<input type="tel" placeholder="请输入代收金额" name="cashHelp" onkeyup="onlyNum(this)" onafterpaste="pastNum(this)" class='mui-pull-right preDeposit' /></div>
					<%}else{%>
						<div class="pad10 ft14 afterBorder"><%if(guide == 1){%>门店<%}%>预存款&nbsp;&nbsp;<span class='activecl' id="preDepositb">¥--</span><input type="number" onchange="maxC(this)" onkeyup="onlyNum(this)" onafterpaste="pastNum(this)" placeholder="请输入使用金额" name="preDepositb" class='mui-pull-right preDeposit' oninput="inputbd()"/></div>
						<div class="pad10 ft14 afterBorder manager" style="display: none;">信用金&nbsp;&nbsp;<span class='activecl' id="credit">¥--</span><input type="number" placeholder="请输入使用金额" name="credit" onchange="maxC(this)" onkeyup="onlyNum(this)" onafterpaste="pastNum(this)" class='mui-pull-right preDeposit' oninput="inputbd()"/></div>
						<div class="pad10 ft14 afterBorder manager" style="display: none;">现金返利&nbsp;&nbsp;<span class='activecl' id="cash">¥--</span><input type="number" placeholder="请输入使用金额" name="cash" onchange="maxC(this)" onkeyup="onlyNum(this)" onafterpaste="pastNum(this)" class='mui-pull-right preDeposit' oninput="inputbd()"/></div>
						<div class="pad10 ft14 afterBorder guide" style="display: none;">信用额度&nbsp;&nbsp;<span class='activecl' id="creditVal">¥--</span><input type="number" placeholder="请输入使用金额" name="creditVal" onchange="maxC(this)" onkeyup="onlyNum(this)" onafterpaste="pastNum(this)" class='mui-pull-right preDeposit' oninput="inputbd()"/></div>
						<div class="pad10 ft14 afterBorder guide dsje" style="display: none;">代收金额&nbsp;&nbsp;<input type="number" placeholder="请输入代收金额" name="cashHelp" onkeyup="onlyNum(this)" onafterpaste="pastNum(this)" class='mui-pull-right preDeposit' /></div>
					<%}%>
					<div style="height: 10px;background: #EEEEEE;"></div>


				</dl>
			</script>
			<div class="bgcwt flexr margBot10" data-id = "1" id="isShowNumber" style="align-items:center ;padding: 10px;">
				<span id="">
					销货单号
				</span>
				<input placeholder="请填写纸质销货单号" type="text" maxlength="20" style="width: 70%;border: 0;text-align: right;margin-bottom: 0;"  />
			</div>
			<textarea rows="3" id='remark' placeholder="备注信息（最大可输入字数120字）" maxlength="255"></textarea>

			<!--存储 第一次返回乐币 和 合计-->
			<input type="hidden" id="firstLebi" data-id='' value="" />
			<input type="hidden" id="firstTotal" value="" />
			<input type="hidden" id="firstFreight" value="" />
			<input type="hidden" id="couponDiscount" value="0" />
			<input type="hidden" id="firstOrderDiscount" value="0" />
			<div style="height:1rem;"></div>
			<aside class="btmNav" id="dibu">
				<a class="dp ft16" style="color: #B62D29;">
					<span>应付款：</span>¥<span class="totalMoney">--</span>
				</a>
				<a class="goOrder dp ft16" style="background:#B62D29;color:white;text-shadow:none;">去支付</a>

			</aside>

			<!--操作表-->
			<div id="maskInfo" style="display: none;">
				<!-- 可选择菜单 -->
				<ul class="paychoose ft16">
					<li class="fttc pad10 afterBorder ft16 activecl">
						应付金额：<span id="payMoney">---</span>
					</li>
					<li class="pad10 afterBorder" id="alipay">
						<img src="../../images/order/alipay.svg" />支付宝
					</li>
					<li class="pad10 afterBorder" id="wxpay">
						<img src="../../images/order/weixinpay.svg" />微信
					</li>
					<li class="pad10 afterBorder">
						<img src="../../images/order/bankpay.svg" />银联支付
					</li>
					<li class="pad10 afterBorder" id="facePay" style="display: none;">
						<img src="../../images/order/facePay.svg" />货到付款
					</li>
					<li class="closeMask fttc pad10">
						取消
					</li>
				</ul>
			</div>
		</div>

		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/mui.picker.min.js"></script>
		<script src="../../js/mui.poppicker.js"></script>
		<script src="../../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/default.js" type="text/javascript" charset="utf-8"></script>
	</body>

	<script>
		function onlyNum(obj) {
			obj.value = obj.value.replace(/[^\d.]/g,"");  //清除“数字”和“.”以外的字符
			  obj.value = obj.value.replace(/\.{2,}/g,"."); //只保留第一个. 清除多余的
			  obj.value = obj.value.replace(".","$#$").replace(/\./g,"").replace("$#$",".");
			  obj.value = obj.value.replace(/^(\-)*(\d+)\.(\d\d).*$/,'$1$2.$3');//只能输入两个小数
			  if(obj.value.indexOf(".")< 0 && obj.value !=""){//以上已经过滤，此处控制的是如果没有小数点，首位不能为类似于 01、02的金额
			   obj.value= parseFloat(obj.value);
			  }
		}

		function pastNum() {
			if(obj.value.length == 1) {
				obj.value = obj.value.replace(/[^1-9]/g, '0')
			} else {
				obj.value = obj.value.replace(/\D/g, '')
			}
		}
		function address() {
			openview({
				view: '../personal/address.html',
				id: 'address',
				extrasobj: {
					page: 'gorder',
					goType: 'gorder'
				}
			})
		}

		mui.plusReady(function() {
			var platform = plus.storage.getItem('platform')
			var userId = plus.storage.getItem('$userId');
			var oldToken = plus.storage.getItem("oldToken");
			var identityT = JSON.parse(plus.storage.getItem("$identityType")).identityType;
			var allGoods =plus.storage.getItem('orderGoodsList');
			var onlyGoods = plus.storage.getItem('justGoods');
			var idobj = plus.storage.getItem('goodlists');
			var productCouponList = plus.storage.getItem('productCouponList');//产品券商品
			var promotionInfo = plus.storage.getItem('giftList');//促销赠品
			var customerId = plus.webview.currentWebview().customerId || '';
			var sysDeliveryType = plus.webview.currentWebview().sysDeliveryType;
//			alert(sysDeliveryType)
			if(plus.storage.getItem('auditNo') && plus.storage.getItem('remark')){
				$('#remark').val(plus.storage.getItem('remark'));
			}
			if(sysDeliveryType == 'SELF_TAKE'){
				mui.confirm('订单存在库存不足商品，是否切换自提方式', '提示', ['返回', '确定'], function(e) {
					if(e.index == 1) {
						$('.sssm').hide();
						$('.selfTake').show().attr('checked',true);
						$(".selfTake input").trigger("click");
					}else{
						setTimeout(function(){
							if(plus.webview.getWebviewById("chooseCustom")) {
								plus.webview.getWebviewById("chooseCustom").close();
							}
							if(plus.webview.getWebviewById("chooseGift")) {
								plus.webview.getWebviewById("chooseGift").close();
							}
							if(plus.webview.getWebviewById("order")) {
								plus.webview.getWebviewById("order").close();
							}
						},0)
					}
				})
			}
			var pays = {};
			console.log('idobj ', idobj)
			console.log('allGoods ', allGoods)
			console.log('productCouponList ', productCouponList)
			console.log('promotionInfo ', promotionInfo)
			window.materialList = function() {
				openview({
					view: 'elseMaterialList.html',
					id: 'elseMaterialList',
					extrasobj:{
						customerId:customerId
					}
				})
			}

			window.maxC = function(obj) {
				var cur = $(obj);
				var maxCh = cur.prev().html().replace('¥', '');
				var payValue = $('#totalOrderAmount').html().replace('¥', '');
				var creditc = $('input[name="credit"]').val(); //信用金
				var cashc = $('input[name="cash"]').val(); //现金返利
				var creditValc = $('input[name="creditVal"]').val(); //信用额度
				var preDepositbc = $('input[name="preDepositb"]').val(); //预存款
				var inputAll = Number(creditc) + Number(cashc) + Number(creditValc) +Number(preDepositbc);
				if(inputAll > payValue){
					mui.toast('您输入的金额大于应付金额哦');
					obj.value = '';
					carculate()
					return;
				}else if(Number(obj.value) > Number(maxCh)) {
					mui.toast('不能大于当前项的最大额度');
					obj.value = '';
					carculate()
					return;
				}else{
					carculate()
				}

			}
			window.inputbd = function(){
				carculate()
			}
			if(identityT == 2) {
				$('.selfTake').hide();
			}
			plus.nativeUI.showWaiting();
			console.log('ENTER ',{
					userId: userId,
					identityType: identityT,
					goodsList: JSON.parse(idobj),
					customerId: customerId,
					giftList:JSON.parse(promotionInfo),
					productCouponList:JSON.parse(productCouponList)
				})
			//获取料单商品
			getMaterial();
			function getMaterial(){
				mui.ajax(serverUrl + '/app/order/enter', {
					data: {
						userId: userId,
						identityType: identityT,
						goodsList: JSON.parse(idobj),
						customerId: customerId,
						giftList:JSON.parse(promotionInfo),
						productCouponList:JSON.parse(productCouponList)
					},
					dataType: 'json',
					type: 'post',
					timeout: 10000,
					headers: {
						"Authorization": oldToken,
						'Content-Type': 'application/json'
					},
					success: function(data, type, xhr) {
						console.log('获取料单商品', data);
						var dataObj = {};
						if(data.code == 0 && data.content) {
							promotionInfo = JSON.stringify(data.content.promotionInfo);//更换选赠品时存的促销赠品
							//显示商品
							var goods = data.content.totalGoodsInfo;

							dataObj.totalQty = data.content.totalQty;
							dataObj.totalPrice = data.content.totalPrice;
							dataObj.list = goods;
							document.getElementById('cartData').innerHTML = template('cartTpl', dataObj);
							if(data.content.totalPrice) {
								$('#totalPriceb').html('¥' + data.content.totalPrice)
							} else {
								$('#totalPriceb').html('0')
							}
							if(data.content.memberDiscount) {
								$('#memberDiscount').html('-¥' + data.content.memberDiscount)
							} else {
								$('#memberDiscount').html('0')
							}
							if(data.content.orderDiscount) {
								$('#orderDiscount').html('-¥' + data.content.orderDiscount);
								$('#firstOrderDiscount').val(data.content.orderDiscount)
							} else {
								$('#orderDiscount').html('0')
							}
							if(data.content.freight) {
								$('#freight').html('¥' + data.content.freight)
								$('#firstFreight').val(data.content.freight)
							} else {
								$('#freight').html('0')
								$('#firstFreight').val(0)
							}

							if(data.content.upstairsFee) {
								$('#upstar').html('¥' + data.content.upstairsFee)
							}
							if(data.content.isShowNumber) {
								$('#isShowNumber').show()
								$('#isShowNumber').attr('data-id',1)

							}else{
								$('#isShowNumber').hide()
								$('#isShowNumber').attr('data-id',0)
							}
							if(data.content.cashCouponList && data.content.cashCouponList.length) {
								for(var i in data.content.cashCouponList) {
									if(data.content.cashCouponList[i].effectiveStartTime) {
										var date = new Date(data.content.cashCouponList[i].effectiveStartTime / 1000 * 1000);
										Y = date.getFullYear() + '-';
										M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
										D = date.getDate() + ' ';
										data.content.cashCouponList[i].effectiveStartTime = Y + M + D;
									}
									if(data.content.cashCouponList[i].effectiveEndTime) {
										var date = new Date(data.content.cashCouponList[i].effectiveEndTime / 1000 * 1000);
										Y = date.getFullYear() + '-';
										M = (date.getMonth() + 1 < 10 ? '0' + (date.getMonth() + 1) : date.getMonth() + 1) + '-';
										D = date.getDate() + ' ';
										data.content.cashCouponList[i].effectiveEndTime = Y + M + D;
									}
								}
							}
							var discount = {};
							discount.platform = platform;
							discount.lebi = data.content.leBi;
							discount.cashCouponList = data.content.cashCouponList;
							discount.productCouponList = data.content.productCouponList;
							if(identityT == 0){
								discount.guide = 1;
							}

							document.getElementById('elseDiscount').innerHTML = template('elseDiscountTpl', discount);
							plus.nativeUI.closeWaiting();
							carculate();
							$('#firstLebi').val(ctlebi);
							if(data.content.leBi) {
								var ctlebi = data.content.leBi.rebate || 0;
								$('#firstLebi').attr('data-id', data.content.leBi.quantity);
							}
							$('#changeJf input').change(function() {
								carculate();
							})
							if(identityT == 0 || identityT == 4 || identityT == 5) {
								$('.guide').show();
							}
							if(identityT == 2) {
								$('.manager').show();
							}
							//券
							$(".checkQuan").click(function() {
								var cashCouponsList = [];
								var qid = $(this).attr("data-id");
								var curCoupon = $(this);
								if(curCoupon.find(".quanc").css("display") == "block") {
									curCoupon.find(".quanc").css("display", "none").removeClass('hasChoosed');
								} else {
									curCoupon.find(".quanc").css("display", "block").addClass('hasChoosed');

								};

								$(".quanc").each(function() {
									if($(this).css("display") == "block") {
										coupon_id = $(this).attr("data-id");
										cashCouponsList.push({
											"id": coupon_id,
											"qty": 1
										})
									}
								})
								var quantity = $('#firstLebi').attr('data-id');
								var rebate = $('#firstLebi').val();
								var totalOrderAmount = Number($('#firstTotal').val()) - Number($('#freight').html().replace('¥', ''));
//								alert(totalOrderAmount)
								var lebi = {
									"id": userId,
									"cusId": customerId,
									"quantity": quantity,
									"rebate": rebate
								};
								//选券 返回金额
								mui.ajax(serverUrl + '/app/order/reEnter/ccp', {
									data: {
										"userId": userId,
										"identityType": identityT,
										"customerId": customerId,
										"totalOrderAmount": totalOrderAmount,
										"leBi": lebi,
										"couponsList": cashCouponsList,
										"goodsList":JSON.parse(idobj),
									},
									dataType: 'json',
									type: 'post',
									timeout: 10000,
									headers: {
										"Authorization": oldToken,
										'Content-Type': 'application/json'
									},
									success: function(data, type, xhr) {
										console.log('选取优惠券返回', data);
										if(data.code == 0 && data.content) {

											$('#couponDiscount').val(data.content.couponDiscount);
											if(data.content.lebi) {
												$('#itMinus span').html('¥' + data.content.lebi.rebate)
											}
											carculate();
										} else {
											curCoupon.find(".quanc").css("display", "none");
											mui.toast(data.message);
										}
									},
									error: function(xhr, type, errorThrown) {
										console.log('响应失败  !');
									}
								});
							})
							if(data.content.totalOrderAmount) {
								$('#firstTotal').val(data.content.totalOrderAmount)
								$('#totalOrderAmount').html('¥' + data.content.totalOrderAmount)
							} else {
								$('#totalOrderAmount').html('0')
							}
							if(identityT == 6) {
								if(data.content.preDeposit) {
									$('#preDepositb').html('¥' + data.content.preDeposit)
								} else {
									$('#preDepositb').html('¥' + 0)
									$('#preDepositb').next().hide()
								}
							} else {
								if(data.content.storePreDeposit) {
									$('#preDepositb').html('¥' + data.content.storePreDeposit)
								} else {
									$('#preDepositb').html('¥' + 0)
									$('#preDepositb').next().hide()
								}
							}
							if(data.content.storeCreditMoney) {
								$('#credit').html('¥' + data.content.storeCreditMoney)
							} else {
								$('#credit').html('¥' + 0);
								$('#credit').next().hide()
							}
							if(data.content.creditMoney) {
								$('#creditVal').html('¥' + data.content.creditMoney)
							} else {
								$('#creditVal').html('¥' + 0);
								$('#creditVal').next().hide()
							}
							if(data.content.storeSubvention) {
								$('#cash').html('¥' + data.content.storeSubvention)
							} else {
								$('#cash').html('¥' + 0);
								$('#cash').next().hide()
							}

						} else {
							if(data.content && data.content.totalGoodsInfo){
								//显示商品
								var goods = data.content.totalGoodsInfo;

								dataObj.totalQty = data.content.totalQty;
								dataObj.totalPrice = data.content.totalPrice;
								dataObj.list = goods;
								document.getElementById('cartData').innerHTML = template('cartTpl', dataObj);
								if(data.content.totalPrice) {
									$('#totalPriceb').html('¥' + data.content.totalPrice)
								} else {
									$('#totalPriceb').html('0')
								}
								if(data.content.memberDiscount) {
									$('#memberDiscount').html('-¥' + data.content.memberDiscount)
								} else {
									$('#memberDiscount').html('0')
								}
								if(data.content.orderDiscount) {
									$('#orderDiscount').html('-¥' + data.content.orderDiscount);
									$('#firstOrderDiscount').val(data.content.orderDiscount)
								} else {
									$('#orderDiscount').html('0')
								}
								if(data.content.freight) {
									$('#freight').html('¥' + data.content.freight)
									$('#firstFreight').val(data.content.freight)
								} else {
									$('#freight').html('0')
									$('#firstFreight').val(0)
								}
								if(data.content.totalOrderAmount) {
									$('#firstTotal').val(data.content.totalOrderAmount)
									$('#totalOrderAmount').html('¥' + data.content.totalOrderAmount)
									$('.totalMoney').html('¥' + data.content.totalOrderAmount)
								} else {
									$('.totalMoney').html(0)
									$('#totalOrderAmount').html('0')
								}
								if(data.content.upstairsFee) {
									$('#upstar').html('¥' + data.content.upstairsFee)
								}
								if(data.content.isShowNumber) {
									$('#isShowNumber').show()
									$('#isShowNumber').attr('data-id',1)

								}else{
									$('#isShowNumber').hide()
									$('#isShowNumber').attr('data-id',0)
								}
							}
							mui.toast(data.message);
							$('.goOrder').unbind('click')
							plus.nativeUI.closeWaiting();

						}
					},
					error: function(xhr, type, errorThrown) {
						console.log('响应失败  !');
						plus.nativeUI.closeWaiting();

					}
				});
			}


			//刷新地址
			document.addEventListener('readdstorage', function(event) {
				orderAdd()
			});

			console.log('audnoAddrObj ',plus.storage.getItem("audnoAddrObj"))
			if(plus.storage.getItem("audnoAddrObj") && plus.storage.getItem("auditNo")){
				var addrObj = {};
				addrObj.obj = [JSON.parse(plus.storage.getItem("audnoAddrObj"))];
				document.getElementById("add_info").innerHTML = template("addrTpl", addrObj);
			}else{
				orderAdd();
			}
			//显示地址
			function orderAdd() {
				//默认地址
				mui.ajax(serverUrl + '/app/user/deliveryAddress/default', {
					data: {
						userId: userId,
						identityType: identityT
					},
					dataType: 'json',
					type: 'post',
					timeout: 10000,
					headers: {
						"Authorization": oldToken
					},
					success: function(data, type, xhr) {
						console.log('默认地址', data);
						var addrObj = {};
						if(data.code == 0 && data.content) {
							if(plus.storage.getItem("$addressStorageOrder") != null) {
								addrObj.obj = JSON.parse(plus.storage.getItem("$addressStorageOrder"));
							} else {
								var defultAddress = {};
								defultAddress.id = data.content.id;
								defultAddress.person = data.content.deliveryName;
								defultAddress.phone = data.content.deliveryPhone;
								defultAddress.province = data.content.deliveryProvince;
								defultAddress.city = data.content.deliveryCity;
								defultAddress.country = data.content.deliveryCounty;
								defultAddress.street = data.content.deliveryStreet;
								defultAddress.villageName = data.content.villageName;
								defultAddress.address = data.content.detailedAddress;
								addrObj.obj = [defultAddress];
							}
							document.getElementById("add_info").innerHTML = template("addrTpl", addrObj);
							plus.storage.removeItem("$addressStorageOrder")

						} else {
							console.log('缓存地址', data);
							addrObj.obj = JSON.parse(plus.storage.getItem("$addressStorageOrder")) || [];
							document.getElementById("add_info").innerHTML = template("addrTpl", addrObj);

						}
					},
					error: function(xhr, type, errorThrown) {
						console.log('响应失败  !');
					}
				});
			}
			function getLebi(money){
				mui.ajax(serverUrl+'/app/paymentMethods/rebate/lebi',{
					data:{
						userId:userId,
						identityType:identityT,
						goodsMoney:money
					},
					dataType:'json',
					type:'post',
					timeout:10000,
					headers:{"Authorization":oldToken},
					success:function(data,type,xhr){
						plus.nativeUI.closeWaiting();
						console.log('抵用乐币',data);
				       	if(data.code == 0){
					     	if(data.content){
					     		if(data.content.rebate) {
									$('#itMinus span').html('¥' + data.content.rebate)
								}else{
									$('#itMinus span').html('¥' + 0)

								}
					     		if(data.content.quantity) {
									$('#totalJfen').html(data.content.quantity)
								}
							}
				       	}
				       	plus.nativeUI.closeWaiting();
					},
					error:function(xhr,type,errorThrown){
						plus.nativeUI.closeWaiting();
						console.log('当前网络不好,请重试');
					}
				});
			}
			//自提 获取门店
			$("input[name='peis']").change(function() {
//				getMaterial();
				var delivery = $("input[name='peis']:checked").val();
				var goodsId = '';
				mui.each(JSON.parse(allGoods), function(index, item) {
					if(index == JSON.parse(allGoods).length - 1) {
						goodsId += item.id
					} else {
						goodsId += item.id + ','
					}
				})
				if(delivery == 1) {
					//查询门店
					mui.ajax(serverUrl + '/app/settlement/get/selfTakeStore/available', {
						data: {
							userId: userId,
							identityType: identityT,
							goodsIds: goodsId
						},
						dataType: 'json',
						type: 'post',
						timeout: 10000,
						headers: {
							"Authorization": oldToken,
						},
						success: function(data, type, xhr) {
							console.log('获取门店', data);
							var addrObj = {};
							if(data.code == 0 && data.content && data.content.isSelfTakePermitted) {
								$('#chooseStore').show();
								$('#add_info,.isowndis,#cityResult').hide();
								$('#freight').html('¥0');
								//合计
								carculate();
								getLebi($('#totalOrderAmount').html().replace('¥', ''));
								if(data.content.storeList.length == 1){
									var storeStr = '<option checked data-addr="' + data.content.storeList[0].detailedAddress + '" value="' + data.content.storeList[0].storeId + '">' + data.content.storeList[0].storeName + '</option>'
									var storeId = data.content.storeList[0].storeId;
									$('#chooseStore select').html(storeStr);
									var curselect = $('#chooseStore select');
									//请求门店库存
									mui.ajax(serverUrl + '/app/settlement/selfTakeStore/choose', {
										data: {
											"userId": userId,
											"identityType": identityT,
											"storeId": storeId,
											"goodsList": allGoods
										},
										dataType: 'json',
										type: 'post',
										timeout: 10000,
										headers: {
											"Authorization": oldToken
										},
										success: function(data) {
											console.log('门店库存', data);
											if(data.code == 0) {
												var address = curselect.find('option:checked').attr('data-addr')
												if(address) {
													$('#storeAddress').show();
													$('.storeAddress').html(address)
												} else {
													$('#storeAddress').show();
													$('.storeAddress').html('无地址')
												}
												$('.dsje').hide();
											} else {
												if(identityT != 6){$('.dsje').show();}
												var message = data.message || '包含不支持自提商品';
												$('#chooseStore,#storeAddress').hide();
												$('#add_info,.isowndis,#cityResult').show();
												$('#freight').html('¥' + $('#firstFreight').val());
												mui.toast(message);
												$("input[name='peis']").eq(0).attr('checked', false)
												$("input[name='peis']").eq(1).prop('checked', true)
											}
										},
										error: function(xhr, type, errorThrown) {
											if(identityT != 6){$('.dsje').show();}
											plus.nativeUI.closeWaiting();
											console.log('响应失败');
										}
									});
								}else{
									var storeStr = '<option value="">选择</option>';
									for(var i = 0; i < data.content.storeList.length; i++) {
										storeStr += '<option data-addr="' + data.content.storeList[i].detailedAddress + '" value="' + data.content.storeList[i].storeId + '">' + data.content.storeList[i].storeName + '</option>'
									}
									$('#chooseStore select').html(storeStr);
									$('#chooseStore select').change(function() {
										var storeId = $(this).val();
										var curselect = $(this)
										//请求门店库存
										mui.ajax(serverUrl + '/app/settlement/selfTakeStore/choose', {
											data: {
												"userId": userId,
												"identityType": identityT,
												"storeId": storeId,
												"goodsList": allGoods
											},
											dataType: 'json',
											type: 'post',
											timeout: 10000,
											headers: {
												"Authorization": oldToken
											},
											success: function(data) {
												console.log('门店库存', data);
												if(data.code == 0) {
													var address = curselect.find('option:checked').attr('data-addr')
													if(address) {
														$('#storeAddress').show();
														$('.storeAddress').html(address)
													} else {
														$('#storeAddress').show();
														$('.storeAddress').html('无地址')
													}
													$('.dsje').hide();
												} else {
													$('#add_info').show();
													$('#chooseStore').hide();
													$('#freight').html('¥' + $('#firstFreight').val());
													if(identityT != 6){$('.dsje').show();}
													mui.toast(data.message);
													curselect.find('option').eq(0).attr('selected', true);
												}
											},
											error: function(xhr, type, errorThrown) {
												if(identityT != 6){$('.dsje').show();}
												plus.nativeUI.closeWaiting();
												console.log('响应失败');
											}
										});
									})
								}

							} else {
								$('#chooseStore').hide();
								$('#freight').html('¥' + $('#firstFreight').val());

								if(identityT != 6){$('.dsje').show();}
								var message = data.message || '包含不支持自提商品'
								mui.toast(message);
								$("input[name='peis']").eq(0).attr('checked', false)
								$("input[name='peis']").eq(1).prop('checked', true)
							}
						},
						error: function(xhr, type, errorThrown) {
							console.log('响应失败  !');
						}
					});


				} else {
					if(identityT != 6){$('.dsje').show();}
					$('#chooseStore,#storeAddress').hide();
					$('#add_info,.isowndis,#cityResult').show();
					$('#freight').html('¥' + $('#firstFreight').val());
					carculate();
					getLebi($('#totalOrderAmount').html().replace('¥', ''));

				}
			})
			//重新计算价格
			var orderAll, memberDiscount, orderDiscount, freight, couponDiscount, credit, cash, creditVal, cashHelp, preDepositb, lebi;

			function carculate() {
				orderAll = $('#totalPriceb').html().replace('¥', ''); //订单金额
				memberDiscount = $('#memberDiscount').html().replace('-¥', ''); //会员折扣
				orderDiscount = $('#orderDiscount').html().replace('-¥', ''); //订单折扣
				freight = $('#freight').html().replace('¥', ''); //运费
				couponDiscount = $('#couponDiscount').val(); //优惠券折扣
				credit = $('input[name="credit"]').val(); //信用金
				cash = $('input[name="cash"]').val(); //现金返利
				creditVal = $('input[name="creditVal"]').val(); //信用额度
				cashHelp = $('input[name="cashHelp"]').val(); //代收金额
				preDepositb = $('input[name="preDepositb"]').val(); //预存款
				if($('#changeJf').find("input[type='checkbox']:checked").length == 1) {
					lebi = $('#itMinus').text().replace('¥', '')
				} else {
					lebi = 0
				}
				var payTotal = Number(orderAll) - Number(memberDiscount) - Number(orderDiscount) + Number(freight) - Number(couponDiscount) - Number(lebi);
				var curTotal = Number(orderAll) - Number(memberDiscount) - Number(orderDiscount) + Number(freight) - Number(couponDiscount) - Number(lebi) - Number(credit) - Number(cash) - Number(creditVal) - Number(preDepositb);
				//				alert(orderAll + ' ' + memberDiscount + ' ' + orderDiscount + ' ' + freight + ' ' + couponDiscount + " " + lebi);
				if(payTotal<0){
					payTotal = 0
				}
				if(curTotal<0){
					curTotal = 0
				}
				$('#totalOrderAmount').html(parseFloat(payTotal).toFixed(2))
				$('.totalMoney').html(parseFloat(curTotal).toFixed(2))
				return parseFloat(curTotal).toFixed(2);
			}
			//获取城市
			var cityId = plus.storage.getItem('userCity');
			//获取时间段
			timeRanges();

			function timeRanges() {
				mui.ajax(serverUrl + '/app/city/get/deliveryTime', {
					data: {
						cityId: cityId
					},
					dataType: 'json',
					type: 'post',
					timeout: 10000,
					headers: {
						"Authorization": oldToken
					},
					success: function(data, type, xhr) {
						console.log('获取时间段', data);
						var dataObj = {};
						if(data.code == 0) {
							if(data.content && data.content.length) {
								var cityData = [];
								var cflag = 0;
								mui.each(data.content, function(index, item) {
									var eachday = {};
									eachday.children = [];
									eachday.text = item.day;
									mui.each(item.deliveryTime, function(index2, item2) {
										if(!cflag) {
											if(item2) {
												cflag = 1;
												$('#cityResult .pstime').html(item.day + " " + item2)
											}
										}

										eachday.children.push({
											'text': item2
										})
									})
									cityData.push(eachday)
								})
								console.log('cityData ', cityData);
								var cityPicker = new mui.PopPicker({
									layer: 2
								});
								cityPicker.setData(cityData);
								var cityResult = document.getElementById('cityResult');
								cityResult.addEventListener('tap', function(event) {
									cityPicker.show(function(items) {
										$('#cityResult').attr('data-id', '1');
										if(!items[1].text) {
											mui.alert('当天无可选时间段')
										} else {
											$('#cityResult .pstime').html(items[0].text + " " + items[1].text)
										}

									});
								}, false);
								//-----------------------------------------
							}
							plus.nativeUI.closeWaiting();
						} else {
							mui.toast(data.message);
							plus.nativeUI.closeWaiting();

						}
					},
					error: function(xhr, type, errorThrown) {
						console.log('响应失败  !');
						plus.nativeUI.closeWaiting();

					}
				});
			}
			//支付
			$('.goOrder').unbind('click').click(function() {
				event.stopPropagation();
				var endCur = carculate();
				if(endCur >= 0){
					var deliveryType, bookingStoreId, bookingStoreName, bookingStoreAddress,
					receiver, receiverPhone, deliveryCity, deliveryCounty, deliveryStreet, residenceName, detailedAddress, deliveryTime, isOwnerReceiving, auditNo = plus.storage.getItem('auditNo') || '', remark;
					remark = $('#remark').val();
					var delivery = $("input[name='peis']:checked").val();
					deliveryType = (delivery == 1) ? "SELF_TAKE" : "HOUSE_DELIVERY";
					if(deliveryType == "SELF_TAKE") {
						var storeId = $('#chooseStore select').val();
						if(!storeId) {
							mui.toast('还未选择门店！');
							return;
						} else {
							bookingStoreId = storeId;
							bookingStoreName = $('#chooseStore option:selected').text();
							bookingStoreAddress = $('.storeAddress').html();
							deliveryTime = '';
							isOwnerReceiving = true;
						}
					} else {
						var addid = $('#addid').attr('data-receiver');
						if(!addid) {
							mui.toast('还未选择收货地址哦！');
							return;
						} else {
							receiver = $('#addid').attr('data-receiver'),
							receiverPhone = $('#addid').attr('data-receiverPhone'),
							deliveryCity = $('#addid').attr('data-deliveryCity'),
							deliveryCounty = $('#addid').attr('data-deliveryCounty'),
							deliveryStreet = $('#addid').attr('data-deliveryStreet'),
							residenceName = $('#addid').attr('data-residenceName'),
							detailedAddress = $('#addid').attr('data-detailedAddress');
							if(!$('#cityResult .pstime').html()) {
								mui.toast('还未选择配送时间哦！');
								return;
							} else {
								deliveryTime = $('#cityResult .pstime').html();
							}
							isOwnerReceiving = $('.isOwnerReceiving').prop('checked') == true ? true : false;
						}
					}
					var salesNumber = ''
					if($('#isShowNumber').attr('data-id') == 1 && $('#isShowNumber input').val() == ''){
						mui.toast("请填写纸质销货单号");
						return;
					}else{
						salesNumber = $('#isShowNumber input').val();
					}
					var goodsInfo = onlyGoods; //商品 （普通商品 料单商品）
					var cashCouponIds = []; //优惠券
					if(identityT == 6) {
						var cusPreDeposit = preDepositb;
						var stPreDeposit = 0;
					} else {
						var cusPreDeposit = 0;
						var stPreDeposit = preDepositb;
					}
					if($('#changeJf').find("input[type='checkbox']:checked").length == 1) {
						var leBiQuantity = $('#totalJfen').text();
					} else {
						var leBiQuantity = 0
					}
					var billingInfo = {
						"orderDiscount": orderDiscount,
						"leBiQuantity": leBiQuantity,
						"freight": freight,
						"cusPreDeposit": cusPreDeposit,
						"stPreDeposit": stPreDeposit,
						"empCreditMoney": creditVal,
						"storeCreditMoney": credit,
						"storeSubvention": cash,
						"collectionAmount": cashHelp
					}; //账单明细
					console.log('账单明细', billingInfo)
					$('.hasChoosed').each(function(index) {
						cashCouponIds.push(parseInt($(this).attr('data-id')))
					})
					console.log('优惠券使用', cashCouponIds)
					var deliveryInfo = {
						"deliveryType": deliveryType,
						"bookingStoreId": bookingStoreId,
						"bookingStoreName": bookingStoreName,
						"bookingStoreAddress": bookingStoreAddress,
						"receiver": receiver,
						"receiverPhone": receiverPhone,
						"deliveryCity": deliveryCity,
						"deliveryCounty": deliveryCounty,
						"deliveryStreet": deliveryStreet,
						"residenceName": residenceName,
						"detailedAddress": detailedAddress,
						"deliveryTime": deliveryTime,
						"isOwnerReceiving": isOwnerReceiving
					};
					console.log('deliveryInfo ', deliveryInfo);
					console.log('订单参数', {
						"cityId": cityId,
						"identityType": identityT,
						"userId": userId,
						"customerId": customerId,
						"remark": remark,
						"goodsInfo": goodsInfo,
						"productCouponInfo": productCouponList,
						"promotionInfo": promotionInfo,
						"deliveryInfo": JSON.stringify(deliveryInfo),
						"cashCouponIds": JSON.stringify(cashCouponIds),
						"auditNo": auditNo,
						"billingInfo": JSON.stringify(billingInfo),
					})
					plus.nativeUI.showWaiting();
					//创建订单
					mui.ajax(serverUrl + '/app/order/create', {
						data: {
							"cityId": cityId,
							"identityType": identityT,
							"userId": userId,
							"customerId": customerId,
							"remark": remark,
							"goodsInfo": goodsInfo,
							"productCouponInfo": productCouponList,
							"promotionInfo":promotionInfo,
							"deliveryInfo": JSON.stringify(deliveryInfo),
						 	"cashCouponIds":JSON.stringify(cashCouponIds),
							"auditNo": auditNo,
							"billingInfo": JSON.stringify(billingInfo),
							"salesNumber":salesNumber
						},
						dataType: 'json',
						type: 'post',
						timeout: 10000,
						headers: {
							"Authorization": oldToken
						},
						success: function(data) {
							console.log('创建订单返回', data);
							if(data.code == 0) {
								mui.fire(plus.webview.getWebviewById('center.html'),'OrderNumR');
								mui.fire(plus.webview.getWebviewById('page/goodList.html'), 'refresh');
								mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
								mui.fire(plus.webview.getWebviewById('cart'), 'refresh');
								mui.fire(plus.webview.getWebviewById('goodList'),'refresh');
								mui.fire(plus.webview.getWebviewById('gxbList'),'refresh');
								mui.fire(plus.webview.getWebviewById('oilFast.html'),'refresh');
								mui.fire(plus.webview.getWebviewById('waterFast.html'),'refresh');
								mui.fire(plus.webview.getWebviewById('electricFast.html'),'refresh');
								mui.fire(plus.webview.getWebviewById('woodFast.html'),'refresh');
								mui.fire(plus.webview.getWebviewById('tileFast.html'),'refresh');
								mui.fire(plus.webview.getWebviewById('collect'),'refresh');
								mui.fire(plus.webview.getWebviewById('ofenBuy'),'refresh');
								mui.fire(plus.webview.getWebviewById('specialGoods'),'refreshsd');
								mui.fire(plus.webview.getWebviewById('hotGoods'),'refresh');
								mui.fire(plus.webview.getWebviewById('history'),'refresh');
								if(data.content.isCashDelivery){
									$('#facePay').show();
								}else{
									$('#facePay').hide();
								}
								if(data.content.isPayUp == false) {
									$('#payMoney').html('¥' + data.content.amountPayable);
									$('#maskInfo').fadeIn(200);
									toPay(data.content.amountPayable, data.content.orderNumber);
								}else{
									mui.toast('订单提交成功！！！')
									openview({
										view: 'orderSuccess.html',
										id: 'orderSuccess',
										extrasobj:{
											orderNo:data.content.orderNumber,
											money:0
										}
									})
	//								openview({
	//									view: '../personal/myOrderList.html',
	//									id: 'myOrderList'
	//								})
									setTimeout(function() {
										if(plus.webview.getWebviewById("order")) {
											plus.webview.getWebviewById("order").close();
										}
										if(plus.webview.getWebviewById("chooseGift")) {
											plus.webview.getWebviewById("chooseGift").close();
										}
										if(plus.webview.getWebviewById("chooseCustom")) {
											plus.webview.getWebviewById("chooseCustom").close();
										}
									}, 800)
								}

								plus.nativeUI.closeWaiting();
							} else {
								plus.nativeUI.closeWaiting();
								mui.toast(data.message);
							}
						},
						error: function(xhr, type, errorThrown) {
							plus.nativeUI.closeWaiting();
							console.log('响应失败');
						}
					});

					function toPay(payableAmount, orderNumber) {

						document.getElementById('facePay').setAttribute('onclick', 'facePayF("' + payableAmount + '","' + orderNumber + '")');

						//系统检测获取支付通道
						plus.payment.getChannels(function(channels) {
							console.log("channel " + JSON.stringify(channels));
							for(var i in channels) {
								var channel = channels[i];
								// 过滤掉不支持的支付通道：暂不支持360相关支付
								if(channel.id == 'qhpay' || channel.id == 'qihoo') {
									continue;
								}
								pays[channel.id] = channel;
								if(channel.id == 'alipay') { //添加支付事件
									document.getElementById('alipay').setAttribute('onclick', 'payfun("alipay","' + payableAmount + '","' + orderNumber + '")');
								}
								if(channel.id == 'wxpay') {
									document.getElementById('wxpay').setAttribute('onclick', 'payfun("wxpay","' + payableAmount + '","' + orderNumber + '")');
								}
								checkServices(channel);
							}
						}, function(e) {
							plus.nativeUI.alert("支付失败，请重试", null, "提示");
						});

						// 检测是否安装支付服务
						function checkServices(pc) {
							if(!pc.serviceReady) {
								var txt = null;
								switch(pc.id) {
									case "alipay":
										txt = "检测到系统未安装“支付宝快捷支付服务”，无法完成支付操作，是否立即安装？";
										break;
									default:
										txt = "系统未安装“" + pc.description + "”服务，无法完成支付，是否立即安装？";
										break;
								}

							}
						}
						//系统检测获取支付通道结束
					}
					// 支付方法
					//1 货到付款
					window.facePayF = function(payableAmount,orderNumber){
						mui.ajax(serverUrl + '/app/order/handle/cashDelivery', {
							data: {
								userId: userId,
								identityType: identityT.toString(),
//								amountPayable: payableAmount,
								orderNumber: orderNumber,
							},
							type: 'post', //HTTP请求类型
							headers: {
								"Authorization": oldToken
							},
							timeout: 10000, //超时时间设置为10秒；
							success: function(data) {
								console.error(data);
								plus.nativeUI.closeWaiting();
								if(data.code == 0) {
									openview({
										view: 'orderSuccess.html',
										id: 'orderSuccess',
										extrasobj:{
											orderNo:orderNumber,
											money:payableAmount,
										}
									})
									setTimeout(function() {
										if(plus.webview.getWebviewById("order")) {
											plus.webview.getWebviewById("order").close();
										}
										if(plus.webview.getWebviewById("chooseGift")) {
											plus.webview.getWebviewById("chooseGift").close();
										}
										if(plus.webview.getWebviewById("chooseCustom")) {
											plus.webview.getWebviewById("chooseCustom").close();
										}
									}, 800)
								}else{
									plus.nativeUI.alert("支付失败");
								}

							},
							error: function(xhr, type, errorThrown) {
								//异常处理；
								console.log(type);
							}
						});
					}
					//2微信 支付宝
					window.payfun = function(id, payableAmount, orderNumber) {
						var varpay;
						if(id == 'alipay' || id == 'wxpay') {
							//调用支付功能
							plus.nativeUI.showWaiting();
							gopay(id, payableAmount, orderNumber);
						} else {
							plus.nativeUI.alert("当前环境不支持此支付通道！", null, "提示");
							return;
						}

						function gopay(id, payableAmount, orderNumber) {
							if(id == 'wxpay') {
								//微信
								mui.ajax(serverUrl + '/app/wechatpay/order/pay', {
									data: {
										userId: userId,
										identityType: identityT.toString(),
										amountPayable: payableAmount,
										orderNumber: orderNumber,
									},
									type: 'post', //HTTP请求类型
									headers: {
										"Authorization": oldToken
									},
									timeout: 10000, //超时时间设置为10秒；
									success: function(data) {
										console.error(data);
										plus.nativeUI.closeWaiting();
										if(data.code == 0) {
											varpay = {
												"appid": data.content.appid,
												"noncestr": data.content.noncestr,
												"package": "Sign=WXPay",
												"partnerid": data.content.partnerid,
												"prepayid": data.content.prepayid,
												"timestamp": parseInt(data.content.timestamp),
												"sign": data.content.sign
											};
											//微信
											plus.payment.request(pays[id], varpay, function(result) {
												console.log("----- 支付成功 -----");
												var result = JSON.stringify(result);
												openview({
													view: 'orderSuccess.html',
													id: 'orderSuccess',
													extrasobj:{
														orderNo:orderNumber,
														money:payableAmount,
													}
												})
												setTimeout(function() {

													if(plus.webview.getWebviewById("order")) {
														plus.webview.getWebviewById("order").close();
													}
													if(plus.webview.getWebviewById("chooseGift")) {
														plus.webview.getWebviewById("chooseGift").close();
													}
													if(plus.webview.getWebviewById("chooseCustom")) {
														plus.webview.getWebviewById("chooseCustom").close();
													}
												}, 800)
											}, function(e) {
												console.log("----- 支付失败 -----");
												console.log("[" + e.code + "]：" + e.message);
												plus.nativeUI.alert("支付失败");
											});
										}

									},
									error: function(xhr, type, errorThrown) {
										//异常处理；
										console.log(type);
										console.log("----- 请求订单失败 -----");
										console.log(xhr.status);
										plus.nativeUI.closeWaiting();
										plus.nativeUI.alert("获取订单信息失败！");
									}
								});
							} else {
								//支付宝
								mui.ajax(serverUrl + '/app/alipay/order/pay', {
									data: {
										userId: userId,
										identityType: identityT.toString(),
										payableAmount: payableAmount,
										orderNumber: orderNumber,
									},
									type: 'post', //HTTP请求类型
									headers: {
										"Authorization": oldToken
									},
									timeout: 10000, //超时时间设置为10秒；
									success: function(data) {
										console.error(data);
										plus.nativeUI.closeWaiting();
										if(data.code == 0) {
											varpay = data.content;
											plus.payment.request(pays[id], varpay, function(result) {
												console.log("----- 支付成功 -----", JSON.stringify(result));
												plus.nativeUI.closeWaiting();
												plus.nativeUI.alert("支付成功");
												var result = JSON.stringify(result);
												openview({
													view: 'orderSuccess.html',
													id: 'orderSuccess',
													extrasobj:{
														orderNo:orderNumber,
														money:payableAmount,

													}
												})
												setTimeout(function() {
													if(plus.webview.getWebviewById("order")) {
														plus.webview.getWebviewById("order").close();
													}
													if(plus.webview.getWebviewById("chooseGift")) {
														plus.webview.getWebviewById("chooseGift").close();
													}
													if(plus.webview.getWebviewById("chooseCustom")) {
														plus.webview.getWebviewById("chooseCustom").close();
													}
												}, 800)

												//
											}, function(e) {
												console.log("----- 支付失败 -----");
												console.log("[" + e.code + "]：" + e.message);
												plus.nativeUI.closeWaiting();
												plus.nativeUI.alert("支付失败");
											});
										}

									},
									error: function(xhr, type, errorThrown) {
										//异常处理；
										console.log(type);
										console.log("----- 请求订单失败 -----");
										console.log(xhr.status);
										plus.nativeUI.closeWaiting();
										plus.nativeUI.alert("获取订单信息失败！");
									}
								});

							}
						}

					}
				}



			})
		})
		$('#maskInfo li').click(function() {
			event.stopPropagation()
		})
		$('.closeMask').click(function() {
			event.preventDefault();

			$('#maskInfo').fadeOut(200);
			openview({
				view: '../personal/myOrderList.html',
				id: 'myOrderList'
			})
			setTimeout(function() {
				if(plus.webview.getWebviewById("order")) {
					plus.webview.getWebviewById("order").close();
				}
				if(plus.webview.getWebviewById("chooseGift")) {
					plus.webview.getWebviewById("chooseGift").close();
				}
				if(plus.webview.getWebviewById("chooseCustom")) {
					plus.webview.getWebviewById("chooseCustom").close();
				}
			}, 800)
		})

		Array.prototype.unique1 = function() {
			var res = [this[0]];
			for(var i = 1; i < this.length; i++) {
				var repeat = false;
				for(var j = 0; j < res.length; j++) {
					if(this[i] == res[j]) {
						repeat = true;
						break;
					}
				}
				if(!repeat) {
					res.push(this[i]);
				}
			}
			return res;
		}
	</script>

</html>