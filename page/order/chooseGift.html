<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>领赠品</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css" />
		<link rel="stylesheet" href="../../css/resetY.css">
		<link rel="stylesheet" type="text/css" href="../../css/cart.css" />
		<link rel="stylesheet" type="text/css" href="../../css/style.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/configW.css"/>
	</head>

	<body>

		<header class="mui-bar mui-bar-nav">
			<a class="headbar mui-action-back mui-icon mui-icon-left-nav mui-pull-left normalSize"></a>
			<h1 class="mui-title">领赠品</h1>
		</header>
		<!--<script src="js/statusBar.js"></script>-->
		<!--状态栏-->
		<div style="height:50px;"></div>
		<div class="flexwc">
			<div class="cartOne">
				<img src="../../img/check1.png"/>
				下料清单
			</div>
			<div class="cartSecond">
				<img src="../../img/check2.png"/>
				选赠品
			</div>
			<div class="cartOne">
				<img src="../../img/check1.png"/>
				结算
			</div>
		</div>
		<div id="cartData"></div>
		<script type="text/html" id="cartTpl">
			<%if(list.length==0){%>
			<div>
				<img src="img/market/blankCart.png" style="width:30%;margin: auto;display: block;margin-top: 40%;" alt="" />
				<div style="color: #666;text-align: center;margin-top: 30px;font-size: 14px;">无可选赠品</div>
			</div>

			<%}else{%> 
			<dl class="cart">
			 	<%for(var i = 0 ;i < list.length ; i++){%>
					<dd>
						<div class="mui-checkbox" style="top: 30%;">
							<input name="checkbox" type="checkbox" data-id='<%=list[i].goodsId%>'></div>
						<a class="goodsPic"><img src="<%=list[i].coverImageUri%>" onerror="javascript:this.src='../../img/editset.png';" /></a>
						<div class="goodsInfor">
							<h2 class="ft14">  
								    <a><%=list[i].skuName%></a>
								    <%if(list[i].isGift){%>
							    			<em class="mui-badge mui-badge-danger mui-pull-right" style="color: white;">赠品</em>
							    		<%}%>
								   </h2>
							<div class="priceArea">
								<div class="extraBrief ft13">
									单位：<%=list[i].goodsUnit%>；规格：
									<%=list[i].goodsSpecification%>
								</div>
								<strong>¥<span class="price"><%=list[i].retailPrice%></span></strong>
								<div class="numberWidget">
									<div class="mui-numbox" data-numbox-min='1'>
										<button class="mui-btn mui-btn-numbox-minus" type="button">-</button>
										<input class="mui-input-numbox" data-id="<%=list[i].goodsId%>" value="<%=list[i].qty%>" type="number" />
										<button class="mui-btn mui-btn-numbox-plus" type="button">+</button>
									</div>
								</div>
							</div>
	
						</div>
						
					</dd>
					
				<%}%>
				
				
			</dl>
			<%}%>
			 
			<!--bottom nav-->
			<div style="height:1rem;"></div>
			<aside class="btmNav" id="dibu">
				<a class="dp" style="position: relative;color: #f63d43;">
					<span style="color: #333333;">可选赠品5件，已选</span><span class="totalMoney">0</span>件
				</a>
				<a class="goOrder dp" style="background:#f53c42;color:white;text-shadow:none;">下一步
				</a>
				<a class="delBtnAll" style="background:#ff6910;color:white;text-shadow:none;display: none;">删除
				</a>
			</aside> 
		</script>

		<script type="text/javascript" src="../../js/jquery_cart.js"></script>
		<script src="../../js/mui.min.js"></script> 
		<script src="../../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/default.js" type="text/javascript" charset="utf-8"></script>
	</body>

	<script>
		mui.plusReady(function() {
			//获取缓存
			var identityT = JSON.parse(plus.storage.getItem("$identityType")).identityType;
			var userId = plus.storage.getItem('$userId'); 
			var oldToken = plus.storage.getItem('oldToken');
			var idobj = plus.storage.getItem('materialList') || '[]';
			window.addEventListener('refresh', function(event) {
				cartload();
			});

			cartload();

			function cartload() {
				plus.nativeUI.showWaiting();
				//获取赠品
				mui.ajax(serverUrl+'/app/gift/list',{
					data:{
						userId:userId,
						identityType:identityT,
						goodsArray:idobj
					},
					dataType:'json',
					type:'post',
					timeout:1000,
					headers:{"Authorization":oldToken},
					success:function(data,type,xhr){
						console.log('获取赠品',data);
						var dataObj = {};
						if(data.code == 0 && data.content){
							if(data.content.goodsList && data.content.goodsList.length){
								document.getElementById('cartData').innerHTML = template('cartTpl',{list:data.content.goodsList});
								plus.nativeUI.closeWaiting();
								mui('.mui-numbox').numbox()
								
								//单个 选择
								$('dl dd .mui-checkbox').click(function() {
									var allLength = $("dd").length;
									var length = $(this).parentsUntil("#cartData").find("dd").length;
									var checkLength = $(this).parentsUntil("#cartData").find("input[type='checkbox']:checked").length;
									var ALLcheckLength = $("dd").find("input[type='checkbox']:checked").length;
									if($(this).find("input").prop('checked') == false) {
										$(this).parentsUntil("#cartData").find(".groupCheck").attr("checked", false);
										$('aside input').attr("checked", false);
										countFuc();
									} else {
										if(length == checkLength) {
											$(this).parentsUntil("#cartData").find(".groupCheck").attr("checked", true);
										}
										if(ALLcheckLength == allLength) {
											$('aside input').attr("checked", true);
										}
										countFuc();
									}
				
								})
								
								//下一步
								$('.goOrder').click(function() {
									var ALLcheckLength = $("dd").find("input[type='checkbox']:checked").length;
									var idobj = JSON.parse(plus.storage.getItem('materialList') || '[]');
									if(ALLcheckLength > 0){
										var gift = [];
										//存缓存
										$("dd").find("input[type='checkbox']:checked").each(function(index) {
											gift.push({
												id: $(this).attr('data-id'),
												num: $(this).parent().parent().find('.mui-input-numbox').val(),
												isGift: true
											})
										})
										var newList = idobj.concat(gift);
										plus.storage.setItem('orderGoodsList', JSON.stringify(newList));
										
									}else{
										plus.storage.setItem('orderGoodsList', JSON.stringify(idobj));
									}
									
									if(identityT == 3){
										openview({
											view:'workerMaterial.html',
											id:'workerMaterial'
										})
								 	}else{
								 		openview({
											view:'order.html',
											id:'order',
										})
								 	}
								})
							}else{
								plus.nativeUI.closeWaiting();
								
							}
							
						}else{
							mui.toast(data.message);
							plus.nativeUI.closeWaiting();
							
						}
					},
					error:function(xhr,type,errorThrown){
						console.log('响应失败  !');
						plus.nativeUI.closeWaiting();
						
					}
				}); 
				//数量选择 
				$('.mui-numbox input').on('change', function() {
					countFuc();

				})
				//计算总价和总数量
				function countFuc() {
					var fen = 0; //总份数
					var pay = 0; //总金额 
					$("dd").find("input[type='checkbox']:checked").each(function() {
						//当前数量
						var num = parseInt($(this).parentsUntil('#cartData').find("input[type='number']").val());
						fen += num;
					})
					//赋值 
					$(".totalMoney").html(fen);
				}
				
			 
			}

		})
	
		$('.numberWidget,.mui-numbox button,.mui-numbox input').click(function() {
			event.stopPropagation()
		})
		Array.prototype.unique1 = function() {
			var res = [this[0]];
			for(var i = 1; i < this.length; i++) {
				var repeat = false;
				for(var j = 0; j < res.length; j++) {
					if(this[i] == res[j]) {
						repeat = true;
						break;
					}
				}
				if(!repeat) {
					res.push(this[i]);
				}
			}
			return res;
		}
	</script>

</html>