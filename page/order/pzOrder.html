<!DOCTYPE html>
<html lang="zh-CN">

	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>拍照下单</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/commonY.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css" />
		<link rel="stylesheet" type="text/css" href="../../css/configW.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/youxd.css"/>
	</head>
	<style type="text/css">
		.disbg{border:none}
		.uppics div.onepic input{width:0;height:0;position:absolute;outline:0}
		#fangshi{padding-top: 8px;padding-left: 15px;}
		.mui-checkbox, .mui-radio { display: inline-block;}
		#fangshi span{line-height: 40px;float: left;}
		.dizhis{padding: 10px;}
		.dizhis div{padding:  5px 0;position: relative;}
		.dizhis div img{position: absolute;right: 0;top: 20px;width: 30px;}
		.isYezhu{margin-top: 10px;}
		.isYezhu .tishi{color: #afaeae;padding: 0 15px;font-size: 14px;padding-left: 36px;}
		.beizhu{margin-top: 20px;}
		.beizhu h5{padding-left: 15px;font-size: 16px;color: #555;}
		#main{margin-top: 49px;}
		.disablecl{color: #555;}
		.mui-checkbox input[type=checkbox]:before, .mui-radio input[type=radio]:before {font-size: 20px;}
		.mui-checkbox input[type=checkbox], .mui-radio input[type=radio] {top: 10px;}
		#BZCon{margin: 15px;width: calc(100% - 30px);border: none;background-color: #eee;height: 90px;}
		.baocun{width: calc(100% - 30px);background-color: #B62D29;color: #fff;border: none;font-size: 16px;padding: 10px 20px;}
		.mui-btn .mui-spinner{position: relative;top: -5px;}
	</style>

	<body style="background-color: white;">
		<header class="mui-bar mui-bar-nav fineB" id="header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize back"></a>
			<h1 class="mui-title findUser">拍照下单</h1>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->

		<div id="main">
		    <div class="uppics clearfix" id="uppics2">
		        <div class="onepic newActionWrap">
		        		<a class="newAction2"><img id="nowpic" style="width: 90%;height: 89%;margin-left: 12%;" onclick="showAction()" src="../../img/addpic.png"></a>
		        </div>
		    </div>

		    <div id="fangshi">
		    		<span id="">
		    			配送方式：
		    		</span>
				<div class="mui-input-row mui-radio mui-left">
					<label>送货上门</label>
					<input name="radio1" checked type="radio">
				</div>
		    </div>


		    <!--地址-->
		    <div id="add_info" class="dizhis fineB fineT"></div>
			<script type="text/html" id="addrTpl">
				<h4 style="color: #c7161e;margin-bottom: -4px;">选择地址</h4>
				<%if(obj.length==0){%>
				<div class="qtop flexr pad10" onclick="addAddress()">
					<div style="flex: 1;margin-left: 5px;padding-right: 30px;">
						<div class="maincl ft16">
							<span class="disablecl"></span>
							<span class="disablecl"></span>
						</div>
						<div class="ft16">
							<span class="disablecl">请选择收获地址</span>
						</div>
						<img src="../../images/center/right.svg" alt="" />
					</div>

				</div>
				<%}else{%>
					<div class="qtop flexr pad10" onclick="addAddress()" id="addid" data-id="<%=obj[0].id%>" data-receiver="<%=obj[0].person%>" data-receiverPhone="<%=obj[0].phone%>" data-deliveryCity="<%=obj[0].city%>" data-deliveryCounty="<%=obj[0].country%>" data-deliveryStreet="<%=obj[0].street%>" data-residenceName="<%=obj[0].villageName%>" data-detailedAddress="<%=obj[0].address%>">
						<div style="flex: 1;margin-left: 5px;padding-right: 30px;">
							<div class="maincl ft16">
								<span class="disablecl"><%=obj[0].person%></span>
								<span class="disablecl"><%=obj[0].phone%></span>
							</div>
							<div class="ft16">
								<span class="disablecl"><%=obj[0].province%><%=obj[0].city%><%=obj[0].country%><%=obj[0].street%><%=obj[0].villageName%><%=obj[0].address%></span>
							</div>
							<img src="../../images/center/right.svg" alt="" />
						</div>
					</div>

				<%}%>
			</script>
			<!--地址结束-->

		    <div class="isYezhu">
				<div class="mui-input-row mui-checkbox mui-left" style="margin-left: -7px;">
				  <label>是否业主收货</label>
				  <input name="checkbox1" value="Item 1" type="checkbox">
				</div>
				<div class="tishi">
					温馨提示：若收货人为主家，系统将在出货打印单中自动隐藏折扣信息
				</div>
		    </div>
		    <div id="">

		    </div>
		    <div class="beizhu">
		    		<!--<h5>备注</h5>-->
				<textarea id="BZCon" name="" rows="" placeholder="备注请输入备注信息" cols=""></textarea>
		    </div>
		    <div id="" style="text-align: center;">
		    		<button type="button" data-loading-text="提交中..." class="mui-btn  mui-btn-primary baocun">提交</button>
		    </div>


		</div>

		<div id='container' style="display:none"></div>
	</body>



<script src="../../js/jquery.min.js"  type="text/javascript"></script>
<script src="../../js/mui.min.js"></script>
<script src="../../js/default.js"></script>
<script src="../../js/mui.zoom.js"></script>
<script src="../../js/mui.previewimage.js"></script>
<script src="../../js/artTemplate-native.js"></script>
<script type="text/javascript">

	//从相册中选择图片 开始
	var Apic = [],time1 = null,maxNum = 5;
	function getImage(){//拍照并保存
		var cmr = plus.camera.getCamera();
		cmr.captureImage( function ( path ) {
			plus.io.resolveLocalFileSystemURL(path,function(entry){
				path = plus.io.convertLocalFileSystemURL(path);
				if(0!=path.indexOf("file://")){path="file://"+path;}
		    		var nowpic = Math.random().toString(36).substr(2) + '.jpg';
		    		var endpic = path.split('.')[0]+"/"+nowpic;
				plus.zip.compressImage({//压缩方法
					src:path,
					dst:endpic,
					overwrite:true,
					quality:30
				},
				function(obj) {
					showImg(obj.target);
					Apic.push(obj.target);
				},function(error) {
					mui.toast('图片获取错误，请重试');
				});
			});
		}, function ( e ) {
		}, {filename:"_doc/gallery/",index:1} );
	}

	function galleryImgsSelected(){//从相册中选择图片
		mui.plusReady(function(){
		    plus.gallery.pick( function(e){
			    	clearInterval(time1);
			    	var indexNum = 0;
			    	var indexMax = e.files.length - 1;
			    	time1 = setInterval(function(){
			    		if(0!=e.files[indexNum].indexOf("file://")){e.files[indexNum]="file://"+e.files[indexNum];}
			    		if(indexNum == indexMax){//全部压缩完毕
			    			clearInterval(time1),time1 = null;
			    		}
			    		var nowpic = Math.random().toString(36).substr(2) + '.jpg';//随机字符串
			    		var endpic = e.files[indexNum].split('.')[0]+"/" +nowpic;
			    		console.log(e.files[indexNum]);
			    		console.log(endpic);
		    			plus.zip.compressImage({
						src:e.files[indexNum],
						dst:endpic,
						overwrite:true,
						quality:30
					},
					function(obj) {
						Apic.push(obj.target);
						showImg(obj.target,indexNum);
					},function(error) {
						console.log(error)
						mui.toast('图片获取错误，请重试');
					});
			    		indexNum ++;
			    	},500)
		    }, function ( e ) {
		    },{filter:"image",multiple:true,maximum:maxNum-Apic.length,system:false,onmaxed:function(){//保存选择记录
		    		mui.alert('最多选择'+maxNum+'张图片！');
		    }});
		})
	}
	function showImg(url,indexNum){//显示图片
		if(0!=url.indexOf("file://")){url="file://"+url;}
		if($('.newAction').length){
			$('.newAction').eq($('.newAction').length-1).after('<a class="newAction"><img data-preview-src="" data-preview-group="1" src="'+url+'"/><span onclick="closePic(this)" class="mui-icon mui-icon-closeempty"></span></a>');
		}else{
			$('.onepic').prepend('<a class="newAction"><img data-preview-src="" data-preview-group="1" src="'+url+'"/><span onclick="closePic(this)" class="mui-icon mui-icon-closeempty"></span></a>');
		}
	}
	function closePic(obj){
		var nowPic = $(obj).parentsUntil('.newActionWrap').find('img').attr('src');
		console.log($(obj).parent().html())
		$(obj).parent().remove();
		if(Apic.indexOf(nowPic)>-1){
			Apic.splice($.inArray(nowPic,Apic),1);
		}
	}
	function showAction(){
		if(Apic.length  < maxNum){
			mui.plusReady(function(){
				plus.nativeUI.actionSheet({
					cancel: "取消",
					buttons: [{
						title: "相册选择"
					}, {
						title: '拍照'
					}]
				},
				function(e) {
					if (e.index == 1) { //点击从相册选择
						galleryImgsSelected();
					} else if (e.index == 2) {
						getImage();
					}
				})

			})
		}else{
			mui.alert('最多选择'+maxNum+'张图片！');
		}

	}
	//从相册中选择图片结束

	function addAddress() {
		mui.plusReady(function(){
			var oneId = plus.webview.currentWebview().oneId;//导购的 客户id

			openview({
				view: '../personal/address.html',
				id: 'address',
				extrasobj: {
					page: 'order',
					ConeId:oneId,
					CidentityT:6,
					goType:'pzOrder'
				}
			})
		})

	}

	mui.plusReady(function(){
		var userId = plus.storage.getItem('$userId');
		var oldToken = plus.storage.getItem("oldToken");
		var identityT = JSON.parse(plus.storage.getItem("$identityType")).identityType;
		var oneId = plus.webview.currentWebview().oneId || userId;//导购的 客户id(如果没有就是直接打开页面，不是由导购帮助顾客下单。)

		//选择后 刷新地址
		window.addEventListener('readdstorage', function(event) {
			orderAdd();
		});
		//显示地址 与 选择地址
		orderAdd();
		function orderAdd(){
			mui.ajax(serverUrl+'/app/user/deliveryAddress/default',{
				data:{
					userId:oneId,
					identityType:6
				},
				dataType:'json',
				type:'post',
				timeout:10000,
				headers:{"Authorization":oldToken},
				success:function(data,type,xhr){
					console.log('默认地址',data);
					var addrObj = {};
					if(data.code == 0){
						if(plus.storage.getItem("$addressStorageY2") != null) {
							addrObj.obj = JSON.parse(plus.storage.getItem("$addressStorageY2"));
						}else{
							if(data.content){
								var defultAddress ={};
									defultAddress.id = data.content.id;
									defultAddress.person = data.content.deliveryName;
									defultAddress.phone = data.content.deliveryPhone;
									defultAddress.province = data.content.deliveryProvince;
									defultAddress.city = data.content.deliveryCity;
									defultAddress.country = data.content.deliveryCounty;
									defultAddress.street = data.content.deliveryStreet;
									defultAddress.villageName = data.content.villageName;
									defultAddress.address = data.content.detailedAddress;
									addrObj.obj = [defultAddress];
							}else{
								//没有默认地址,就去添加
								addrObj.obj = [];
							}
						}
						document.getElementById("add_info").innerHTML = template("addrTpl", addrObj);
						plus.storage.removeItem("$addressStorageY2");

					}else{
						mui.toast(data.message);
					}
				},
				error:function(xhr,type,errorThrown){
					console.log('响应失败  !');
				}
			});

		}

		//发送 发布
		$('.baocun').click(function(){
		 	var BZCon = mui('#BZCon')[0].value;//备注
			var deliveryId = $('#addid').attr('data-id');
		 	if(!Apic.length){
		 		mui.toast('请选择至少一张图片');
		 	}else if(time1 != null){
		 		mui.toast('图片还在处理中');
		 	}else if(!deliveryId){
		 		mui.toast('请添加一个地址');
		 	}else{
		 		releaseData();
		 	}

		 	//发送数据
		 	function releaseData(){
		 		mui('.baocun').button('loading');
				var task = plus.uploader.createUpload(serverUrl+'/app/photoOrder/add',
					{ method:"POST"},
					function(back,status){
						if(status == 200){
							if(plus.webview.getWebviewById('chooseCustom2')){
								plus.webview.getWebviewById('chooseCustom2').close();
							}
							console.log("发送返回",back.responseText);
							var dataobj = JSON.parse(back.responseText);
							if(dataobj.code == 0){
								alert('您的订单已提交，客服会尽快跟您联系！')
								openview({
									view:'../personal/pzOrderList.html',
									id:'pzOrderList'
								})
								var loadClose = setTimeout(function(){
									mui('.baocun').button('reset');//关闭等待框
									plus.webview.currentWebview().close();
								},1000)
	    						}else{
	    							mui.toast(dataobj.message);
	    							mui('.baocun').button('reset');//关闭等待框
	    						}
						}else{
							mui('.baocun').button('reset');//关闭等待框
							mui.toast('当前网络不好，请重试！');
						}

					}
				);
				task.setRequestHeader('Authorization',oldToken);
				task.addData("userId",userId.toString());
				task.addData("identityType",identityT.toString());
				task.addData("deliveryId",deliveryId.toString());//地址id
				task.addData("isOwnerReceiving",'1');//是否主家
				task.addData("remark",BZCon);//备注
				task.addData("customerId",oneId.toString());//导购的 客户id

				if(Apic.length){
					console.log(Apic);
					[].forEach.call(Apic,function(ele,index){
						task.addFile(ele, {key:index.toString()});
						//task.addFile(ele, {key:'myfiles'});
						if(index == Apic.length-1){
							task.start();
						}
					})
				}else{
					task.start();
				}

		 	}//发送数据结束

		})

	})


</script>
<script type="text/javascript">
	mui.previewImage();
</script>
</html>