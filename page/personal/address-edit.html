<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<title>编辑地址</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/commonY.css">
		<link rel="stylesheet" type="text/css" href="../../css/indexY.css">
		<link rel="stylesheet" href="../../css/resetY.css">
		<link href="../../css/mui.picker.minY.css" rel="stylesheet" />
		<!--<link rel="stylesheet" type="text/css" href="../../css/commonDZ.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/cssreset-minDZ.css"/>-->

		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<!--<script type="text/javascript" src="../../js/jquery.citysYF.js"></script>-->
		<script src="../../js/default.js" type="text/javascript"></script>
		<!--引入模板引擎-->
		<script src="../../js/artTemplate-native.js" type="text/javascript"></script>
		<style type="text/css">
			.data ul li i{
				position: absolute;
				right: 10px;
			}
			.data ul li .shuru{
				margin-bottom: 0;
			}
			.chooseAd{
				text-align: left !important;
			}
			.toggle--off{
				background-color: #f53c42 !important;
			}

			.mui-btn {
				font-size: 16px;
				padding: 8px;
				margin: 3px;
			}
			#showCityPicker3{
				position: absolute;
				right: 10px;
				line-height: 49px;
				border: none;
				padding: 0;
				text-align: right;
				width: 75%;
				background-color: rgba(0,0,0,0);
			}
			.data ul li span{
				line-height: 49px;
			}
			.ui-alert{
				padding: 0;
				line-height: 50px;
				text-align: left;
				text-indent: 20px;
				font-size: 16px;
			}
			.data ul li .shuru{
				line-height: 16px;
				text-align: left;
				width: 76%;
				height: 49px;
			}
			.data ul li{
				height: 50px;
			}
			.plist ul li{
				border-bottom: 1px solid #efeff4;
			}
			.address-btn{
				border-top: none;
				border-bottom: none;
				margin-top: 4%;
			}
			.add-address .textare{
				border-bottom: none;
			}
			.redc{color: red!important;}
			.data ul li span{color: #666;}
		</style>
	</head>
	<body>
		<!--header star-->
		<header class="mui-bar mui-bar-nav hasManyCity hasManyCitytwo" style="color: #555;">
		   <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="color: #555;"></a>
		     <button class="mui-btn mui-btn-link mui-pull-right" style="line-height: 50px;color: #555;font-size: 15px;" onclick="save()">保存</button>
			<h1 class="mui-title" style="color: white;">
				编辑地址
			</h1>
			<!--<a href="javascript:;" class="fr baocun" onclick="save()">保存</a>-->
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="container">
		    <div id="main" class="mui-clearfix add-address">
		    	<div class="plist clearfloat data">
			    	<ul>
						<li class="clearfloat">
								<p class="fl">收货人  <span class="redc"> *</span></p>
								<input type="text" class="fr shuru" id="person"/>
						</li>
						<li class="clearfloat">
								<p class="fl">联系电话  <span class="redc"> *</span></p>
								<input type="number" class="fr shuru" id="phone"/>
						</li>
						<style type="text/css">
							.dizhiX{display: flex;height: auto !important;}
							.dizhiX .fl{width: 64px;}

							.dizhiX .DZp{width: 100px;}
							.dizhiX .citys{flex: 1;}
							.dizhiX select{border-bottom: 1px solid #efeff4 !important;border-radius: 0px;font-size: .15rem;color: #666;line-height: 28px;}
							#demo3 div p{position: relative;}
							#demo3 div p:after{content: '∨';position: absolute;right: 10px;color: #666;}

						</style>
						<!--<li class="clearfloat dizhiX">
							<p class="fl">所在地区 </p>
					        <div id="demo3" class="citys">
				                <div>
				                		<p><select class="provinces1" name="province"></select></p>
				                		<p><select class="citys1" name="city"></select></p>
				                		<p><select class="areas1" name="area"></select></p>
				                		<p class="townsPP" style="display: none;"><select style="border: none !important;" class="towns1" name="town"></select></p>
				                </div>
				            </div>
						</li>-->

						<li class="clearfloat" style="display: none;">
								<p class="fl">所在地区  <span class="redc"> *</span></p>
								<button id='showCityPicker3' type='button'><span class="mui-icon mui-icon-arrowdown"></span></button>
								<div id='cityResult3' class="ui-alert"><span id="province"></span><span id="city"></span><span id="area"></span></div>
						</li>
						<li class="clearfloat" onclick="goMap()" style="display: flex;align-items: center;justify-content: space-between;">
							<div class="">所在地区 <span class="redc"> *</span></div>
							<div class="" id="localadd" style="max-width: 70%;">
								点击定位
							</div>
						</li>
						<li class="clearfloat">
								<p class="fl">所在小区  <span class="redc"> *</span></p>
								<input type="text" class="fr shuru" id="xiaoquIn" placeholder="请输入所在小区" />
						</li>
					</ul>
				</div>
				<div style="padding:5px 5%;">详细地址  <span class="redc"> *</span></div>
				<textarea id="address" rows="4" class="textare box-s"></textarea><!--详细地址-->
 			</div>
		    	<div class="address-btn clearfloat">
		    		<span class="szwmr fl">设为默认</span>
		    		<a href="#" class="toggle toggle--on fr" id="acquiescence"></a>
		    	</div>

	    </div>

        <script type="text/javascript">

        </script>

	</body>

	<script src="../../js/mui.min.js"></script>
	<script src="../../js/mui.picker.minY.js"></script>
	<script src="../../js/city.data-3Y.js" type="text/javascript" charset="utf-8"></script>
	<!--模板引擎获取数据-->
	<script type="text/javascript">
			//定位
			var latitude=0;//经度
			var longitude=0;//纬度
			function goMap(){
				openview({
					view:encodeURI('addressMap.html?center='+longitude+','+latitude+'&key=8f29aefac8547821425571df8852f64b'),
					id: 'addressMap',
					extrasobj:{pageid:'address-edit',longitude:longitude,latitude:latitude}
				})
			}
			mui.plusReady(function(){
				plus.storage.removeItem('$mapStorage'); 
				
				//地图定位
				var watchId;
				function geoInf( position ) {
					var str = "";
					str += "地址："+position.addresses+"\n";//获取地址信息
					str += "坐标类型："+position.coordsType+"\n";
					var timeflag = position.timestamp;//获取到地理位置信息的时间戳；一个毫秒数；
					str += "时间戳："+timeflag+"\n";
					var codns = position.coords;//获取地理坐标信息；
					var lat = codns.latitude;//获取到当前位置的纬度；
					str += "纬度："+lat+"\n";
					var longt = codns.longitude;//获取到当前位置的经度
					str += "经度："+longt+"\n";
					var alt = codns.altitude;//获取到当前位置的海拔信息；
					str += "海拔："+alt+"\n";
					var accu = codns.accuracy;//地理坐标信息精确度信息；
					str += "精确度："+accu+"\n";
					var altAcc = codns.altitudeAccuracy;//获取海拔信息的精确度；
					str += "海拔精确度："+altAcc+"\n";
					var head = codns.heading;//获取设备的移动方向；
					str += "移动方向："+head+"\n";
					var sped = codns.speed;//获取设备的移动速度；
					str += "移动速度："+sped;
					console.log(JSON.stringify(position));
					//outLine( str );
					//alert(position.addresses);
					longitude=(position.coords.longitude).toFixed(6);
					latitude=(position.coords.latitude).toFixed(6);
					 
				}
				// 通过定位模块获取位置信息
				function getGeocode(){
					//outSet( "获取定位位置信息:" );
					plus.geolocation.getCurrentPosition( geoInf, function ( e ) {
						outSet( "获取定位位置信息失败："+e.message );
					},{geocode:true,provider:'amap'});
				}
				window.addEventListener('refreshmapstorage',function(event){ 
					ismapStorage();
				})
				ismapStorage();
				function ismapStorage(){
					var mapStorage = JSON.parse(plus.storage.getItem('$mapStorage') || '[]'); 
						 if(mapStorage.length==0){ 
						 	getGeocode();
						 } 
						 else{
						 	$('#localadd').html(mapStorage[0].adraddress)
						 	$('#xiaoquIn').val(mapStorage[0].neighborhood)
						 	$('#address').val(mapStorage[0].street+mapStorage[0].streetNumber)

						 }
				} 
			})
		</script>
	<script type="text/javascript" charset="utf-8">

		mui.plusReady(function(){

			//获取缓存
			var adId = plus.webview.currentWebview().adId; /*地址id*/
			var userId = plus.webview.currentWebview().userId;
			var identityT = JSON.parse(plus.storage.getItem("$identityType")).identityType;
			var oldToken = plus.storage.getItem('oldToken');

			mui.ajax(serverUrl+'/app/user/setting/deliveryAddress/list',{
					data:{'userId' : userId,'identityType':identityT,'page':1},
					dataType:'json',
					type:'post',
					timeout:10000,
					headers:{"Authorization":oldToken},
					success:function(data,type,xhr){
						console.log('地址列表',data);
					var thisAddArray = data.content.list;
					for (var k = 0; k < thisAddArray.length; k++) {
						if(thisAddArray[k].id == adId){
							$('#person').attr('value',thisAddArray[k].deliveryName);
							$('#phone').attr('value',thisAddArray[k].deliveryPhone);
							$('#localadd').html(thisAddArray[k].deliveryCity +thisAddArray[k].deliveryCounty +thisAddArray[k].deliveryStreet)
							$('#localadd').attr("data-id",thisAddArray[k].deliveryStreet)
							$('#province').html(thisAddArray[k].deliveryCity + " "); /*市*/
							$('#city').html(thisAddArray[k].deliveryCity + " "); /*区*/
							$('#area').html(thisAddArray[k].deliveryCounty); /*街道*/
							$('#xiaoquIn').attr('value',thisAddArray[k].villageName); /*小区*/
							$('#address').html(thisAddArray[k].detailedAddress); /*详细地址*/
							if(thisAddArray[k].isDefault){ /*显示默认地址*/
								$('#acquiescence').removeClass('toggle--on');
								$('#acquiescence').addClass('toggle--off');
							}

							//点击保存修改地址
							window.save = function(){
								var newPerson = document.getElementById('person').value;
								var newPhone = document.getElementById('phone').value;
								var newAddress = document.getElementById('address').value;
								var newProvince = '';
//								var newCity = $('.citys1 option:selected').html(); /*市*/
//								var newArea = $('.areas1 option:selected').html();/*区*/
//								var newStreet = $('.towns1 option:selected').html();/*街道*/
								var defaultAddress = $('#acquiescence').hasClass('toggle--off');//默认地址
								var newCity='';
								var newArea='';
								var newStreet = '';
								var mapStorage = JSON.parse(plus.storage.getItem('$mapStorage') || '[]'); 
								console.log('dddjj',mapStorage)
								 if(mapStorage.length){
								 	if(mapStorage[0].province){
								 		newProvince = mapStorage[0].province
								 	}
								 	if(mapStorage[0].city){
								 		newCity = mapStorage[0].city
								 	}
								 	if(mapStorage[0].district){
								 		newArea = mapStorage[0].district
								 	} 
								 	if(mapStorage[0].township){
								 		newStreet = mapStorage[0].township
								 	} 
								 }
								 newProvince = newProvince || $('#province').html();
								 newCity = newCity || $('#city').html();
								 newArea = newArea || $('#area').html();
								 newStreet = newStreet || $('#localadd').attr("data-id")
								var xiaoquIn = document.getElementById('xiaoquIn').value;

								var reg_phone = /^1((3|4|5|8|7){1}\d{1}|70)\d{8}$/;//手机号正则
								if(!reg_phone.test(newPhone)){
									$('#phone').focus();
									mui.toast('请输入正确的手机号码 !');
								}else if(!newPerson){
									$('#person').focus();
									mui.toast('收货人不能为空!');
								}else if(xiaoquIn == ''){
									mui.toast('所在小区不能为空!');
									$('#xiaoquIn').focus();
								}else if(!newStreet){
									mui.toast('所在地区不能为空!');
								}else if(newAddress == ''){
									$('#newAddress').focus();
									mui.toast('详细地址不能为空!');
								}else{
									//修改地址
									mui.ajax(serverUrl+'/app/user/setting/deliveryAddress/edit',{
										data:{'userId':userId,
											'identityType':identityT,
											'id':adId,
											'deliveryName': newPerson,
											'deliveryPhone': newPhone,
//											'deliveryProvince':newProvince,
											'deliveryCity':newCity,
											'deliveryCounty':newArea,
											'detailedAddress':newAddress,
											'deliveryStreet':newStreet,
											'villageName':xiaoquIn,
											'isDefault':defaultAddress
										},
										dataType:'json',
										type:'post',
										timeout:10000,
										headers:{"Authorization":oldToken},
										success:function(data,type,xhr){
											console.log('修改地址',data)
											if(data.code == 0){
												plus.nativeUI.alert("修改地址成功");
												mui.fire(plus.webview.getWebviewById('address'),'refreshAd');
												plus.webview.currentWebview().close();
											}else{
												mui.toast(data.message);
											}
										},
										error:function(xhr,type,errorThrown){
											console.log('响应失败  !');
										}
									});
								}
							}
						}
					}
				},
				error:function(xhr,type,errorThrown){
					console.log('响应失败  !');
				}
			});


		})();
    </script>
    <!--地址三级联动-->
    <script>
		(function($, doc) {
			$.init();
			$.ready(function() {
				//地址选择三级联动
				var cityPicker3 = new $.PopPicker({
					layer: 3
				});
				cityPicker3.setData(cityData3);
				var showCityPickerButton = doc.getElementById('showCityPicker3');
				var cityResult3 = doc.getElementById('cityResult3');
				showCityPickerButton.addEventListener('tap', function(event) {
					cityPicker3.show(function(items) {
						doc.getElementById('province').innerText = (items[0] || {}).text + " ";
						doc.getElementById('city').innerText =  (items[1] || {}).text + " ";
						doc.getElementById('area').innerText = (items[2] || {}).text + " ";
						//return false;
					});
				}, false);
			});
		})(mui, document);
	</script>
	<!--默认按钮-->
	<script type="text/javascript">
	$('.toggle').click(function(e){
		var toggle = this;
		e.preventDefault();
		$(toggle).toggleClass('toggle--on').toggleClass('toggle--off').addClass('toggle--moving');
		setTimeout(function(){
			$(toggle).removeClass('toggle--moving');
		}, 200)
	});
	</script>
</html>
