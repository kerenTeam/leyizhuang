<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>编辑资料</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/commonY.css">
		<link rel="stylesheet" type="text/css" href="../../css/indexY.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.picker.minY.css"/>
		<link rel="stylesheet" href="../../css/resetY.css">
		<style type="text/css">
			#userMessContainer{margin-top: 50px;
			}
			i{ont-style: normal;
			}
			i.container{position: relative;
			}
			i.imgContainer .upload{position: absolute;
				top:0;left:0;bottom:0;right:0;
				z-index:999;
			}
			#main{margin-bottom: 100px;
			}
			select{display: inline-block !important;
				float:right !important;
				font-size: 14px !important;
				margin-top:10px;
			}
			input{border:none !important;
			}
			.box-s{padding-left:5%;
			}
			.muibackdrop{width:80%;
				height:100px;
				padding:15px 50px;
				line-height: 30px;
				position: absolute;
				top:20%;
				left:10%;
				border:1px solid #F53C42;
				background: #ffffff;
			}
			.saveMessage{color:#FFFFFF;
				margin-right: 20px;
				line-height: 50px;
				font-size: 14px;
			}
			.muibackdrop{display: none;
			}
			.selectbtn{float: right !important;
				width: 17%;
				margin: 0;
			}
			.data ul li .shuru{margin-bottom: 0;
			}
			.data ul li img {height: 50px;
			    width: 50px;
			    border-radius: 50%;
			}
			.wx_type_img{position: relative;
			}
			.wx_type_img input#imgUpload{margin: 0;cursor: pointer;position: absolute;top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				opacity: 0;
				filter: alpha(opacity=0);
			}
			#imgUpload{display: none;
			}
			.plist ul li{
				border-bottom: none;
			}
			 .plist ul li:first-child a:after{
			 	height: 0;
			 	}
			.plist ul li a:after{
				content: '';
				display: block;
				height: 1px;
				background-color: rgba(0,0,0,0.1);
				-webkit-transform: scaleY(.5);
			}
			.renting-footer{height: 50px;}
			.data ul li .shuru{
				line-height: 14px;
			}
			.data ul li .shuru::placeholder{
				padding-top:4px;
			}
			/*.mui-bar-nav{box-shadow: none !important;}*/
		</style>
	</head>
	<body>
		<header class="mui-bar mui-bar-nav fineB">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">编辑资料</h1>
		    <a href="javascript:;" style="line-height: 50px;color:#666;font-size: 15px;" class="fr baocun" id="Preservation">保存</a>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="main">
	    	<div class="plist clearfloat data" id="userMessContainer">
				<ul>
					<li class="clearfloat touxiang">
						<a>
							<p class="fl">头像</p>
							<label>
								<span class="fr">
									<div class="text-center gray" id="preview"><img id="imghead" onclick="galleryImgsSelected()" src="../../img/editset.png" width="50" height="50"></div>
								</span>
							</label>
						</a>
					</li>
					<!--<li class="clearfloat touxiang aClick">
						<p class="fl">头像</p>
						<div class="text-center gray fr" id="preview"><img id="imghead" src="http://hiji.hifete.com:6789/Upload/useraccount/avatar/With-Continental-Comedy-Charlie-Chaplin-Head-portrait-design-Linen-cotton-pillow-decoration-hotels-Clubhouse-office-sofa.jpg_640x640.jpg" width="50" height="50"></div>
					</li>-->
					<li class="clearfloat">
						<a href="#">
							<p class="fl">昵称</p>
							<input type="text" class="fr shuru" name="" id="mynickname" placeholder="点击编辑" />
						</a>
					</li>
					<li class="clearfloat">
						<a href="#">
							<p class="fl">姓名</p>
							<input type="text" class="fr shuru" name="" id="myname" placeholder="点击编辑" />
						</a>
					</li>
					<li class="clearfloat">
						<a href="#">
							<p class="fl">性别</p>
			    				<select class="mui-btn mui-btn-block selectbtn" id="Nextbtn" dir="rtl">
								<option value="item-1">点击设置</option>
								<option value="item-2">男</option>
								<option value="item-3">女</option>
								<option value="item-4">保密</option>
							</select>
						</a>
					</li>
					<li class="clearfloat">
						<a href="#">
							<p class="fl">出生日期</p>
							<label>
								<span class="fr" id="shengri" style="color: #888;" onclick="openTime(this)">
									点击编辑
								</span>
							</label>
						</a>
					</li>
					<li class="clearfloat">
						<a href="#">
							<p class="fl">所属城市</p>
							<input type="text" class="fr shuru" disabled name="" id="isCity" />
						</a>
					</li>
					<li class="clearfloat twosp" style="display: none;">
						<a href="#">
							<p class="fl">门店</p>
							<input type="text" class="fr shuru" disabled name="" id="twosp" />
						</a>
					</li>
					<li class="clearfloat profession" style="display: none;">
						<a href="#">
							<p class="fl">工种</p>
							<span class="mui-icon mui-icon-arrowdown mui-pull-right ft16" style="top:5px;"></span> 
							<select id = "profession" style="padding: 0;direction: rtl!important;width: 120px;margin-top: 15px;">
							  <option value="">选择</option>
							</select>
						</a>
					</li>
					<li class="clearfloat sgo" style="display: none;">
						<a href="#">
							<p class="fl">门店</p>
							<span class="mui-icon mui-icon-arrowdown mui-pull-right ft16" style="top:5px;"></span> 
							<select id = "store" style="padding: 0;direction: rtl!important;width: 120px;margin-top: 15px;">
							  <option value="">选择</option>
							</select>
						</a>
					</li>
					<li class="clearfloat sgo noguide" style="display: none;">
						<a href="#">
							<p class="fl">导购</p>
							<span class="mui-icon mui-icon-arrowdown mui-pull-right ft16" style="top:5px;"></span> 
							<select id = "guide" style="padding: 0;direction: rtl!important;width: 120px;margin-top: 15px;">
							  <option value="">选择</option>
							</select>
						</a>
					</li>
				</ul>
			</div>
	    </div>

		<!--<div class="muibackdrop">
			<div class="mui-input-row">
				<h5>请选择性别</h5>
				<select name="genderChoose" class="mui-pull-right mui-input">
					<option value="男">男</option>
					<option value="女">女</option>
				</select>
			</div>
		</div>-->
	</body>
	<script src="../../js/mui.min.js"></script>
	<script src="../../js/mui.picker.min.js"></script>
	<script src="../../js/default.js" type="text/javascript" charset="utf-8"></script>
	<script src="../../js/artTemplate-native.js"></script>
	<script src="../../js/jquery.min.js"></script>
	<script type="text/javascript">
		//选择日期
		function openTime(nowthis){
			var dtPicker = new mui.DtPicker({type:'date'});
		    dtPicker.show(function (selectItems) {
		    		console.log(selectItems.value);
		    		nowthis.innerHTML = selectItems.value;
		    })
		}
		/*时间戳转换*/
		function fmtDate(obj){
		    var date =  new Date(obj);
		    var y = 1900+date.getYear();
		    var m = "0"+(date.getMonth()+1);
		    var d = "0"+date.getDate();
		    return y+"-"+m.substring(m.length-2,m.length)+"-"+d.substring(d.length-2,d.length);
		}

		mui.plusReady(function(){
			var userId = plus.storage.getItem('$userId');
			var oldToken = plus.storage.getItem("oldToken");
			var identityT = JSON.parse(plus.storage.getItem("$identityType")).identityType;
			var cityId = plus.storage.getItem('userCity');
			if(identityT == 6){
				$(".sgo").show();
				showStore();
			}else{
				$(".sgo").hide()
			}
			if(identityT == 2 || identityT == 3){
				$(".twosp").show()
			}
			if(identityT == 0 || identityT == 4 || identityT == 5){
				$('#store').attr('disabled',true)
				$('#guide').attr('disabled',true)
			}
			if(identityT == 6){
				$(".profession").show();
			}
			
			//显示既有信息
			mui.ajax(serverUrl+'/app/user/setting/get/information',{
				data:{"userId":userId,'identityType':identityT},
				type:'post',
				timeout:10000,
				headers:{"Authorization":oldToken},
				success:function(data){
					console.log('用户资料',data);
					if(data.code == 0){
						//显示头像
						if(data.content.picUrl){
							mui('#imghead')[0].src = data.content.picUrl;
						}
						//显示昵称
						if(data.content.nikeName){
							mui('#mynickname')[0].value =data.content.nikeName;
						}
						//显示姓名
						if(data.content.name){
							mui('#myname')[0].value =data.content.name;
						}
						//显示性别
						if(data.content.sex == '男'){
							mui('#Nextbtn')[0].getElementsByTagName('option')[1].selected = true;
						}else if(data.content.sex == '女'){
							mui('#Nextbtn')[0].getElementsByTagName('option')[2].selected = true;
						}else{
							mui('#Nextbtn')[0].getElementsByTagName('option')[3].selected = true;
						}
						/*显示城市*/
						if(data.content.cityName){
							mui('#isCity')[0].value = data.content.cityName;
						}else{
							mui('#isCity')[0].value = '暂无';
						}
						/*显示生日*/
						if(data.content.birthday){
							mui('#shengri')[0].innerHTML = data.content.birthday;
						}
						if(data.content.storeName){
							$('#twosp').val(data.content.storeName)
						}
						var profession = data.content.profession;
						if(identityT == 6){
							//获取工种
							mui.ajax(serverUrl + '/app/customer/get/customerProfession', {
								dataType: 'json',
								type: 'post',
								timeout: 10000,
								success: function(data, type, xhr) {
									console.log('工种列表返回', data);
									if(data.code == 0 && data.content) {
										var cityStr = '<option value="">选择</option>';
										var curpr = 0;
										for(var i in data.content) {
											cityStr += '<option value="' + i + '">' + data.content[i] + '</option>'
											
											if(profession && profession == i){
												curpr = i
											}

										}
										$('#profession').html(cityStr);
										$('#profession').val(curpr)
										
									}
								},
								error: function(xhr, type, errorThrown) {
			
								}
			
							});
						}
						
					}else{
						mui.toast(data.message);
						console.log(data.message);
					}
					plus.nativeUI.closeWaiting();
				},
				error:function(xhr,type,errorThrown){
					plus.nativeUI.closeWaiting();
					mui.toast('响应失败 ');
				}
			});
			
			function showStore(){
				//门店
				mui.ajax(serverUrl+'/app/user/setting/storeSeller/get', {
					data: {
						"userId": userId,
						"identityType": identityT,
						"cityId": cityId,
					},
					dataType: 'json',
					type: 'post',
					timeout: 10000,
					headers: {
						"Authorization": oldToken
					},
					success: function(data) {
						console.log('门店导购',data);
						if(data.code == 0 && data.content) {
							if(data.content.storeList && data.content.storeList.length){
								var storeStr = '<option value="">选择</option>';
								var curstore = 0;
								for (var i = 0;i<data.content.storeList.length;i++) {
									storeStr += '<option value="'+data.content.storeList[i].storeId+'">'+data.content.storeList[i].storeName+'</option>'
									if(data.content.storeId){
										if(data.content.storeList[i].storeId == data.content.storeId){
											curstore = i;
										}
									}
								}
								$('#store').html(storeStr);
								if(data.content.storeId){
									$('#store option').eq(curstore+1).attr('selected',true);
								}
								
								//导购
								getGuide(data.content.storeId,data.content.sellerId);
								 
								$('#store').change(function(){
									getGuide($(this).val(),0);
									
								})
							}else{
								$('#store').html('<option value="">无门店</option>');
								
							}
						}else{
							mui.toast(data.message)
						}
					},
					error: function(xhr, type, errorThrown) {
						plus.nativeUI.closeWaiting();
						console.log('门店响应失败');
					}
				});
				//导购
				function getGuide(storeid,curguide){
					mui.ajax(serverUrl+'/app/user/setting/seller/get', {
						data: {
							"userId": userId,
							"identityType": identityT,
							"storeId": storeid,
						},
						dataType: 'json',
						type: 'post',
						timeout: 10000,
						headers: {
							"Authorization": oldToken
						},
						success: function(data) {
							console.log('导购',data);
							if(data.code == 0 && data.content) {
								if(data.content && data.content.length){
									var guideStr = '<option value="">选择</option>'; 
									for (var i = 0;i<data.content.length;i++) {
										guideStr += '<option value="'+data.content[i].sellerId+'">'+data.content[i].sellerName+'</option>'
										if(data.content[i].sellerId == curguide){
											curguide = i;
										}
									}
									$('#guide').html(guideStr);
									$('#guide option').eq(curguide+1).attr('selected',true);
								}else{
									$('#guide').html('<option value="">无导购</option>');
									
								}
							}else{
								mui.toast(data.message)
							}
						},
						error: function(xhr, type, errorThrown) {
							plus.nativeUI.closeWaiting();
							console.log('导购响应失败');
						}
					});
				}
			}
		})

		/*选择图片*/
		var Apic = [];//图片存放数组
		var lfs=null;// 保留上次选择图片列表
		var time1 = null;
		function galleryImgsSelected(){//从相册中选择图片
			mui.plusReady(function(){
			    plus.gallery.pick( function(e){
			    	Apic = [];
			    	lfs=e.files;
			    	clearInterval(time1);
			    	var indexNum = 0;
			    	var indexMax = e.files.length - 1;
			    	e.files.forEach(function(){
			    		mui('#imghead')[0].src  = '../../img/Spinner.svg';
			    	})
			    	time1 = setInterval(function(){
			    		console.log(time1);
			    		if(0!=e.files[indexNum].indexOf("file://")){
							e.files[indexNum]="file://"+e.files[indexNum];//图片地址
						}
			    		if(indexNum == indexMax){//全部压缩完毕
			    			clearInterval(time1);
							time1 = null;
			    		}
			    		var nowpic = Math.random().toString(36).substr(2) + '.jpg';//随机字符串
			    		var endpic = e.files[indexNum].split('.')[0]+"/" +nowpic;
			    		//压缩方法
		    			plus.zip.compressImage({
							src:e.files[indexNum],
							dst:endpic,
							overwrite:true,
							quality:30
						},
						function(obj) {
							console.log(obj)
							Apic.push(endpic);
							showImg(endpic,indexNum);
						},function(error) {
							mui.toast('图片获取错误，请重试');
						});
			    		indexNum ++;

			    	},800)
			    }, function ( e ) {
			    },{filter:"image",multiple:true,maximum:1,selected:lfs,system:false,onmaxed:function(){//保存选择记录
	    		//},{filter:"image",multiple:true,maximum:10,system:false,onmaxed:function(){
//					plus.nativeUI.alert('最多上传9张图片');
			    }});
				function showImg(url,indexNum){//显示图片
					if(0!=url.indexOf("file://")){
						url="file://"+url;
					}
					mui('#imghead')[0].src  = url;

				}
			})
		}
		//从相册中选择图片结束

		//保存数据
		mui('#Preservation')[0].addEventListener('tap',function(){
			plus.nativeUI.showWaiting('保存中 ...',{width:'100px',height:'80px'});
			var mynickname = mui('#mynickname')[0].value || null;
			var myname = mui('#myname')[0].value || null;
			var Nextbtnval = document.getElementById("Nextbtn").options[window.document.getElementById("Nextbtn").selectedIndex].text;
			var shengri = $('#shengri').html();
			if($.trim(shengri) == "点击编辑"){
				shengri = '';
			}
			var storeId = $('#store').val();
			var guide = $('#guide').val();
			mui.plusReady(function(){
				var userId = plus.storage.getItem('$userId');
				var oldToken = plus.storage.getItem("oldToken");
				var identityT = JSON.parse(plus.storage.getItem("$identityType")).identityType;

				releaseData();
				//发送数据
			 	function releaseData(){
			 		//发送数据开始
					var task = plus.uploader.createUpload(serverUrl+'/app/user/setting/set/information',
						{ method:"POST"},
						function(back,status){
							if(status == 200){
								console.log(back.responseText);
								var dataobj = JSON.parse(back.responseText);
								if(dataobj.code == 0){
									mui.toast('修改成功');
	    							//触发跳转页面刷新
									mui.fire(plus.webview.getWebviewById('page/goodList.html'),'refresh');
									mui.fire(plus.webview.getWebviewById('center.html'),'refresh');
									mui.fire(plus.webview.getWebviewById('dispatching'),'refresh');
									if(plus.webview.getWebviewById('market-order')){
										mui.fire(plus.webview.getWebviewById('market-order'),'refresh2');
									}
									if(plus.webview.getWebviewById('center')){
										mui.fire(plus.webview.getWebviewById('center'),'refresh2');
									}
									var time2 = setTimeout(function(){
										plus.webview.currentWebview().close();
									},500)
		    						}else{
		    							plus.nativeUI.closeWaiting();//关闭等待框
		    							mui.toast(dataobj.message);
		    							plus.nativeUI.closeWaiting();
		    						}
							}else{
								plus.nativeUI.closeWaiting();//关闭等待框
								mui.toast('当前网络不好，请重试！');
							}
						}
					);

					task.setRequestHeader('Authorization',oldToken);
					if(Apic){task.addFile(Apic[0], {key:'headPic'})};/*头像*/
					task.addData('userId',userId);
					task.addData('identityType',identityT.toString());
			        task.addData('name',myname);
			        task.addData('nikeName',mynickname);
			        task.addData('storeId',storeId.toString());
			        task.addData('salesConsultId',guide.toString());
			        task.addData('profession',$('#profession').val());
			        task.addData('birthday',shengri);
			        if(Nextbtnval.indexOf('男')>-1 || Nextbtnval.indexOf('女')>-1){
			        		task.addData('sex',Nextbtnval);
			        }
					task.start();

			 	}
			 	//发送数据结束

			})
		})
		//新的图片上传方法




	</script>


</html>
