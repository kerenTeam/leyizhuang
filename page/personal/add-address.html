<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8">
		<title>新增地址</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/commonY.css">
		<link rel="stylesheet" type="text/css" href="../../css/indexY.css">
		<link rel="stylesheet" href="../../css/resetY.css">
		<link href="../../css/mui.picker.minY.css" rel="stylesheet" />

		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<!--<script type="text/javascript" src="../../js/jquery.citysYF.js"></script>-->
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/default.js" type="text/javascript"></script>
		<!--引入模板引擎-->
		<script src="../../js/artTemplate-native.js" type="text/javascript"></script>
		<style type="text/css">
			.data ul li i{
				position: absolute;
				right: 10px;
			}
			.data ul li .shuru{
				margin-bottom: 0;
			}
			.chooseAd{
				text-align: left !important;
			}
			.mui-bar-nav{
				box-shadow: none;
			}
			.mui-bar{
				height: 50px;
			}
			.mui-title,.mui-icon{
				line-height: 50px;
			}
			.mui-bar .mui-icon{
				padding: 0;
			}
			.hasManyCitytwo .baocun{
				font-size: 0.12rem;
			}
			#main{
				margin-top: 50px;
			}
			.toggle--off{
				background-color: #f53c42 !important;
			}

			.mui-btn {
				font-size: 16px;
				padding: 8px;
				margin: 3px;
			}
			.data ul li span{
				line-height: 49px;
			}
			.ui-alert{
				padding: 0;
				line-height: 50px;
				text-align: left;
				text-indent: 20px;
				font-size: 16px;
			}
			.data ul li .shuru{
				line-height: 16px;
				text-align: left;
				width: 76%;
				height: 49px;
			}
			.data ul li{
				height: 50px;
			}
			.plist ul li{
				border-bottom: 1px solid #efeff4;
			}
			.address-btn{
				border-top: none;
				border-bottom: none;
				margin-top: 4%;
			}
			.add-address .textare{
				border-bottom: none;
			}
			.redc{color: red!important;}
			.mui-btn-outlined.mui-btn-blue, .mui-btn-outlined.mui-btn-primary{color: #c7161e;border: 1px solid #c7161e;}
			#contactBtn{float: right;font-size: 15px;padding: 5px;}
			.mui-btn-primary:enabled:active{border: 1px solid #c7161e;background-color: #c7161e;}
			#cityResult3 span{color: #666;}
			.writecmt:empty:before{
			    content: attr(placeholder);
			    color:#999;
			}
			#mapguide:after{
				content: '点击定位快速选择地址';
				position: absolute;
				color: white;
				bottom: 52%;
				width: 100%;
				white-space: nowrap;
				right: -40%;
				font-size: 14px;
				margin-left: -40px;

			}
			.close {
				position: absolute;
				width: 160px;
				left: 50%;
				margin-left: -80px;
				bottom: 20%;
				padding: 10px;
				color: #fff;
				border-color: #fff;
				border-radius: 50px;
				color: white!important;
				font-size: 16px;
			}
			.curADD input{display: inline-block;width: 25%;font-size:14px;height: 30px;padding: 5px;text-align: center;margin: 0;}
		</style>
	</head>

	<body>
		<!--header star-->

		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">新增地址</h1>
		    <a href="javascript:;" style="line-height: 50px;color:#555;" class="fr baocun"  onclick="save()">保存</a>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="container">
		    <div id="main" class="mui-clearfix add-address">
		    	<div id="thisAddLi"></div>
		    	<div class="plist clearfloat data">
					<ul>
						<div style="padding: 10px 15px;line-height: 35px;font-size: 16px;color: #666;" class="fineB" id="contactDiv0">
							通讯录导入
							<button id="contactBtn" class="mui-btn mui-btn-primary mui-btn-outlined" onclick="openMail()">通讯录导入</button>
						</div>
						<li class="clearfloat">
							<p class="fl">收货人 <span class="redc"> *</span></p>
							<input type="text" class="fr shuru" id="person" placeholder="请输入收货人姓名，最多5个字符" />
						</li>
						<li class="">
							<p class="fl">联系电话 <span class="redc"> *</span></p>
							<input type="tel" class="fr shuru" id="phone" placeholder="请输入手机号码" />
						</li>
						<style type="text/css">
							.dizhiX{display: flex;height: auto !important;}
							.dizhiX .fl{width: 64px;}

							.dizhiX .DZp{width: 100px;}
							.dizhiX .citys{flex: 1;}
							.dizhiX select{border-bottom: 1px solid #efeff4 !important;border-radius: 0px;font-size: .15rem;color: #666;line-height: 28px;}
							#demo3 div p{position: relative; display: none;}
							#demo3 div p.onePP{display: block;color: #888;padding-left: 15px;}
							#demo3 div p:after{content: '∨';position: absolute;right: 10px;color: #666;}

						</style>
						<li class="clearfloat"style="display: flex;align-items: center;justify-content: space-between;height: auto;">
							<div class="">所在地区 <span class="redc"> *</span></div>
							<div style="display: none;" class="writecmt" oninput="delStorge()" id="localadd" style="width: 68%;" placeholder="请输入市区街道或者点击图标定位" style="-webkit-user-select: text;" contenteditable="true"></div>
							<div class="curADD" id="showCityPicker3" style="width: 68%;">
								<input type="text" id="provenceW"  readonly value="" placeholder="省"/> -
								<input type="text" id="cityW" value="" readonly placeholder="市"/> -
								<input type="text" id="districtW" value="" readonly placeholder="区"/>
							</div>
							<img src="../../images/marker_01.png" id="lcmap" style="width: 20px;" alt="" />
						</li>
						<li class="clearfloat">
							<p class="fl">所在街道 <span class="redc"> *</span></p>
							<input type="text" class="fr shuru" id="jieW" placeholder="填写街道，如(桂溪街道)" maxlength="20"/>
						</li>
						<li class="clearfloat" id="localaddmap">
							<p class="fl">所在小区 <span class="redc"> *</span></p>
							<input type="text" class="fr shuru" id="xiaoquIn" placeholder="填写小区" />
						</li>
					</ul>
				</div>
				<div style="padding:5px 5%;">详细地址  <span class="redc"> *</span></div>
				<textarea rows="4" id="address" placeholder="请填写详细地址，不少于5个字" class="textare box-s"></textarea>
			    	<div class="address-btn clearfloat">
			    		<span class="szwmr fl">设为默认</span>
			    		<a href="#" class="toggle toggle--on fr" id="acquiescence"></a>
			    	</div>
		    </div>
		</div>
		<div id="mapguide" style="position: fixed;top: 0;left: 0;width: 100%;bottom: 0;background: rgba(0,0,0,0.6);z-index:999;display: none;">
			<img src="../../images/index/fingler.svg" style="width: 22%;z-index: 9999;position: absolute;bottom: 48%;left: 80%;"/>
			<div id="bottgd2" style="position: fixed;top: 34%;width: 18%;height: 45px;border: 1px dashed white;right: 0;background-color: white;">
				<div style="color:;font-size: 10px;text-align: center;margin-top: 5px;">
					<img src="../../images/marker_01.png" style="width: 20px;"/>
				</div>
			</div>
			<button id='close' class="mui-btn mui-btn-warning mui-btn-outlined close">我知道了</button>

		</div>
		<script src="../../js/mui.picker.minY.js"></script>
		<script src="../../js/city.data-3.js" type="text/javascript" charset="utf-8"></script>
		<!--<script src="http://oyba5duuu.bkt.clouddn.com/city.data-3Y.js" type="text/javascript" charset="utf-8"></script>-->


		<!--默认按钮-->
		<script type="text/javascript">
			$('.back').click(function(){
				mui.back()
			})
			$('.toggle').click(function(e){
				var toggle = this;
				e.preventDefault();
				$(toggle).toggleClass('toggle--on').toggleClass('toggle--off').addClass('toggle--moving');
				setTimeout(function(){
					$(toggle).removeClass('toggle--moving');
				}, 200)
			});
		</script>

		<script type="text/javascript">
			//定位
			var latitude=0;//经度
			var longitude=0;//纬度
			var cprovince;
			document.getElementById("lcmap").addEventListener('tap', function(event) {
				plus.nativeUI.showWaiting()
//			function goMap(){
				if(!cprovince){
					mui.toast('未开启定位权限，请到设置中开启或者重试，实在不行就手动选择吧');
					plus.nativeUI.closeWaiting()
				}else{
					openview({
						view:encodeURI('addressMap.html?center='+longitude+','+latitude+'&key=8f29aefac8547821425571df8852f64b'),
						id: 'addressMap',
						extrasobj:{pageid:'add-address',longitude:longitude,latitude:latitude,province:cprovince}
					})
				}

//			}
			}, false);
			mui.plusReady(function(){
				plus.storage.removeItem('$mapStorage');

				//地图定位
				var watchId,oldLength;
				function geoInf( position ) {
					var str = "";
					str += "地址："+position.addresses+"\n";//获取地址信息
					str += "坐标类型："+position.coordsType+"\n";
					var timeflag = position.timestamp;//获取到地理位置信息的时间戳；一个毫秒数；
					str += "时间戳："+timeflag+"\n";
					var codns = position.coords;//获取地理坐标信息；
					var lat = codns.latitude;//获取到当前位置的纬度；
					str += "纬度："+lat+"\n";
					var longt = codns.longitude;//获取到当前位置的经度
					str += "经度："+longt+"\n";
					var alt = codns.altitude;//获取到当前位置的海拔信息；
					str += "海拔："+alt+"\n";
					var accu = codns.accuracy;//地理坐标信息精确度信息；
					str += "精确度："+accu+"\n";
					var altAcc = codns.altitudeAccuracy;//获取海拔信息的精确度；
					str += "海拔精确度："+altAcc+"\n";
					var head = codns.heading;//获取设备的移动方向；
					str += "移动方向："+head+"\n";
					var sped = codns.speed;//获取设备的移动速度；
					str += "移动速度："+sped;
					console.log(JSON.stringify(position));
					//outLine( str );
					//alert(position.addresses);
					longitude=(position.coords.longitude).toFixed(6);
					latitude=(position.coords.latitude).toFixed(6);
					cprovince = position.address.province;
				}
				// 通过定位模块获取位置信息
				function getGeocode(){
					//outSet( "获取定位位置信息:" );
					plus.geolocation.getCurrentPosition( geoInf, function ( e ) {
						outSet( "获取定位位置信息失败："+e.message );
					},{geocode:true,provider:'amap'});
				}
				window.addEventListener('refreshmapstorage',function(event){
					ismapStorage();
				})
				ismapStorage();
				function ismapStorage(){
					var mapStorage = JSON.parse(plus.storage.getItem('$mapStorage') || '[]');
						 if(mapStorage.length==0){
						 	getGeocode();
						 }
						 else{
						 	$('#localadd').html(mapStorage[0].adraddress)
						 	$('#provenceW').val(mapStorage[0].province)
						 	$('#cityW').val(mapStorage[0].city)
						 	$('#jieW').val(mapStorage[0].township)
						 	$('#districtW').val(mapStorage[0].district)
						 	$('#xiaoquIn').val(mapStorage[0].neighborhood)
						 	$('#address').val(mapStorage[0].street+mapStorage[0].streetNumber)

						 }
						oldLength = $('.writecmt').text().length;
				}
				window.delStorge = function(){
					if($('.writecmt').text().length < oldLength){
						plus.storage.removeItem('$mapStorage')
					}
				}
			})
		</script>
		<script type="text/javascript" charset="utf-8">
			function openMail(){
				openview({
					view: '../mailList.html',
					id: 'mailList',
					extrasobj:{htmlName:'add-address'}
				})
			}

			//导入通讯录
			document.addEventListener('resetTel',function(){
				var contactOne = JSON.parse(plus.storage.getItem('contactOne'));
				document.getElementById('person').value = contactOne[0].name;
				document.getElementById('phone').value = contactOne[0].phone;
				plus.storage.removeItem('contactOne');
			})

			mui.plusReady(function(){

				var cityPicker3 = new mui.PopPicker({
					layer: 3
				});
				cityPicker3.setData(cityData3);
				var showCityPickerButton = document.getElementById('showCityPicker3');
				showCityPickerButton.addEventListener('tap', function(event) {
					cityPicker3.show(function(items) {
						$('#provenceW').val(items[0].text)
					 	$('#cityW').val(items[1].text)
					 	$('#districtW').val(items[2].text)
						//返回 false 可以阻止选择框的关闭
						//return false;
					});
				}, false);

				//获取缓存
				plus.storage.removeItem('$mapStorage');
				var oldToken = plus.storage.getItem('oldToken');
				var userId = plus.webview.currentWebview().ConeId || plus.storage.getItem('$userId');
				var identityT = plus.webview.currentWebview().CidentityT || JSON.parse(plus.storage.getItem("$identityType")).identityType;
				var mapguide = plus.storage.getItem("mapguide");
				if(!mapguide){
					$('#mapguide').show()
				}
				document.getElementById("close").addEventListener('tap', function(event) {
					document.getElementById("mapguide").style.display = 'none';
					document.getElementById("close").style.display = 'none';
					plus.storage.setItem("mapguide", "true");
				}, false);
				//导购模式（加入通讯录导入功能）
				if(plus.webview.currentWebview().ConeId){
					$('#contactDiv0').css('display','block');
				}

				//点击保存新增地址
				window.save = function(){
					var newPerson = document.getElementById('person').value;
					var newPerson2 = $.trim(newPerson).replace(/[^\x00-\xff]/g, "**");
					var newPhone = '';
						newPhone = document.getElementById('phone').value;
					var newAddress = '';
						newAddress = document.getElementById('address').value;//详细地址
					var defaultAddress = $('#acquiescence').hasClass('toggle--off');//默认地址

					var newProvince=$('#provenceW').val();
					var newCity=$('#cityW').val();
					var newArea=$('#districtW').val();
					var newStreet = $('#jieW').val();

					var xiaoquIn = document.getElementById('xiaoquIn').value;/*小区*/

					var reg_phone =/^1[0-9]{10}$/;
					if(newPerson == ''){
						$('#person').focus();
						mui.toast('收货人不能为空!');
					}else if(newPerson2.length > 10){
						mui.toast('收货人最多输入5个汉字或者10个字母')
					}else if(!reg_phone.test(newPhone)){
						$('#phone').focus();
						mui.toast('请输入正确的手机号码 !');
					}else if(!newProvince || !newCity || !newArea){
						mui.toast('所在省市区不能为空!');
					}else if(newStreet == '' || newStreet.indexOf('街')<0){
						mui.toast('所在街道信息不正确!');
						$('#jieW').focus();
					}else if(xiaoquIn == ''){
						mui.toast('所在小区不能为空!');
						$('#xiaoquIn').focus();
					}else if(newAddress == ''){
						mui.toast('详细地址不能为空!');
						$('#newAddress').focus();
					}else{
						console.log('kk',{
								'userId': userId,
								'identityType': identityT,
								'deliveryName':newPerson,
								'deliveryPhone':newPhone,
								'deliveryProvince':newProvince,
								'deliveryCity':newCity,
								'deliveryCounty':newArea,
								'detailedAddress':newAddress,
								'deliveryStreet':newStreet,
								'villageName':xiaoquIn,
								'isDefault':defaultAddress
							})
						mui.ajax(serverUrl+'/app/user/setting/deliveryAddress/add',{
							data:{
								'userId': userId,
								'identityType': identityT,
								'deliveryName':newPerson,
								'deliveryPhone':newPhone,
								'deliveryProvince':newProvince,
								'deliveryCity':newCity,
								'deliveryCounty':newArea,
								'detailedAddress':newAddress,
								'deliveryStreet':newStreet,
								'villageName':xiaoquIn,
								'isDefault':defaultAddress
							},
							dataType:'json',
							type:'post',
							timeout:10000,
							headers:{"Authorization":oldToken},
							success:function(data,type,xhr){
								if(data.code == 0){
									plus.nativeUI.alert("添加地址成功");
									mui.fire(plus.webview.getWebviewById('address'),'refreshAd');
									plus.webview.currentWebview().close();
								}else{
									mui.toast(data.message);
								}


							},
							error:function(xhr,type,errorThrown){
								console.log('响应失败  !');
							}
						});
					}
				}
			})();
    		</script>
	</body>

</html>