<!DOCTYPE html>
<html lang="zh-CN">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>新增地址</title>
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, width=device-width">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<meta name="format-detection" content="telephone=no">
		<meta name="format-detection" content="address=no">

		<link rel="stylesheet" type="text/css" href="../../css/commonY.css">
		<link rel="stylesheet" type="text/css" href="../../css/indexY.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/resetY.css">
		<link href="../../css/mui.picker.minY.css" rel="stylesheet" />

		<script type="text/javascript" src="../../js/jquery.min.js"></script>
		<script type="text/javascript" src="../../js/jquery.citysYF.js"></script>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/hmt.js" type="text/javascript"></script>
		<script src="../../js/app.js" type="text/javascript"></script>
		<script src="../../js/default.js" type="text/javascript"></script>
		<!--引入模板引擎-->
		<script src="../../js/artTemplate-native.js" type="text/javascript"></script>
		<style type="text/css">
			.data ul li i{
				position: absolute;
				right: 10px;
			}
			.data ul li .shuru{
				margin-bottom: 0;
			}
			.chooseAd{
				text-align: left !important;
			}
			.mui-bar-nav{
				box-shadow: none;
			}
			.mui-bar{
				height: 50px;
			}
			.mui-title,.mui-icon{
				line-height: 50px;
			}
			.mui-bar .mui-icon{
				padding: 0;
			}
			.hasManyCitytwo .baocun{
				font-size: 0.12rem;
			}
			#main{
				margin-top: 50px;
			}
			.toggle--off{
				background-color: #f53c42 !important;
			}

			.mui-btn {
				font-size: 16px;
				padding: 8px;
				margin: 3px;
			}
			#showCityPicker3{
				position: absolute;
				right: 10px;
				line-height: 49px;
				border: none;
				padding: 0;
				text-align: right;
				width: 75%;
				background-color: rgba(0,0,0,0);
			}
			.data ul li span{
				line-height: 49px;
			}
			.ui-alert{
				padding: 0;
				line-height: 50px;
				text-align: left;
				text-indent: 20px;
				font-size: 16px;
			}
			.data ul li .shuru{
				line-height: 16px;
				text-align: left;
				width: 76%;
				height: 49px;
			}
			.data ul li{
				height: 50px;
			}
			.plist ul li{
				border-bottom: 1px solid #efeff4;
			}
			.address-btn{
				border-top: none;
				border-bottom: none;
				margin-top: 4%;
			}
			.add-address .textare{
				border-bottom: none;
			}
			.data ul li span{color: #666;}
		</style>
	</head>

	<body>
		<!--header star-->

		<header class="mui-bar mui-bar-nav">
		    <a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left bigSize"></a>
		    <h1 class="mui-title">新增地址</h1>
		    <a href="javascript:;" style="line-height: 50px;color:#555;" class="fr baocun"  onclick="save()">保存</a>
		</header>
		<script src="../../js/statusBar.js"></script><!--状态栏-->
		<div id="container">
		    <div id="main" class="mui-clearfix add-address">
		    	<div id="thisAddLi"></div>
		    	<div class="plist clearfloat data">
					<ul>
						<li class="clearfloat">
							<a href="#">
								<p class="fl">收货人</p>
								<input type="text" class="fr shuru" name="" id="person" value="" placeholder="请输入收货人姓名" />
							</a>
						</li>
						<li class="clearfloat">
							<a href="#">
								<p class="fl">联系电话</p>
								<input type="number" class="fr shuru" name="" id="phone" value="" placeholder="请输入手机号码" />
							</a>
						</li>
						<style type="text/css">
							.dizhiX{display: flex;height: auto !important;}
							.dizhiX .fl{width: 64px;}

							.dizhiX .DZp{width: 100px;}
							.dizhiX .citys{flex: 1;}
							.dizhiX select{border-bottom: 1px solid #efeff4 !important;border-radius: 0px;font-size: .15rem;color: #666;line-height: 28px;}
							#demo3 div p{position: relative; display: none;}
							#demo3 div p.onePP{display: block;color: #888;padding-left: 15px;}
							#demo3 div p:after{content: '∨';position: absolute;right: 10px;color: #666;}

						</style>
						<!--<li class="clearfloat dizhiX">
							<p class="fl">所在地区 </p>
					        <div id="demo3" class="citys">
				                <div>
				                		<p class="onePP">点击更换地区</p>
				                		<p class="twoPP"><select class="provinces1" name="province"></select></p>
				                		<p class="twoPP"><select class="citys1" name="city"></select></p>
				                		<p class="twoPP"><select class="areas1" name="area"></select></p>
				                		<p class="twoPP"><select class="towns1" style="border: none !important;" name="town"></select></p>
				                </div>
				            </div>
						</li>-->
						<!--<script type="text/javascript">
							$('.onePP').click(function(){
								$('.onePP').css('display','none');
								$('.twoPP').css('display','block');

							})
						</script>-->


						<li class="clearfloat">
							<a href="javascript:;" id="mapAddress">
								<p class="fl">所在地区</p>
								<button id='showCityPicker3' type='button'><span class="mui-icon mui-icon-arrowdown"></span></button>
								<div id='cityResult3' class="ui-alert"><span id="province"><b style="font-weight: 500;color: #999;">点击选择地区</b></span><span id="city"></span><span id="area"></span></div>
							</a>
						</li>
						<li class="clearfloat">
							<a>
								<p class="fl">所在小区</p>
								<input type="text" class="fr shuru" name="" id="xiaoquIn" value="" placeholder="请输入所在小区" />
							</a>
						</li>
					</ul>
				</div>
				<textarea name="" rows="4" id="address" placeholder="请填写详细地址，不少于5个字" class="textare box-s"></textarea>
			    	<!--<div class="address-btn clearfloat">
			    		<span class="szwmr fl">设为默认</span>
			    		<a href="#" class="toggle toggle--on fr" id="acquiescence"></a>
			    	</div>-->
		    </div>
		</div>

		<script src="../../js/mui.picker.minY.js"></script>
		<script src="../../js/city.data-3Y.js" type="text/javascript" charset="utf-8"></script>
		<!--<script src="http://oyba5duuu.bkt.clouddn.com/city.data-3Y.js" type="text/javascript" charset="utf-8"></script>-->
		<script>
			(function($, doc) {
				$.init();
				$.ready(function() {
					//地址选择三级联动
					var cityPicker3 = new $.PopPicker({
						layer: 3
					});
					cityPicker3.setData(cityData3);
					var showCityPickerButton = doc.getElementById('showCityPicker3');
					var cityResult3 = doc.getElementById('cityResult3');
					showCityPickerButton.addEventListener('tap', function(event) {
						cityPicker3.show(function(items) {
							doc.getElementById('province').innerText = (items[0] || {}).text + " ";
							doc.getElementById('city').innerText =  (items[1] || {}).text + " ";
							doc.getElementById('area').innerText = (items[2] || {}).text + " ";
							//返回 false 可以阻止选择框的关闭
							//return false;
						});
					}, false);
				});
			})(mui, document);
		</script>

		<!--默认按钮-->
		<script type="text/javascript">
			$('.toggle').click(function(e){
				var toggle = this;
				e.preventDefault();
				$(toggle).toggleClass('toggle--on').toggleClass('toggle--off').addClass('toggle--moving');
				setTimeout(function(){
					$(toggle).removeClass('toggle--moving');
				}, 200)
			});
		</script>
		<script type="text/javascript">
			/*四级地址*/
			var $town = $('#demo3 select[name="town"]');
            var townFormat = function(info){
                $town.hide().empty();
                if(info['code']%1e4&&info['code']<7e5){ //是否为“区”且不是港澳台地区
                    $.ajax({
                        url:'http://passer-by.com/data_location/town/'+info['code']+'.json',
                        dataType:'json',
                        success:function(town){
                            $town.show();
                            for(i in town){
                                    $town.append('<option value="'+i+'">'+town[i]+'</option>');
                            }
                        }
                    });
                }
            };
            $('#demo3').citys({
                province:'四川',
//              city:'成都',
//              area:'青羊',
                onChange:function(info){
                    townFormat(info);
                }
            },function(api){
                var info = api.getInfo();
                townFormat(info);
            });
	    		/*地址结束*/
		</script>
		<script type="text/javascript" charset="utf-8">

			mui.plusReady(function(){
				//获取缓存
				var oldToken = plus.storage.getItem('oldToken');
				var userId = plus.storage.getItem('$userId');

				var identityT = JSON.parse(plus.storage.getItem("$identityType")).identityType;
				//点击保存新增地址
				window.save = function(){
					var newPerson = document.getElementById('person').value;
					var newPhone = '';
						newPhone = document.getElementById('phone').value;
					var newAddress = '';
						newAddress = document.getElementById('address').value;//详细地址

//					var newProvince = $('.provinces1 option:selected').html();/*省*/
//					var newCity = $('.citys1 option:selected').html(); /*市*/
//					var newArea = $('.areas1 option:selected').html();/*区*/
//					var newStreet = $('.towns1 option:selected').html();/*街道*/

					var newProvince = ' ';
					var newCity = document.getElementById('province').innerHTML;
					var newArea = document.getElementById('city').innerHTML;
					var newStreet = document.getElementById('area').innerHTML;/*街道*/


					var xiaoquIn = document.getElementById('xiaoquIn').value;/*小区*/

					//默认状态判断
					if($('#acquiescence').hasClass('toggle--off')){
						var newState = 0;
					}else{
						var newState = 1;
					}
					var reg_phone = /^1((3|4|5|8|7){1}\d{1}|70)\d{8}$/;//手机号正则
					if(newPerson == ''){
						$('#person').focus();
						mui.toast('收货人不能为空!');
					}else if(!reg_phone.test(newPhone)){
						$('#phone').focus();
						mui.toast('请输入正确的手机号码 !');
					}else if(!newStreet){
						mui.toast('所在地区不能为空!');
					}else if(xiaoquIn == ''){
						mui.toast('所在小区不能为空!');
						$('#xiaoquIn').focus();
					}else if(newAddress == ''){
						mui.toast('详细地址不能为空!');
						$('#newAddress').focus();
					}else{

						mui.ajax(serverUrl+'/app/user/setting/deliveryAddress/add',{
							data:{
								'userId': userId,
								'identityType': identityT,
								'deliveryName':newPerson,
								'deliveryPhone':newPhone,
								'deliveryProvince':newProvince,
								'deliveryCity':newCity,
								'deliveryCounty':newArea,
								'detailedAddress':newAddress,
								'deliveryStreet':newStreet,
								'villageName':xiaoquIn
							},
							dataType:'json',
							type:'post',
							timeout:1000,
							headers:{"Authorization":oldToken},
							success:function(data,type,xhr){
								if(data.code == 0){
									plus.nativeUI.alert("添加地址成功");
									mui.fire(plus.webview.getWebviewById('address'),'refreshAd');
									plus.webview.currentWebview().close();
								}else{
									mui.toast(data.message);
								}

//								var newId = data.data;
								//修改地址默认状态
//								mui.ajax(serverUrl+'/api/useraccount/stateaddress',{
//									data:{userid:userId,address_id:newId,state:newState},
//									dataType:'json',
//									type:'post',
//									timeout:1000,
//									headers:{"token":oldToken},
//									success:function(data,type,xhr){
//										mui.toast("保存成功！");
//										 if(plus.webview.getWebviewById('personal/address.html')){
//										 	mui.fire(plus.webview.getWebviewById('personal/address.html'),'refreshAd');//打开指定页面
//										 }
//										 if(plus.webview.getWebviewById('../personal/address.html')){
//										 	mui.fire(plus.webview.getWebviewById('../personal/address.html'),'refreshAd');//打开指定页面
//										 }
//
//										plus.webview.currentWebview().close();//关闭当前页面
//
//	//									mui.fire(plus.webview.getWebviewById('personal/address.html'),'refreshAdo');//打开指定页面
//									},
//									error:function(xhr,type,errorThrown){
//										console.log('响应失败  !');
//									}
//								});
							},
							error:function(xhr,type,errorThrown){
								console.log('响应失败  !');
							}
						});
					}
				}
			})();
    		</script>
	</body>

</html>