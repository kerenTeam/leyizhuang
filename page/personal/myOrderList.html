<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>我的订单列表</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../css/configW.css"/>
		<link rel="stylesheet" type="text/css" href="../../css/commonY.css">
		<link rel="stylesheet" type="text/css" href="../../css/indexY.css">
		<link rel="stylesheet" type="text/css" href="../../css/mui.min.css"/>
		<link rel="stylesheet" href="../../css/resetY.css">
		<link rel="stylesheet" href="../../css/youxd.css">
		<style type="text/css">
			/*去支付样式*/
			#maskInfo {
				z-index: 99999;
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				bottom: 0;
				background-color: rgba(0, 0, 0, .5)
			}
			.paychoose {
				background-color: white;
				bottom: 0!important;
				position: absolute;
				right: 0;
				left: 0;
			}
			.paychoose img {
				width: 40px;
				margin: 0 5px;
			}
			/*去支付样式结束*/
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav fineB" style="padding-right: 15px;">
			<a id="leftbtn" class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">我的订单</h1>
			<span class="mui-icon mui-icon-search mui-pull-right" id="openSearch"></span>
		</header>
		<script src="../../js/statusBar.js"></script>
		<div id="main" style="padding-top: 48px !important;">
			<div class="notice">
				<!--tab切换-->
				<div class="tab-hd tab-hdtwo" id="tabLink">
					<ul class="tab-nav">
					  <li class="active aClick " data-statusId="">全部</li>
					  <li class="aClick" data-statusId="1">待付款</li>
					  <li class="aClick" data-statusId="1">待收货</li>
					  <li class="aClick" data-statusId="1">已完成</li>
					  <li class="aClick" data-statusId="1">已取消</li>
					</ul>
				</div>
				<!--搜索-->
				<div class="tab-hd tab-hdtwo" id="tabLink2" style="display: none;">
					<div class="searchFind">
						<span class="mui-icon mui-icon-search mui-icon-search2" id="clickSearch"></span>
						<div class="sint">
							<form id="searchf">
								<input type="search" id="valInt" class="fsearch" placeholder="订单号/收货地址">
							</form>
							<span class="back" id="cancelSearch">取消</span>
						</div>
					</div>
				</div>
				<!--列表loading-->
				<div id="loadingdiv" style="text-align: center;font-size: 14px;height:32px;margin-top: 48px;
					line-height: 30px;color: #666;-webkit-transition: all .3s;overflow: hidden;">
					<img style="width: 30px;margin-top:5px;" src="../../img/Rolling.svg"/>
				</div>
				<!--列表loading结束-->
				<div id="infoListDiv">
					<!--内容-->
				</div>
				<script id="infoList" type="text/html">
					<% if(list.length){%>
						<%for(var i=0;i<list.length;i++){%>
							<div class="orderList">
								<h3 class="h3" onclick="openDetail('<%= list[i].orderNo%>')">
									订单编号：<%= list[i].orderNo%>
									<span><%= list[i].status%></span>
								</h3>
								<p class="p1" onclick="openDetail('<%= list[i].orderNo%>')">
									<% if(list[i].goodsImgList && list[i].goodsImgList.length){%>
										<%for(var j=0; j<list[i].goodsImgList.length; j++){%>
											<a><img class="loadPics" data-src="<%= list[i].goodsImgList[j]%>"/></a>
										<%} %>
									<% }else{%>
										<a><img class="loadPics" data-src="https://b-ssl.duitang.com/uploads/item/201711/08/20171108102304_FTzw4.thumb.224_224_c.jpeg"/></a>
									<% }%>
									<% if(list[i].endTime){%>
										<span>10分钟后关闭订单</span>
									<% }%>
								</p>
								<div class="orderInfo">
									共<%= list[i].count%>件商品 合计：<span>¥ <%= list[i].price%></span>
								</div>
								<!--显示状态按钮-->
								<div class="orderBtns">
									<% if(list[i].status == '待付款'){%>

										<span class="aClick" onclick="cancelFun('<%= list[i].orderNo%>')">取消订单</span>
										<span onclick="comeOnAgain('<%= list[i].orderNo%>')" class="aClick">再来一单</span>
										<span class="redC aClick" onclick="goToPay('<%= list[i].orderNo%>','<%= list[i].price%>')">去支付</span>

									<% }else if(list[i].status == '待收货'){%>

										<span class="aClick" onclick="cancelFun('<%= list[i].orderNo%>')">取消订单</span>
										<span onclick="comeOnAgain('<%= list[i].orderNo%>')" class="aClick">再来一单</span>
										<span onclick="goOrderWL('<%= list[i].orderNo%>')" class="aClick redC">查看物流</span>

									<% }else if(list[i].status == '已完成'){%>

										<% if(list[i].isEvaluated == false){%>
											<span class="aClick" onclick="openDetail('<%= list[i].orderNo%>','evaluat')">评价</span>
										<% }%>
										<% if(list[i].customer && list[i].customer.customerId){%>
											<span class="redC aClick" onclick="openReturns('<%= list[i].orderNo%>','<%= list[i].customer.customerId%>')">退货</span>
										<% }else{%>
											<span class="redC aClick" onclick="openReturns('<%= list[i].orderNo%>','null')">退货</span>
										<% }%>
										<span onclick="comeOnAgain('<%= list[i].orderNo%>')" class="aClick">再来一单</span>
										<span onclick="goOrderWL('<%= list[i].orderNo%>')" class="redC aClick">查看物流</span>

									<% }else if(list[i].status == '已取消'){%>

										<span onclick="comeOnAgain('<%= list[i].orderNo%>')" class="aClick">再来一单</span>

									<% }%>
								</div>
							</div>
						<%}%>
					<% }else{%>
						<div style="text-align: center;padding: 50px;">
							<img src="../../images/order/order.png" style="width: 100px;" />
							<div class="ft13 disablecl">暂无数据</div>
						</div>
					<% }%>

				</script>

			</div>
		</div>

		<!--取消订单-->
		<div class="cancelDiv" id="cancelOrder" style="display: none;">
			<div class="cancelCon">
				<div class="cancelMin">
					<h4 class="fineB h4">取消原因</h4>
					<div id="cancelDiv0"></div>
					<script type="text/html" id="cancelDiv0S">
						<% for(var i=0;i<list.length;i++){%>
							<div class="mui-input-row mui-radio mui-left">
								<label><%= list[i].reason%></label>
								<input class="reasonInfo" value="<%= list[i].reason%>" name="radio1" type="radio">
							</div>
						<% }%>
					</script>
					<div class="cancelText">
						<textarea id="remarksInfo" placeholder="请输入备注内容" name="" rows="" cols=""></textarea>
					</div>
					<div class="cancelBtn">
						<button type="button" class="mui-btn operating1">取消</button>
						<button type="button" class="mui-btn mui-btn-danger operating2">确定</button>
					</div>
				</div>
			</div>
		</div>
		<!-- 去支付操作表-->
		<div id="maskInfo" style="display: none;">
			<!-- 可选择菜单 -->
			<ul class="paychoose ft14">
				<li class="fttc pad10 afterBorder ft16 activecl">
					应付金额：<span id="payMoney">---</span>
				</li>
				<li class="pad10 afterBorder" id="alipay">
					<img src="../../images/order/alipay.svg" />支付宝
				</li>
				<li class="pad10 afterBorder" id="wxpay">
					<img src="../../images/order/weixinpay.svg" />微信
				</li>
				<li class="pad10 afterBorder">
					<img src="../../images/order/bankpay.svg" />银联支付
				</li>
				<li class="closeMask fttc pad10">
					取消
				</li>
			</ul>
		</div>
		<script src="../../js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/default.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
		<script src="../../js/youxd.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			//去支付
			var pays = {};
			$('#maskInfo li').click(function() {
				event.stopPropagation();
			})
			$('.closeMask').click(function() {
				event.preventDefault();
				$('#maskInfo').fadeOut(200);
			})
			function goToPay(orderNo,money){
				$('#payMoney').html('¥' + money);
				$('#maskInfo').fadeIn(200);
				toPay(money, orderNo)
			}
			//系统检测获取支付通道
			function toPay(payableAmount, orderNumber) {
				plus.payment.getChannels(function(channels) {
					console.log("channel " + JSON.stringify(channels));
					for(var i in channels) {
						var channel = channels[i];
						// 过滤掉不支持的支付通道：暂不支持360相关支付
						if(channel.id == 'qhpay' || channel.id == 'qihoo') {
							continue;
						}
						pays[channel.id] = channel;
						if(channel.id == 'alipay') { //添加支付事件
							document.getElementById('alipay').setAttribute('onclick', 'payfun("alipay","' + payableAmount + '","' + orderNumber + '")');
						}
						if(channel.id == 'wxpay') {
							document.getElementById('wxpay').setAttribute('onclick', 'payfun("wxpay","' + payableAmount + '","' + orderNumber + '")');
						}
						checkServices(channel);
					}
				}, function(e) {
					plus.nativeUI.alert("支付失败，请重试", null, "提示");
				});

				// 检测是否安装支付服务
				function checkServices(pc) {
					if(!pc.serviceReady) {
						var txt = null;
						switch(pc.id) {
							case "alipay":
								txt = "检测到系统未安装“支付宝快捷支付服务”，无法完成支付操作，是否立即安装？";
								break;
							default:
								txt = "系统未安装“" + pc.description + "”服务，无法完成支付，是否立即安装？";
								break;
						}

					}
				}
				//系统检测获取支付通道结束
			}
			mui.plusReady(function(){
				//获取缓存
				var identityT = JSON.parse(plus.storage.getItem("$identityType")).identityType;
				var userId = plus.storage.getItem('$userId');
				var oldToken = plus.storage.getItem('oldToken');

				// 支付接口
				window.payfun = function(id, payableAmount, orderNumber) {
					var varpay;
					if(id == 'alipay' || id == 'wxpay') {
						//调用支付功能
						plus.nativeUI.showWaiting();
						gopay(id, payableAmount, orderNumber);
					} else {
						plus.nativeUI.alert("当前环境不支持此支付通道！", null, "提示");
						return;
					}

					function gopay(id, payableAmount, orderNumber) {
						if(id == 'wxpay') {
							//微信
							mui.ajax(serverUrl + '/app/wechatpay/order/pay', {
								data: {
									userId: userId,
									identityType: identityT.toString(),
									amountPayable: payableAmount,
									orderNumber: orderNumber,
								},
								type: 'post', //HTTP请求类型
								headers: {
									"Authorization": oldToken
								},
								timeout: 10000, //超时时间设置为10秒；
								success: function(data) {
									console.error(data);
									plus.nativeUI.closeWaiting();
									if(data.code == 0) {
										varpay = {
											"appid": data.content.appid,
											"noncestr": data.content.noncestr,
											"package": "Sign=WXPay",
											"partnerid": data.content.partnerid,
											"prepayid": data.content.prepayid,
											"timestamp": parseInt(data.content.timestamp),
											"sign": data.content.sign
										};
										//微信
										plus.payment.request(pays[id], varpay, function(result) {
											console.log("----- 支付成功 -----");
											var result = JSON.stringify(result);
											mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
											openview({
												view: '../personal/myOrderList.html',
												id: 'myOrderList'
											})
											setTimeout(function() {
												if(plus.webview.getWebviewById("order")) {
													plus.webview.getWebviewById("order").close();
												}
												if(plus.webview.getWebviewById("chooseGift")) {
													plus.webview.getWebviewById("chooseGift").close();
												}
											}, 2000)
										}, function(e) {
											console.log("----- 支付失败 -----");
											console.log("[" + e.code + "]：" + e.message);
											plus.nativeUI.alert("支付失败");
										});
									}

								},
								error: function(xhr, type, errorThrown) {
									//异常处理；
									console.log(type);
									console.log("----- 请求订单失败 -----");
									console.log(xhr.status);
									plus.nativeUI.closeWaiting();
									plus.nativeUI.alert("获取订单信息失败！");
								}
							});
						} else {
							//支付宝
							mui.ajax(serverUrl + '/app/alipay/order/pay', {
								data: {
									userId: userId,
									identityType: identityT.toString(),
									payableAmount: payableAmount,
									orderNumber: orderNumber,
								},
								type: 'post', //HTTP请求类型
								headers: {
									"Authorization": oldToken
								},
								timeout: 10000, //超时时间设置为10秒；
								success: function(data) {
									console.error(data);
									plus.nativeUI.closeWaiting();
									if(data.code == 0) {
										varpay = data.content;
										plus.payment.request(pays[id], varpay, function(result) {
											console.log("----- 支付成功 -----", JSON.stringify(result));
											plus.nativeUI.closeWaiting();
											plus.nativeUI.alert("支付成功");
											var result = JSON.stringify(result);
											mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
											openview({
												view: '../personal/myOrderList.html',
												id: 'myOrderList'
											})
											setTimeout(function() {
												if(plus.webview.getWebviewById("order")) {
													plus.webview.getWebviewById("order").close();
												}
												if(plus.webview.getWebviewById("chooseGift")) {
													plus.webview.getWebviewById("chooseGift").close();
												}
											}, 2000)

											//
										}, function(e) {
											console.log("----- 支付失败 -----");
											console.log("[" + e.code + "]：" + e.message);
											plus.nativeUI.closeWaiting();
											plus.nativeUI.alert("支付失败");
										});
									}

								},
								error: function(xhr, type, errorThrown) {
									//异常处理；
									console.log(type);
									console.log("----- 请求订单失败 -----");
									console.log(xhr.status);
									plus.nativeUI.closeWaiting();
									plus.nativeUI.alert("获取订单信息失败！");
								}
							});

						}
					}

				}
			})
			//去支付结束


			//再来一单
			function comeOnAgain(orderNo){
				mui.plusReady(function(){
					var identityT = JSON.parse(plus.storage.getItem("$identityType")).identityType;
					var userId = plus.storage.getItem('$userId');
					var oldToken = plus.storage.getItem('oldToken');
					mui.ajax(serverUrl + '/app/materialList/again/add',{//获取取消原因
						data:{'userId':userId,'identityType':identityT,'orderNumber':orderNo},
						dataType:'json',
						type:'post',
						timeout:10000,
						headers:{"Authorization":oldToken},
						success:function(data,type,xhr){
							console.log('再来一单',data);
							if(data.code == 0){
								mui.toast(data.message || '操作成功');
								mui.fire(plus.webview.getWebviewById('cart.html'),'refresh');
							}else{
								mui.toast(data.message || '操作失败');
							}
						},
						error:function(xhr,type,errorThrown){
							console.error('取消原因，响应失败  !');
							mui.toast('当前网络不好，请重试');
						}
					});
				})
			}

			//申请退货
			function openReturns(orderNo,cusId){
				openview({
					view:'myOrderReturns.html',
					id:'myOrderReturns',
					extrasobj:{
						orderNo:orderNo,
						cusId:cusId
					}
				})
			}
			//打开订单详情
			function openDetail(orderNo,evaluat){
				openview({
					view:'myOrderDetail.html',
					id:'myOrderDetail',
					extrasobj:{
						orderNo:orderNo,
						evaluat:evaluat
					}
				})
			}
			//打开订单物流
			function goOrderWL(orderNo){
				openview({
					view:'myOrderWL.html',
					id:'myOrderWL',
					extrasobj:{
						orderNo:orderNo
					}
				})
			}
			mui.plusReady(function(){
				//获取缓存
				var identityT = JSON.parse(plus.storage.getItem("$identityType")).identityType;
				var userId = plus.storage.getItem('$userId');
				var oldToken = plus.storage.getItem('oldToken');

				//tab切换
				loadFun('');//初始化
				$('#tabLink li').click(function(){
					$('#tabLink li').removeClass('active');
					$(this).addClass('active');
					if($(this).index() == 0){
						loadFun('');//全部
					}else if($(this).index() == 1){
						loadFun(1);//待付款
					}else if($(this).index() == 2){
						loadFun(2);//待收货
					}else if($(this).index() == 3){
						loadFun(3);//已完成
					}else if($(this).index() == 4){
						loadFun(4);//已取消
					}
				})
				function loadFun(tabT,condition){//搜索和tab切换 ，公用一个加载方法
					document.getElementById('infoListDiv').innerHTML = '';
					$('#loadingdiv').css('height','32px');
					var nowApi = '/app/order/list';
					var nowData = {'userID':userId,'identityType':identityT,'showStatus':tabT};
					if(condition){//搜索字段
						nowApi = '/app/order/search';
						nowData = {'userID':userId,'identityType':identityT,'showStatus':tabT,'condition':condition}
					}
					mui.ajax(serverUrl + nowApi,{
						data:nowData,
						dataType:'json',
						type:'post',
						timeout:10000,
						headers:{"Authorization":oldToken},
						success:function(data,type,xhr){
							console.log('订单',data);
							var timeLoad = setInterval(function(){
								clearTimeout(timeLoad),timeLoad = null;
								if(data.code == 0){
									$('#loadingdiv').css('height','0px');
									if(data.content && data.content.length){
										document.getElementById('infoListDiv').innerHTML = template('infoList',{list:data.content,nowState:tabT});
									}else{
										document.getElementById('infoListDiv').innerHTML = '<div style="text-align: center;padding: 50px;"><img src="../../images/order/order.png" style="width: 100px;" /><div class="ft13 disablecl">暂无数据</div></div>';
									}
									lazyLoad();
								}else{
									mui.toast(data.message);
								}
							},500)
						},
						error:function(xhr,type,errorThrown){
							console.log('响应失败  !');
							$('#loadingdiv').css('height','0px');
							document.getElementById('infoListDiv').innerHTML = '<div style="text-align: center;padding: 50px;"><img src="../../images/order/order.png" style="width: 100px;" /><div class="ft13 disablecl">当前网络不好，请重试</div></div>';
						}
					});
				}

				//搜索操作
				$('#openSearch').click(function(){
					$('#tabLink2').css('display','block');
					$(this).css('display','none');
				})
				$('#cancelSearch').click(function(){
					$('#tabLink2').css('display','none');
					$('#openSearch').css('display','block');
				})
				$('#searchf').submit(function(){
					var valInt = $('#valInt').val();
					loadFun('',valInt);
					return false;
				})
				$('#clickSearch').click(function(){
					var valInt = $('#valInt').val();
					loadFun('',valInt);
				})

				//取消订单
				mui.ajax(serverUrl + '/app/cancelOrder/cancelReasons',{//获取取消原因
					data:{'userId':userId,'identityType':identityT},
					dataType:'json',
					type:'post',
					timeout:10000,
					headers:{"Authorization":oldToken},
					success:function(data,type,xhr){
						console.log('取消原因',data);
						if(data.code == 0){
							document.getElementById('cancelDiv0').innerHTML = template('cancelDiv0S',{list:data.content});
						}
					},
					error:function(xhr,type,errorThrown){
						console.error('取消原因，响应失败  !');
					}
				});
				$('.operating1').click(function(){//点取消
					$('#cancelOrder').css('display','none');
				})
				$('.cancelDiv').click(function(){//点遮罩
					$('#cancelOrder').css('display','none');
				})
				$('.cancelMin').click(function(){
					event.stopPropagation();
				})
				window.cancelFun = function(orderNumber){
					var isCance = confirm(
							'1、订单一旦取消后，无法恢复。\n'+
							'2、订单取消后，已支付的金额将会在一个工作日内原路退还。\n'+
							'3、限时促销等购买优惠可能一并取消。\n'+
							'4、因商品已分拣等原因可能会导致订单取消失败。'
						);
					isCance && $('#cancelOrder').css('display','table');
					//点确定
					document.getElementsByClassName('operating2')[0].onclick = function(){
						var reasonInfo = $(".reasonInfo[type='radio']:checked").val();
						var remarksInfo = $('#remarksInfo').val();

						if(!reasonInfo){
							alert('请选择原因');
						}else{
							var dataObj = {
								'userId':userId,'identityType':identityT,
								'orderNumber':orderNumber,
								'reasonInfo':reasonInfo,'remarksInfo':remarksInfo
							};
							console.log(dataObj);
							mui.ajax(serverUrl + '/app/returnOrder/cancel/order',{//获取取消原因
								data:dataObj,
								dataType:'json',
								type:'post',
								timeout:10000,
								headers:{"Authorization":oldToken},
								success:function(data,type,xhr){
									console.log('取消订单',data);
									if(data.code == 0){
										mui.toast(data.message || '取消订单成功');
									}else{
										mui.toast(data.message);
									}
								},
								error:function(xhr,type,errorThrown){
									console.error('取消订单，响应失败  !');
								}
							});
						}
					}
				}
			})
		</script>
	</body>

</html>