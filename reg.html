<!DOCTYPE html>
<html class="ui-page-login">

	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<link href="css/mui.min.css" rel="stylesheet" />
		<link href="css/style.css" rel="stylesheet" />
		<style>
			.area {
				margin: 20px auto 0px auto;
			}
			.mui-input-group:first-child {
				margin-top: 20px;
			}
			.mui-input-group label {
				width: 32%;
			}
			.mui-input-row label~input,
			.mui-input-row label~select,
			.mui-input-row label~textarea {
				width: 68%;
			}
			.mui-checkbox input[type=checkbox],
			.mui-radio input[type=radio] {
				top: 6px;
			}
			.mui-content-padded {
				margin-top: 25px;
			}
			.mui-btn {
				padding: 10px;
			}
			.mui-input-row label~input, .mui-input-row label~select, .mui-input-row label~textarea{
				margin-top: 1px;
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title">注册</h1>
		</header>
		<div class="mui-content">
			<form class="mui-input-group">
				
				<div class="mui-input-row">
					<label>手机号</label>
					<input id='account' type="text" class="mui-input-clear mui-input" placeholder="请输入手机号">
					 
				</div>             	
                <div class="mui-input-row">
					<label style="padding:4px 12px"><button type="button" id="getCode">获取验证码</button></label>
					<input id='checkcode' type="text" class="mui-input-clear mui-input" placeholder="请输入验证码">
					 
				</div> 
				<div class="mui-input-row">
					<label>城市</label>
					<select name="city">
						<option value="1" selected>成都</option>
						<option value="2">郑州</option>
					</select>
				</div>
			</form>
				<small style="color:#FF5053;padding: 15px;font-size: 12px;">温馨提示：城市选定后无法更改！</small>
			<div class="mui-content-padded">
				<button id='sendMail' class="mui-btn mui-btn-block mui-btn-primary">注册</button>
			</div>
		</div>
		<script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/app.js"></script>
		<script>
			 
				mui.init(); 
				mui.plusReady(function() {
					var reg_phone = /^1((3|4|5|8|7){1}\d{1}|70)\d{8}$/;//手机号正则;
					var sendButton = document.getElementById('sendMail');
					var account = document.getElementById('account');
					var checkcode = document.getElementById('checkcode');
					var getCode = document.getElementById('getCode');
					var cityId = $('select option:selected').val() 
					var newpsd = document.getElementById('newpsd');
					var VerCode;
					var openId = plus.webview.currentWebview().openid;
					console.log(openId);
					
					//获取城市
					mui.ajax('http://119.23.149.7:9999/app/city/list',{
						dataType:'json',
						type:'post',
						timeout:10000,
						success:function(data,type,xhr){ 
							console.log('城市列表返回',data);
							 
						},
						error:function(xhr,type,errorThrown){
						 
						}
						
					});
					
					sendButton.addEventListener('tap', function() {
						if(!account.value || !reg_phone.test(account.value)){
							mui.toast('请输入正确的手机号')
						}else if(!checkcode.value){
							mui.toast('请输入验证码')
						}else{  
								plus.nativeUI.showWaiting();
								mui.ajax('http://119.23.149.7:9999/app/customer/registry',{//改密
								data:{"phone":account.value,"openId":openId,'cityId':cityId},
								dataType:'json',
								type:'post',
								timeout:10000,
//								headers: {"Authorization": plus.storage.getItem("oldToken")},
								success:function(data){
									console.log('注册返回',data);
									if(data.code==1000){//
										plus.nativeUI.closeWaiting();
										 mui.toast(data.message);
										 plus.webview.currentWebview().close(); 
									}else if(data.code == 0){
										plus.nativeUI.closeWaiting();
										mui.toast('注册成功'); 
										mui.ajax('http://119.23.149.7:9999/app/customer/login',{
											data:{"openId":openId},
											dataType:'json',
											type:'post',
											timeout:10000,
											success:function(data,type,xhr){ 
												console.log('登录返回',data);
												if(data.code == 0 && data.content.isExist){
													plus.nativeUI.closeWaiting();
//													plus.storage.setItem('$userId',JSON.stringify(data.content.userId))
													plus.storage.setItem('$userId','1');
//													plus.storage.setItem("$identityType",JSON.stringify({'identityType':data.content.type}));
													plus.storage.setItem("$identityType",JSON.stringify({'identityType':'6'}));
													
													plus.storage.setItem("oldToken",xhr.getResponseHeader('token'));
													plus.storage.setItem("openId",openId);
													plus.storage.removeItem('Acc_pass');
													mui.fire(plus.webview.getWebviewById('page/goodList.html'),'refresh');
													mui.fire(plus.webview.getWebviewById('center.html'),'refresh');
													var time2 = setTimeout(function(){
														var index = plus.webview.getLaunchWebview();
														mui.fire(index,'refresh');
														plus.webview.currentWebview().close(); 
														plus.nativeUI.closeWaiting();
														mui.toast('登录成功');
													},500)
												 
												}
												
											},
											error:function(xhr,type,errorThrown){
												plus.nativeUI.closeWaiting();
												console.log('登录响应失败');
											}
											
										});
							  
									}else{
										plus.nativeUI.closeWaiting();
										mui.toast(data.message); 
										plus.webview.currentWebview().close(); 
									}
								},
								error:function(xhr,type,errorThrown){
									plus.nativeUI.closeWaiting();
									console.log('修改密码响应失败');
								}
							});
								
							 
						}
						
					}, false);
					
					account.addEventListener('input', function() {
						if(reg_phone.test(account.value)){
							getCode.removeAttribute('disabled')
						}
						
					}, false);
					
					//获取验证码
					getCode.addEventListener('tap',function(){
						if(!account.value || !reg_phone.test(account.value)){
							mui.toast('请输入正确的手机号')
						}else{
							getCode.setAttribute('disabled',true);
							getCode.innerHTML = '获取中...'
							//发送验证码 
							mui.ajax('http://119.23.149.7:9999/app/qrcode/send',{
								data:{mobile:account.value}, 
								dataType:'json',
								type:'post',
								timeout:10000,
								success:function(data){
									getCode.innerHTML = '获取验证码'
									getCode.removeAttribute('disabled')
									
									console.log('发送验证码返回',data);
									mui.toast('验证码已发送');
									VerCode = data.content.smsCode; 
								}, 
								error:function(xhr,type,errorThrown){
									mui.toast('发送验证码失败');
								}
							});
						}
						
					})
				}); 
		</script>
	</body>

</html>