<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="css/commonY.css" />
		<link rel="stylesheet" href="css/style.css" />
		<link rel="stylesheet" type="text/css" href="css/configW.css" />
	</head>
	<style type="text/css">
		.vct {
			width: 90%;
			position: fixed;
			color: white;
			text-align: center;
			top: 22%;
			left: 5%;
		}

		.vct img {
			display: block;
			width: 80px;
			margin: auto;
			margin-bottom: 10px;
			vertical-align: middle;
		}

		.vct td {
			padding: 20px;
		}
		.imgpt {
			position: relative;
			width: 100%;
			padding-top: 54%;
			overflow: hidden;
		}

		.imgpt img {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
		}
		#close {
			width: 80px;
			padding: 20px;
		}


		.imgpt img {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
		}

		.clasfyItem {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			text-align: center;
			display: flex;
			display: -webkit-flex;
			align-items: center;
    			justify-content: center;
    			-webkit-justify-content: center;
			background-color: rgba(0,0,0,0.3);
			-webkit-transition: all 0.5 ease;
		}
		.clasfyItem:active{background-color: rgba(0,0,0,0.1);}
		.clasfyItem .itemName {
			color: white;
			font-size: 20px;
			font-weight: 400;
		}
		.mui-numbox {background: none!important;}

		.trangle {
			position: absolute;
			bottom: 0;
			left: 1.2rem;
			width: 0px;
			height: 0px;
			border-top: 11px solid transparent;
			border-right: 11px solid transparent;
			border-bottom: 11px solid white;
			border-left: 11px solid transparent;
		}

		.npbk ul:not(:last-of-type):after {
			position: absolute;
			content: '';
			height: 1px;
			-webkit-transform: scaleY(0.3);
			background-color: #EEEEEE;
			left: 0;
			right: 0;
			bottom: 0;
			transform-origin: bottom;
		}

		.nplist {
			width: 1.3rem;
			/*height: 1.3rem;*/
			text-align: center;
			display: inline-block;
			margin-bottom: 10px;
			/*border: 1px solid #efefef;*/
			box-shadow: 0px 0 5px 0px rgba(0, 0, 0, 0.1);
			margin-left: 5px;
		}

		.nplast {
			height: 1.3rem;
			/*text-align: center;*/
			line-height: 1.3rem;
			color: #f53c42;
			border: 1px solid #eee;
			position: absolute;
			top: 0;
		}

		.nplist h4 {
			color: black;
			font-size: 0.14rem;
			width: 1rem;
			line-height: 2;
			text-overflow: ellipsis;
			white-space: nowrap;
			overflow: hidden;
			margin: auto;
		}

		.npimg {
			position: relative;
			width: 100%;
			padding-top: 100%;
			overflow: hidden;
		}

		.npimg img {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
		}

		.nprice {
			font-size: 0.12rem;
			color: #f53c42;
			line-height: 1.5;
		}

		.titpr {
			white-space: normal;
			max-width: 100px;
			line-height: 1.5em;
			height:3em;
			word-break: break-all;
			margin-bottom: 5px;
			display: -webkit-box;
			-webkit-box-orient: vertical;
			-webkit-line-clamp: 2;
			overflow: hidden;

		}

		.titprg {
			display: block!important;
			width: 100%!important;
			max-width: none;
			height: auto
		}
		.mui-table-view:before{height: 0;}
		.typeDis{margin-bottom: 10px;}
	</style>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="headbar mui-action-back mui-icon mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title"></h1>
		</header>
		<script src="js/statusBar.js" type="text/javascript" charset="utf-8"></script>
		<div class="gocarticon" id="div2">
			<img src="images/whitecart.svg" alt="" />
			<span class="mui-badge mui-badge-white">0</span>
		</div>
		<div class="mui-content" style="padding-top: 50px;">
			<div id="classify"></div>
			<script type="text/html" id="classifyTpl">
				<%for(var i = 0 ;i < list.length ; i++){%>
				 <div class="typeDis" style="background-color: #fff;">
					<div class="imgpt">
						<img src="<%=list[i].picUrl || 'img/legray.svg'%>" alt="" />
						<div class="trangle"></div>
					</div>
					<div class="npbk">
						<div class="secClassfy">
 							<ul class="mui-table-view">
								<%if(list[i].goodsList.length){%>
						    		<%for(var j = 0 ;j<list[i].goodsList.length;j++){%>
							    		<li class="mui-table-view-cell mui-media" id="<%=list[i].goodsList[j].goodsId%>" onclick="goodsInfo(<%=list[i].goodsList[j].goodsId%>)">
									        <a href="javascript:;">
									            <img class="mui-media-object mui-pull-left" src="<%=list[i].goodsList[j].coverImageUri || 'img/editset.png'%>">
									            <div class="mui-media-body ft16">
									                <div style="word-break: break-all;white-space: normal;"><%=list[i].goodsList[j].skuName%></div>
									                <p class='mui-ellipsis ft16'>规格:<%=list[i].goodsList[j].goodsSpecification%> &nbsp;单位:<%=list[i].goodsList[j].goodsUnit%></p>
										            <span class="activecl2 ft18">¥<%=list[i].goodsList[j].retailPrice%></span>
													<%if(!list[i].goodsList[j].qty){%>
														<img style="display:inline-block;float:right;margin-left:5px;vertical-align:middle" data-id="<%=list[i].goodsList[j].goodsId%>" class="toCart" src="images/addcart.svg"/>
														<div style="display: none;float:right;" class="mui-numbox" data-numbox-step='1' data-numbox-min='0' data-numbox-max='9999'>
														  <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
														  <input class="mui-numbox-input" type="number" data-id="<%=list[i].goodsList[j].goodsId%>" value="1"/>
														  <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
														</div>
													<%}else{%>
														<div style="float:right;" class="mui-numbox" data-numbox-step='1' data-numbox-min='0' data-numbox-max='9999'>
														  <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
														  <input class="mui-numbox-input" type="number" data-id="<%=list[i].goodsList[j].goodsId%>" value="<%=list[i].goodsList[j].qty%>"/>
														  <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
														</div>
													<%}%>
									            </div>
									        </a>
									    </li>
						    		<%}%>
					    		<%}%>
							</ul>

						</div>
					</div>
				</div>
				<%}%>
			</script>
		</div>
		<!--<img id="close" src="images/order/closef.png" style="position: fixed;bottom: 10%;left: 50%;-webkit-transform: translateX(-50%);"/>-->
		<script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/mui.min.js"></script>
		<script src="js/artTemplate-native.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/default.js" type="text/javascript" charset="utf-8"></script>
		<script type="text/javascript">
			mui.init();
			$('#close').click(function() {
				plus.webview.currentWebview().close();
			})
			function goodsInfo(id) {
				openview({
					view: 'page/goodsInfo.html',
					id: 'goodsInfo',
					extrasobj: {
						goodId: id
					}
				})

			}
			mui.plusReady(function(){
				getCartNum();
				document.addEventListener('refreshct', function() {
					getCartNum();
				})
				document.addEventListener('refresh', function() {
					kindType();
				})
				var identityT = JSON.parse(plus.storage.getItem("$identityType")).identityType;
				var userId = plus.storage.getItem('$userId');
				var oldToken = plus.storage.getItem('oldToken');
				var name = plus.webview.currentWebview().listname;
				var listId = plus.webview.currentWebview().listId;
				$('.mui-title').html(name)
				plus.nativeUI.showWaiting()
				kindType();
				function kindType(){
					mui.ajax(serverUrl+'/app/act/list',{
						data:{
							userId:userId,
							identityType:identityT,
						},
						dataType:'json',
						type:'post',
						timeout:10000,
						headers:{"Authorization":oldToken},
						success:function(data,type,xhr){
							plus.nativeUI.closeWaiting();
							console.log('活动促销',data);
					       	if(data.code == 0){
						     	if(data.content && data.content.length){
						     		data.content.forEach(function(ele,index){
										if(ele.promotionId == listId){
											$('#classify').html(template('classifyTpl', {list:[data.content[index]]}));
										}
									})
						     		$('.toCart,.mui-numbox button').click(function() {
										event.stopPropagation()
									})
									mui('.mui-numbox').numbox();
									//加入购物车
									$('.toCart').unbind('click').click(function(){
										event.stopPropagation()
										var goodid = $(this).attr('data-id');
										var cur = $(this);
										plus.nativeUI.showWaiting();
										addCart(goodid,1,cur);
									})
									//数量选择 -> 加入购物车
									$('.mui-numbox input').on('change', function() {
										plus.nativeUI.showWaiting();
										var cur = $(this);
										var number = $(this).val(); //当前数量
										var goodsid = $(this).attr("data-id"); //当前商品id
										if(number>0){
											var goodsList = [{'id':goodsid,'qty':number}];
											mui.ajax(serverUrl + '/app/materialList/edit/batch', {
												data: {
													userId: userId,
													identityType: identityT,
													goodsList: JSON.stringify(goodsList),
												},
												dataType: 'json',
												headers: {
													"Authorization": oldToken
												},
												type: 'post',
												timeout: 10000,
												success: function(data, type, xhr) {
													plus.nativeUI.closeWaiting();
													console.log('加入购物车', data);
													if(data.code == 0) {
														mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
													} else {
														mui.toast(data.message)
													}

												},
												error: function(xhr, type, errorThrown) {
													plus.nativeUI.closeWaiting();
													console.log('登录响应失败');
												}
											});
										}else{
											mui.confirm('狠心不要了咩？', '提示', ['取消', '确定'], function(e) {
												if(e.index == 1) {
													mui.ajax(serverUrl + '/app/materialList/goods/delete', {
														data: {
															userId: userId,
															identityType: identityT,
															goodsIdArray: goodsid,
														},
														dataType: 'json',
														headers: {
															"Authorization": oldToken
														},
														type: 'post',
														timeout: 10000,
														success: function(data, type, xhr) {
															plus.nativeUI.closeWaiting();
															console.log('删除', data);
															if(data.code == 0) {
																cur.parent().prev().show();
																cur.parent().hide();
																mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
															} else {
																mui.toast(data.message)
															}

														},
														error: function(xhr, type, errorThrown) {
															plus.nativeUI.closeWaiting();
														}
													});
												}else{
													plus.nativeUI.closeWaiting();
													cur.val(1);
													cur.siblings().removeAttr('disabled');
												}

											})
										}

									})

									function addCart(goodid,num,cur){
										mui.ajax(serverUrl+'/app/materialList/add',{
											data:{
												userId:userId,
												identityType:identityT,
												params:goodid+'-'+num
											},
											dataType:'json',
											headers: {"Authorization": oldToken},
											type:'post',
											timeout:10000,
											success:function(data,type,xhr){
												plus.nativeUI.closeWaiting();
												console.log('加入购物车',data);
												if(data.code == 0 ){
													mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
													cur.next().show();
													cur.hide();
												}else{
													mui.toast(data.message)
												}

											},
											error:function(xhr,type,errorThrown){
												plus.nativeUI.closeWaiting();
												console.log('登录响应失败');
											}
										});
									}

								}else{
									$('#classify').html('<div style="text-align:center;padding:15px;font-size: 12px;">暂无活动促销</div>')
								}
					       	}
					       	plus.nativeUI.closeWaiting();
						},
						error:function(xhr,type,errorThrown){
							plus.nativeUI.closeWaiting();
							console.log('当前网络不好,请重试');
						}
					});
				}

				function getCartNum(){
					var cartNum = plus.storage.getItem('cartNums') || 0;
					cartNum = cartNum < 0 ? 0:cartNum;
					if(cartNum>0){
						$('.gocarticon span').show();
						$('.gocarticon span').html(cartNum)
					}else{
						$('.gocarticon span').hide();
					}
				}
				mui('.gocarticon')[0].onclick = function(){
					mui.fire(plus.webview.getWebviewById('cart.html'), 'refresh');
					openview({
						view: "cart.html",
						id:'cart',
						extrasobj: {
							page: "1"
						}
					})


				}
			})
		</script>
		<script type="text/javascript">
			// 获取节点
		  	var block = document.getElementById("div2");
		  	var oW,oH;
		  	// 绑定touchstart事件
		  	block.addEventListener("touchstart", function(e) {
			   	console.log(e);
			   	var touches = e.touches[0];
			   	oW = touches.clientX - block.offsetLeft;
			   	oH = touches.clientY - block.offsetTop;
			   	//阻止页面的滑动默认事件
			   	document.addEventListener("touchmove",defaultEvent,false);
		  	},false)

		  	block.addEventListener("touchmove", function(e) {
			   	var touches = e.touches[0];
			   	var oLeft = touches.clientX - oW;
			   	var oTop = touches.clientY - oH;
			   	if(oLeft < 0) {
			   		oLeft = 0;
			   	}else if(oLeft > document.documentElement.clientWidth - block.offsetWidth) {
			    oLeft = (document.documentElement.clientWidth - block.offsetWidth);
			   	}
			   	block.style.left = oLeft + "px";
			   	block.style.top = oTop + "px";
		  	},false);

			block.addEventListener("touchend",function() {
			   document.removeEventListener("touchmove",defaultEvent,false);
			},false);
			function defaultEvent(e) {
			   e.preventDefault();
			}
		</script>
	</body>

</html>