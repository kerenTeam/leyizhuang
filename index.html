<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title>首页</title>
		<script src="js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/mui.min.js"></script>
		<link href="css/mui.min.css" rel="stylesheet" />
		<style>
			html,
			body {
				background-color: #efeff4;
			}
			
			.title {
				margin: 20px 15px 10px;
				color: #6d6d72;
				font-size: 15px;
			}
		</style>
	</head>

	<body>
		<div class="mui-content">
			<div class="title">
			 
			</div>
		</div>
		
		<script src="js/util.js"></script>
		<script type="text/javascript">
			var aniShow = {};
			mui.init({
				swipeBack: true //启用右滑关闭功能
			});
			mui.plusReady(function() {
				
				plus.storage.removeItem('oldToken');
				Sign();
				var timeSign = null;
				var loadNum = 0;
				var loadNum2 = 0;
				clearInterval(timeSign);
				timeSign = setInterval(Sign,5000000);//两小时自动更新一次token
				var timeSign2  =  setInterval(function(){
					loadNum2++;
					if(plus.storage.getItem('oldToken') || loadNum2==10){
						clearInterval(timeSign2);
					}else{
						Sign();
					}
				},1000)
				function Sign(){//登录方法
					//设置默认token
					if(!plus.storage.getItem('myToken')){//没有用户token
						mui.ajax('http://119.23.149.7:9999/app/employee/login',{
							data:{"name":'XQ-000510',"password":'YWRtaW4='},
							dataType:'json',
							type:'post',
							timeout:10000,
							success:function(data,type,xhr){ 
								console.log('登录返回',data);
								if(data.code == -1){
								 
								}else{  
									plus.nativeUI.closeWaiting();
									console.log('默认账号登录返回'+JSON.stringify(data)); 
									plus.storage.setItem("oldToken",xhr.getResponseHeader('token'));
	//							 alert(plus.storage.getItem("oldToken"))
								}
							},
							error:function(xhr,type,errorThrown){
								plus.nativeUI.closeWaiting();
								console.log('登录响应失败');
								loadNum ++;
								if(loadNum<3){
									mui.toast('当前网络不好,再次连接');
								}
								console.log('获取默认token响应失败');
							}
						}); 
					}else{
						var Acc_pass = JSON.parse(plus.storage.getItem("Acc_pass"));
						//根据缓存密码自动登录, 重新获取Token
						mui.ajax(serverUrl+'/api/useraccount/login',{
							data:{"phone":Acc_pass[0],"password":Acc_pass[1]},
							dataType:'json',
							type:'post',
							timeout:5000,
							success:function(data,type,xhr){
								console.log('自动登录返回'+JSON.stringify(data)); 
								plus.storage.setItem("oldToken",xhr.getResponseHeader('token'));
								//app升级方法
								if(/android/i.test(navigator.userAgent)){
									checkUpdate(true); 
								}else{
									checkUpdateIos();
								}
							},
							error:function(xhr,type,errorThrown){
								loadNum ++;
								if(loadNum<3){
									mui.toast('当前网络不好,再次连接');
								}
								console.log('获取默认token响应失败');
							}
						});
						
						mui.ajax('http://119.23.149.7:9999/app/employee/login',{
							data:{"name":Acc_pass[0],"password":Acc_pass[1]},
							dataType:'json',
							type:'post',
							timeout:10000,
							success:function(data,type,xhr){ 
								console.log('登录返回',data);
								if(data.code == -1){
									plus.nativeUI.closeWaiting();
									mui.toast(data.message)
								}else{ 
									console.log('自动登录返回'+JSON.stringify(data)); 
									plus.storage.setItem("oldToken",xhr.getResponseHeader('token'));
									plus.nativeUI.closeWaiting();
								 
								}
							},
							error:function(xhr,type,errorThrown){
								plus.nativeUI.closeWaiting();
								console.log('登录响应失败');
							}
						});
					}
				}//登录方法结束
				
				
				
				
				
				var self = plus.webview.currentWebview(),
					nviews = self.getSubNViews(),
					subpages = util.options.subpages,
					leftPos = Math.ceil((window.innerWidth - 60) / 2); // 设置凸起大图标为水平居中

				/**	
				 * drawNativeIconBg 绘制带边框的半圆，
				 * 实现原理：
				 *   id为bg的tag 创建带边框的圆
				 *   id为bg2的tag 创建白色矩形遮住圆下半部分，只显示凸起带边框部分
				 *   注意创建先后顺序，创建越晚的层级越高
				 */
				var drawNativeIconBg = util.drawNative('iconBg', {
					bottom: '5px',
					left: leftPos + 'px',
					width: '60px',
					height: '60px',
					position: 'dock'
				}, [{
					tag: 'rect',
					id: 'bg',
					position: {
						top: '0px',
						left: '0px',
						width: '100%',
						height: '100%'
					},
					rectStyles: {
						color: '#fff',
						radius: '30px',
						borderColor: '#ccc',
						borderWidth: '1px'
					}
				}, {
					tag: 'rect',
					id: 'bg2',
					position: {
						bottom: '0px',
						left: '0px',
						width: '100%',
						height: '45px'
					},
					rectStyles: {
						color: '#fff'
					}
				}]);

				/**
				 * 凸起图标最后创建  浮在最顶层
				 *	id为iconBg的红色背景图
				 * 	id为icon的字体图标
				 * 	
				 */
				var drawNativeIcon = util.drawNative('tabIcon', {
					bottom: '10px',
					left: leftPos + 5 + 'px',
					width: '50px',
					height: '50px',
					position: 'dock' //此种停靠方式表明该控件应浮在窗口最上层，以免被其他窗口遮住
				}, [{
					tag: 'rect',
					id: 'iconBg',
					position: {
						top: '0px',
						left: '0px',
						width: '50px',
						height: '100%'
					},
					rectStyles: {
						color: '#d74b28',
						size: '50px',
						radius: '50%'
					}
				}, {
					tag: 'font',
					id: 'icon',
					text: '\ue600', //此为字体图标Unicode码'\e600'转换为'\ue600'
					position: {
						top: '0px',
						left: '0px',
						width: '50px',
						height: '100%'
					},
					textStyles: {
						fontSrc: '_www/fonts/iconfont.ttf',
						align: 'center',
						color: '#fff',
						size: '30px'
					}
				}]);
				// append 到父webview中
				self.append(drawNativeIconBg);
				self.append(drawNativeIcon);

				//自定义监听图标点击事件
				drawNativeIcon.addEventListener('click', function(e) {
					mui.alert('你点击了图标，你在此可以打开摄像头或者新窗口等自定义点击事件。', '悬浮球点击事件');
					// 重绘字体颜色
					drawNativeIcon.drawText('\ue600', {}, {
						fontSrc: '_www/fonts/iconfont.ttf',
						align: 'center',
						color: '#000',
						size: '30px'
					}, 'icon');
				});
				
				//创建子webview窗口 并初始化
				util.initSubpage();
				var activePage = plus.webview.currentWebview();

				//给每个view 添加监听点击切换
				for(var i = 0; i < 4; i++) {
					nviews[i].addEventListener('click', clickEvent, false);
				}

				// 自定义 tab 点击事件
				function clickEvent(e) {
					var currId = e.target.id,
						currIndex = parseInt(currId.substr(currId.length - 1, 1) - 1),
						currView = self.getStyle().subNViews[currIndex];
						
					// 匹配对应tab窗口	
					if(currIndex > 0){
						targetPage = plus.webview.getWebviewById(subpages[currIndex-1]);						
					}else {
						targetPage = plus.webview.currentWebview();
					}

					if(targetPage == activePage) {
						return;
					}

					if(currIndex !== 3) {
						//底部选项卡切换
						util.toggleNview(currView, currIndex);
						// 子页面切换
						util.changeSubpage(targetPage, activePage);
						//更改当前活跃的页面
						activePage = targetPage;
					} else {
						//第四个tab 打开新窗口
						var newWV = plus.webview.create('html/new-webview.html', 'new');
						newWV.show('slide-in-right', 200);
					}
				}
			});
		</script>
	</body>

</html>